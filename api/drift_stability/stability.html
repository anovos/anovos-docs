
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Stable Features yield Resilient Models. Documentation for the Feature Engineering Library Anovos.">
      
      
        <meta name="author" content="Anovos Developers, Mobilewalla">
      
      
        <link rel="canonical" href="https://docs.anovos.ai/api/drift_stability/stability.html">
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>stability - Anovos Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-52258647-20","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");ga("send","event","feedback","click",t,e),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){ga("send","pageview",e.pathname)})});var e=document.createElement("script");e.async=!0,e.src="https://www.google-analytics.com/analytics.js",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
<!-- Extra styles for API docs, cf. https://github.com/pdoc3/pdoc/blob/master/pdoc/templates/html.mako -->
<link rel="preload stylesheet" as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css"
      integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css"
      integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/${hljs_style}.min.css" crossorigin>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"
        integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>

<!-- Extra style sheets (can't be set in mkdocs.yml due to content hash) -->
<link
        rel="stylesheet"
        href="../../assets/stylesheets/main.css"
/>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#stability" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
<a href="https://join.slack.com/t/featureengineers/shared_invite/zt-17pkc3f5d-33SUtV8Wx48CpiIRNuQ7JA" style="color: white;">
      <span class="twemoji fa-slack">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </span>
    Join us in the <strong>#anovos</strong> channel on the <em>Feature Engineers Community Slack!</em>
</a>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="Anovos Documentation" class="md-header__button md-logo" aria-label="Anovos Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Anovos Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              <code>stability</code>
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a
  href="https://github.com/anovos/anovos"
  title="Go to repository"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    anovos/anovos
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="Anovos Documentation" class="md-nav__button md-logo" aria-label="Anovos Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Anovos Documentation
  </label>
  
    <div class="md-nav__source">
      <a
  href="https://github.com/anovos/anovos"
  title="Go to repository"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    anovos/anovos
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about.html" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started.html" class="md-nav__link">
        Getting Started ðŸš€
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Using Anovos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Using Anovos" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Using Anovos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setting up
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setting up" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setting up
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/locally.html" class="md-nav__link">
        Locally
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_aws.html" class="md-nav__link">
        On AWS EMR
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_azure_databricks.html" class="md-nav__link">
        On Azure Databricks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_aks.html" class="md-nav__link">
        On Azure Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_google_colab.html" class="md-nav__link">
        On Google Colab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/spark_cluster.html" class="md-nav__link">
        On a Spark cluster
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/workflow.html" class="md-nav__link">
        Workflow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/config_file.html" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Data Reports
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Data Reports" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Data Reports
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/overview.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/intermediate_report.html" class="md-nav__link">
        Intermediate Report
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/final_report.html" class="md-nav__link">
        Final Report
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/html_report.html" class="md-nav__link">
        HTML Report
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/feature_mapper.html" class="md-nav__link">
        Feature Mapper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/mlflow.html" class="md-nav__link">
        MLflow Integration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/feature_store.html" class="md-nav__link">
        Feature Store Integration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/scaling.html" class="md-nav__link">
        Scaling Up
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/limitations.html" class="md-nav__link">
        Limitations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/roadmap.html" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Community
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Community" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Community
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../community/contributing.html" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../community/communication.html" class="md-nav__link">
        Communication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../community/code-of-conduct.html" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          API Docs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Docs" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          API Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../workflow.html" class="md-nav__link">
        <code>workflow</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_3">
          data_analyzer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_analyzer" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          data_analyzer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_analyzer/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_analyzer/association_eval_varclus.html" class="md-nav__link">
        <code>association_eval_varclus</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_analyzer/association_evaluator.html" class="md-nav__link">
        <code>association_evaluator</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_analyzer/geospatial_analyzer.html" class="md-nav__link">
        <code>geospatial_analyzer</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_analyzer/quality_checker.html" class="md-nav__link">
        <code>quality_checker</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_analyzer/stats_generator.html" class="md-nav__link">
        <code>stats_generator</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_analyzer/ts_analyzer.html" class="md-nav__link">
        <code>ts_analyzer</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_4">
          data_ingest
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_ingest" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          data_ingest
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/data_ingest.html" class="md-nav__link">
        <code>data_ingest</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/data_sampling.html" class="md-nav__link">
        <code>data_sampling</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/geo_auto_detection.html" class="md-nav__link">
        <code>geo_auto_detection</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/ts_auto_detection.html" class="md-nav__link">
        <code>ts_auto_detection</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_5">
          data_report
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_report" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          data_report
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/basic_report_generation.html" class="md-nav__link">
        <code>basic_report_generation</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/report_generation.html" class="md-nav__link">
        <code>report_generation</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/report_preprocessing.html" class="md-nav__link">
        <code>report_preprocessing</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_6" type="checkbox" id="__nav_6_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_6">
          data_transformer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_transformer" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_6">
          <span class="md-nav__icon md-icon"></span>
          data_transformer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/datetime.html" class="md-nav__link">
        <code>datetime</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/geo_utils.html" class="md-nav__link">
        <code>geo_utils</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/geospatial.html" class="md-nav__link">
        <code>geospatial</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/transformers.html" class="md-nav__link">
        <code>transformers</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_7" type="checkbox" id="__nav_6_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6_7">
          drift_stability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="drift_stability" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_7">
          <span class="md-nav__icon md-icon"></span>
          drift_stability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="drift_detector.html" class="md-nav__link">
        <code>drift_detector</code>
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          <code>stability</code>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="stability.html" class="md-nav__link md-nav__link--active">
        <code>stability</code>
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="validations.html" class="md-nav__link">
        <code>validations</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_8" type="checkbox" id="__nav_6_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_8">
          feature_recommender
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="feature_recommender" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_8">
          <span class="md-nav__icon md-icon"></span>
          feature_recommender
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/featrec_init.html" class="md-nav__link">
        <code>featrec_init</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/feature_explorer.html" class="md-nav__link">
        <code>feature_explorer</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/feature_mapper.html" class="md-nav__link">
        <code>feature_mapper</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_9" type="checkbox" id="__nav_6_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_9">
          feature_store
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="feature_store" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_9">
          <span class="md-nav__icon md-icon"></span>
          feature_store
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_store/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_store/feast_exporter.html" class="md-nav__link">
        <code>feast_exporter</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_store/feature_retrieval.html" class="md-nav__link">
        <code>feature_retrieval</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_10" type="checkbox" id="__nav_6_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_10">
          shared
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="shared" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_10">
          <span class="md-nav__icon md-icon"></span>
          shared
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shared/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shared/spark.html" class="md-nav__link">
        <code>spark</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shared/utils.html" class="md-nav__link">
        <code>utils</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../license.html" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/anovos/anovos-docs/edit/main/docs/api/drift_stability/stability.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="stability"><code>stability</code></h1>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span> <span class="nn">pyspark</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">types</span> <span class="k">as</span> <span class="n">T</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">variation</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">from</span> <span class="nn">anovos.data_transformer.transformers</span> <span class="kn">import</span> <span class="n">attribute_binning</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="kn">from</span> <span class="nn">anovos.shared.utils</span> <span class="kn">import</span> <span class="n">attributeType_segregation</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kn">from</span> <span class="nn">.validations</span> <span class="kn">import</span> <span class="n">compute_si</span><span class="p">,</span> <span class="n">check_metric_weightages</span><span class="p">,</span> <span class="n">check_threshold</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="k">def</span> <span class="nf">stability_index_computation</span><span class="p">(</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="n">spark</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">idfs</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">list_of_cols</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">drop_cols</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">metric_weightages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;stddev&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;kurtosis&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="n">binary_cols</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="n">existing_metric_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">appended_metric_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="n">persist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>    <span class="n">persist_option</span><span class="o">=</span><span class="n">pyspark</span><span class="o">.</span><span class="n">StorageLevel</span><span class="o">.</span><span class="n">MEMORY_AND_DISK</span><span class="p">,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="n">print_impact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="p">):</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">    The data stability is represented by a single metric to summarise the stability of an attribute over multiple</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">    time periods. For example, given 6 datasets collected in 6 consecutive time periods (D1, D2, â€¦, D6),</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="sd">    data stability index of an attribute measures how stable the attribute is from D1 to D6.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="sd">    The major difference between data drift and data stability is that data drift analysis is only based on 2</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">    datasets: source and target. However data stability analysis can be performed on multiple datasets. In addition,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">    the source dataset is not required indicating that the stability index can be directly computed among multiple</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">    target datasets by comparing the statistical properties among them.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">    In summary, given N datasets representing different time periods, we would like to measure the stability of some</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">    numerical attributes from the first to the N-th dataset.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">    The whole process can be broken down into 2 steps: (1) Choose a few statistical metrics to describe the</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">    distribution of each attribute at each time period. (2) Compute attribute level stability by combining the</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">    stability of each statistical metric over time periods.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="sd">    In the first step, we choose mean, standard deviation and kurtosis as the statistical metrics in our</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="sd">    implementation. Intuitively, they represent different aspects of a distribution: mean measures central tendency,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="sd">    standard deviation measures dispersion and kurtosis measures shape of a distribution. Reasons of selecting those</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="sd">    3 metrics will be explained in a later section. With mean, standard deviation and kurtosis computed for each</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="sd">    attribute at each time interval, we can form 3 arrays of size N for each attribute.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">    In the second step, Coefficient of Variation (CV) is used to measure the stability of each metric. CV represents</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">    the ratio of the standard deviation to the mean, which is a unitless statistic to compare the relative variation</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">    from one array to another. Considering the wide potential range of CV, the absolute value of CV is then mapped to</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">    an integer between 0 and 4 according to the table below, where 0 indicates highly unstable and 4 indicates highly</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">    stable. We call this integer a metric stability index.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">    | abs(CV) Interval | Metric Stability Index |</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="sd">    |------------------|------------------------|</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="sd">    | [0, 0.03)        | 4                      |</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="sd">    | [0.03, 0.1)      | 3                      |</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="sd">    | [0.1, 0.2)       | 2                      |</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a><span class="sd">    | [0.2, 0.5)       | 1                      |</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a><span class="sd">    | [0.5, +inf)      | 0                      |</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a><span class="sd">    Finally, the attribute stability index (SI) is a weighted sum of 3 metric stability indexes, where we assign 50%</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a><span class="sd">    for mean, 30% for standard deviation and 20% for kurtosis by default. The final output is a float between 0 and 4 and an</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a><span class="sd">    attribute can be classified as one of the following categories: very unstable (0â‰¤SI&lt;1), unstable (1â‰¤SI&lt;2),</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a><span class="sd">    marginally stable (2â‰¤SI&lt;3), stable (3â‰¤SI&lt;3.5) and very stable (3.5â‰¤SIâ‰¤4).</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a><span class="sd">    For example, there are 6 samples of attribute X from T1 to T6. For each sample, we have computed the statistical</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a><span class="sd">    metrics of X from T1 to T6:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="sd">    | idx | Mean | Standard deviation | Kurtosis |</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="sd">    |-----|------|--------------------|----------|</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="sd">    | 1   | 11   | 2                  | 3.9      |</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="sd">    | 2   | 12   | 1                  | 4.2      |</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="sd">    | 3   | 15   | 3                  | 4.0      |</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a><span class="sd">    | 4   | 10   | 2                  | 4.1      |</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a><span class="sd">    | 5   | 11   | 1                  | 4.2      |</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a><span class="sd">    | 6   | 13   | 0.5                | 4.0      |</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a><span class="sd">    Then we calculate the Coefficient of Variation for each array:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a><span class="sd">    - CV of mean = CV([11, 12, 15, 10, 11, 13]) = 0.136</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a><span class="sd">    - CV of standard deviation = CV([2, 1, 3, 2, 1, 0.5]) = 0.529</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a><span class="sd">    - CV of kurtosis = CV([3.9, 4.2, 4.0, 4.1, 4.2, 4.0]) = 0.027</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a><span class="sd">    Metric stability indexes are then computed by mapping each CV value to an integer accordingly. As a result,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a><span class="sd">    metric stability index is 2 for mean, 0 for standard deviation and 4 for kurtosis.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">    Why mean is chosen over median?</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="sd">    - Dummy variables which take only the value 0 or 1 are frequently seen in machine learning features. Mean of a</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a><span class="sd">    dummy variable represents the proportion of value 1 and median of a dummy variable is either 0 or 1 whichever is</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a><span class="sd">    more frequent. However, CV may not work well when 0 appears in the array or the array contains both positive and</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="sd">    negative values. For example, intuitively [0,0,0,0,0,1,0,0,0] is a stable array but its CV is 2.83 which is</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a><span class="sd">    extremely high, but cv of [0.45,0.44,0.48,0.49,0.42,0.52,0.49,0.47,0.48] is 0.06 which is much more reasonable.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a><span class="sd">    Thus we decided to use mean instead of median. Although median is considered as a more robust choice,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a><span class="sd">    outlier treatment can be applied prior to data stability analysis to handle this issue.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a><span class="sd">    Why kurtosis is chosen over skewness?</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a><span class="sd">    - Kurtosis is a positive value (note that we use kurtosis instead of excess kurtosis which) but skewness can</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a><span class="sd">    range from â€“inf to +inf. Usually, if skewness is between -0.5 and 0.5, the distribution is approximately</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a><span class="sd">    symmetric. Thus, if the skewness fluctuates around 0, the CV is highly likely to be high or invalid because the</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a><span class="sd">    mean will be close to 0.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a><span class="sd">    Stability index is preferred in the following scenario:</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a><span class="sd">    - Pairwise drift analysis can be performed between the source dataset and each of the target dataset to quantify</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a><span class="sd">    the drift over time. However this can be time-consuming especially when the number of target dataset is large. In</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a><span class="sd">    this case, measuring data stability instead of data drift would be a much faster alternative and the</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a><span class="sd">    source/baseline dataset is not required as well</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a><span class="sd">    Troubleshooting</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a><span class="sd">    - If the attribute stability index appears to be nan, it may due to one of the following reasons: - One metric (</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a><span class="sd">    likely to be kurtosis) is nan. For example, the kurtosis of a sample is nan If its standard deviation is 0. - The</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a><span class="sd">    mean of a metric from the first to the N-th dataset is zero, causing the denominator of CV to be 0. For example,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a><span class="sd">    when mean of attribute X is always zero for all datasets, its stability index would be nan.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a><span class="sd">    Limitation</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a><span class="sd">    - Limitation of CV: CV may not work well when 0 appears in the array or the array contains both positive and</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a><span class="sd">    negative values.</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a><span class="sd">    spark</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a><span class="sd">        Spark Session</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a><span class="sd">    idfs</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a><span class="sd">        Variable number of input dataframes</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a><span class="sd">    list_of_cols</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a><span class="sd">        List of numerical columns to check stability e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a><span class="sd">        Alternatively, columns can be specified in a string format,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a><span class="sd">        where different column names are separated by pipe delimiter â€œ|â€ e.g., &quot;col1|col2&quot;.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a><span class="sd">        &quot;all&quot; can be passed to include all numerical columns for analysis.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a><span class="sd">        Please note that this argument is used in conjunction with drop_cols i.e. a column mentioned in</span>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a><span class="sd">        drop_cols argument is not considered for analysis even if it is mentioned in list_of_cols. (Default value = &quot;all&quot;)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a><span class="sd">    drop_cols</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a><span class="sd">        List of columns to be dropped e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a><span class="sd">        Alternatively, columns can be specified in a string format,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a><span class="sd">        where different column names are separated by pipe delimiter â€œ|â€ e.g., &quot;col1|col2&quot;. (Default value = [])</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a><span class="sd">    metric_weightages</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a><span class="sd">        Takes input in dictionary format with keys being the metric name - &quot;mean&quot;,&quot;stdev&quot;,&quot;kurtosis&quot;</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a><span class="sd">        and value being the weightage of the metric (between 0 and 1). Sum of all weightages must be 1.</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a><span class="sd">        (Default value = {&quot;mean&quot;: 0.5, &quot;stddev&quot;: 0.3, &quot;kurtosis&quot;: 0.2})</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a><span class="sd">    binary_cols</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a><span class="sd">        List of numerical columns to be treated as binary columns e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a><span class="sd">        Alternatively, columns can be specified in a string format, where different column names are</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a><span class="sd">        separated by pipe delimiter â€œ|â€. For the specified binary columns,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a><span class="sd">        only the mean value will be used as the statistical metric (standard deviation and kurtosis will be skipped).</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a><span class="sd">        In addition, standard deviation will be used to measure the stability of mean instead of CV.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a><span class="sd">        (Default value = [])</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a><span class="sd">    existing_metric_path</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a><span class="sd">        This argument is path for referring pre-existing metrics of historical datasets and is</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a><span class="sd">        of schema [idx, attribute, mean, stdev, kurtosis].</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a><span class="sd">        idx is index number of historical datasets assigned in chronological order. (Default value = &quot;&quot;)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a><span class="sd">    appended_metric_path</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a><span class="sd">        This argument is path for saving input dataframes metrics after appending to the</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a><span class="sd">        historical datasets&#39; metrics. (Default value = &quot;&quot;)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a><span class="sd">    persist</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a><span class="sd">        Boolean argument - True or False. This argument is used to determine whether to persist on</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a><span class="sd">        binning result of source and target dataset, True will enable the use of persist, otherwise False.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a><span class="sd">        It is recommended to set this as True for large datasets. (Default value = True)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a><span class="sd">    persist_option</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a><span class="sd">        If persist is True, this argument is used to determine the type of persist.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a><span class="sd">        (Default value = pyspark.StorageLevel.MEMORY_AND_DISK)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a><span class="sd">    threshold</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a><span class="sd">        A column is flagged if the stability index is below the threshold, which varies between 0 to 4.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a><span class="sd">        The following criteria can be used to classifiy stability_index (SI): very unstable: 0â‰¤SI&lt;1,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a><span class="sd">        unstable: 1â‰¤SI&lt;2, marginally stable: 2â‰¤SI&lt;3, stable: 3â‰¤SI&lt;3.5 and very stable: 3.5â‰¤SIâ‰¤4. (Default value = 1)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a><span class="sd">    print_impact</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a><span class="sd">        True, False (Default value = False)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a><span class="sd">        This argument is to print out the stability metrics of all attributes and potential unstable attributes.</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a><span class="sd">    -------</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a><span class="sd">    DataFrame</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a><span class="sd">        [attribute, mean_stddev, mean_si, stddev_si, kurtosis_si, mean_cv, stddev_cv, kurtosis_cv, stability_index].</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="sd">        *_cv is coefficient of variation for each metric. *_si is stability index for each metric.</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a><span class="sd">        stability_index is net weighted stability index based on the individual metrics&#39; stability index.</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">attributeType_segregation</span><span class="p">(</span><span class="n">idfs</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a>    <span class="k">if</span> <span class="n">list_of_cols</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a>        <span class="n">list_of_cols</span> <span class="o">=</span> <span class="n">num_cols</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>        <span class="n">list_of_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a>        <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">drop_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a>        <span class="n">binary_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">binary_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a>    <span class="n">list_of_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">list_of_cols</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_cols</span><span class="p">]))</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">num_cols</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_cols</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input for Column(s)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_of_cols</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">binary_cols</span><span class="p">):</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input for Binary Column(s)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>    <span class="n">check_metric_weightages</span><span class="p">(</span><span class="n">metric_weightages</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>    <span class="n">check_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>    <span class="k">if</span> <span class="n">existing_metric_path</span><span class="p">:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>        <span class="n">existing_metric_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>            <span class="n">existing_metric_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>        <span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>        <span class="n">dfs_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">existing_metric_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>        <span class="n">existing_metric_df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>        <span class="n">dfs_count</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>    <span class="k">def</span> <span class="nf">unionAll</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>        <span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">dfs</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>        <span class="k">return</span> <span class="n">first</span><span class="o">.</span><span class="n">sql_ctx</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>            <span class="n">first</span><span class="o">.</span><span class="n">sql_ctx</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">rdd</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]),</span> <span class="n">first</span><span class="o">.</span><span class="n">schema</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>        <span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>    <span class="k">if</span> <span class="n">persist</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idfs</span><span class="p">)):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>            <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>            <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">persist_option</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>    <span class="n">list_temp_all_col</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>    <span class="k">if</span> <span class="n">appended_metric_path</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>        <span class="n">list_append_all</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_of_cols</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a>        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">binary_cols</span><span class="p">:</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a>            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;Binary&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a>            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;Numerical&quot;</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a>        <span class="n">count_idf</span> <span class="o">=</span> <span class="n">dfs_count</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a>        <span class="n">list_temp_col_in_idf</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a>        <span class="k">for</span> <span class="n">idf</span> <span class="ow">in</span> <span class="n">idfs</span><span class="p">:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a>            <span class="n">df_stat_each</span> <span class="o">=</span> <span class="n">idf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">),</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">),</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a>            <span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a>            <span class="n">list_temp_col_in_idf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stat_each</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>            <span class="k">if</span> <span class="n">appended_metric_path</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a>                <span class="n">df_append_single</span> <span class="o">=</span> <span class="n">df_stat_each</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count_idf</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">),</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">),</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">col_type</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a>                    <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a>                    <span class="s2">&quot;stddev&quot;</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a>                    <span class="s2">&quot;kurtosis&quot;</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a>                <span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>                <span class="n">list_append_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_append_single</span><span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a>                <span class="n">count_idf</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a>        <span class="k">if</span> <span class="n">existing_metric_df</span><span class="p">:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a>            <span class="n">existing_df_for_single_col</span> <span class="o">=</span> <span class="n">existing_metric_df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>            <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;stddev&quot;</span><span class="p">,</span> <span class="s2">&quot;kurtosis&quot;</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>            <span class="k">if</span> <span class="n">existing_df_for_single_col</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>                <span class="n">list_temp_col_in_idf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">existing_df_for_single_col</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>        <span class="n">df_stat_col</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>            <span class="n">unionAll</span><span class="p">(</span><span class="n">list_temp_col_in_idf</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;std_of_mean&quot;</span><span class="p">),</span>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_of_mean&quot;</span><span class="p">),</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;std_of_stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_of_stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;std_of_kurtosis&quot;</span><span class="p">),</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_of_kurtosis&quot;</span><span class="p">),</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a>            <span class="p">)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a>                <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">),</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a>                <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">col_type</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_mean&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_of_mean&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">),</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_stddev&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_of_stddev&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">),</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_kurtosis&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_of_kurtosis&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a>                    <span class="s2">&quot;kurtosis_cv&quot;</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a>                <span class="p">),</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a>            <span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a>        <span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a>        <span class="n">list_temp_all_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stat_col</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="n">unionAll</span><span class="p">(</span><span class="n">list_temp_all_col</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>    <span class="k">if</span> <span class="n">appended_metric_path</span><span class="p">:</span>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a>        <span class="k">if</span> <span class="n">existing_metric_df</span><span class="p">:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>            <span class="n">list_append_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">existing_metric_df</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>        <span class="n">df_append</span> <span class="o">=</span> <span class="n">unionAll</span><span class="p">(</span><span class="n">list_append_all</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>        <span class="n">df_append</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>            <span class="n">appended_metric_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>        <span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>    <span class="n">f_compute_si</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">udf</span><span class="p">(</span><span class="n">compute_si</span><span class="p">(</span><span class="n">metric_weightages</span><span class="p">),</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()))</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>            <span class="s2">&quot;si_array&quot;</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>            <span class="n">f_compute_si</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_stddev&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_cv&quot;</span><span class="p">,</span> <span class="s2">&quot;stddev_cv&quot;</span><span class="p">,</span> <span class="s2">&quot;kurtosis_cv&quot;</span><span class="p">),</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>        <span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_si&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stddev_si&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;kurtosis_si&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stability_index&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>            <span class="s2">&quot;flagged&quot;</span><span class="p">,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>            <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>                <span class="o">|</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()),</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>                <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>        <span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_stddev&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_stddev&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;kurtosis_cv&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kurtosis_cv&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a>    <span class="p">)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>    <span class="k">if</span> <span class="n">print_impact</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Attributes:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">))</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Potential Unstable Attributes:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>        <span class="n">unstable</span> <span class="o">=</span> <span class="n">odf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;flagged&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>        <span class="n">unstable</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">unstable</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>    <span class="k">if</span> <span class="n">persist</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idfs</span><span class="p">)):</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>            <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>    <span class="k">return</span> <span class="n">odf</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a><span class="k">def</span> <span class="nf">feature_stability_estimation</span><span class="p">(</span>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>    <span class="n">spark</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>    <span class="n">attribute_stats</span><span class="p">,</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>    <span class="n">attribute_transformation</span><span class="p">,</span>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>    <span class="n">metric_weightages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;stddev&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;kurtosis&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>    <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>    <span class="n">print_impact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a><span class="p">):</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a><span class="sd">    This function is able to estimate the stability index of a new feature composed of certain attributes whose</span>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a><span class="sd">    stability metrics are known. For example, the new feature F can be expressed as F = g(X1, X2, â€¦, Xn),</span>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a><span class="sd">    where X1, X2, â€¦, Xn represent different attributes and g represents the transformation function.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a><span class="sd">    The most straightforward way is to generate the new feature for all periods and calculate its stability index.</span>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a><span class="sd">    However, it requires reading all historical data again which can be unrealistic for large datasets.</span>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a><span class="sd">    Thus, the objective of this function is to estimate feature stability index without reading historical data.</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a><span class="sd">    One example can be the following scenario: we have attributes A and B, we have their respective stability</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a><span class="sd">    statistics from T1 to T7. At T7 we realise we need to generate a new feature: A/B, but we donâ€™t have</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a><span class="sd">    statistics metrics of A/B from T1 to T6 and this is where this function can be applied to generate an</span>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a><span class="sd">    estimation without reading datasets from T1 to T6.</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a><span class="sd">    The estimation can be broken down into 3 steps.</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a><span class="sd">    1. Estimate mean and stddev for the new feature based on attribute metrics (no existing resource found to</span>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a><span class="sd">    estimate Feature kurtosis). Estimated mean and stddev are generated for each time period using the</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a><span class="sd">    formula below according to [1]:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a><span class="sd">    ![https://raw.githubusercontent.com/anovos/anovos-docs/main/docs/assets/feature_stability_formulae.png](https://raw.githubusercontent.com/anovos/anovos-docs/main/docs/assets/feature_stability_formulae.png)</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a><span class="sd">    2. Calculate Coefficient of variation (CV) for estimated feature mean and stddev. Each CV can be then mapped</span>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a><span class="sd">    to an integer between 0 and 4 to generate the metric stability index.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a><span class="sd">    3. Similar to the attribute stability index, each metric is assigned a weightage between 0 and 1, where the</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a><span class="sd">    default values are 50 for mean, 30% for standard deviation and 20% for kurtosis. Because we are unable to</span>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a><span class="sd">    generate kurtosis stability index, its minimum and maximum possible values (0 and 4) are used to output a</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a><span class="sd">    range for global stability index (GSI):</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a><span class="sd">        * Lower bound of GSI = 0.5âˆ—mean stability index + 0.3âˆ—stddev stability index + 0.2 âˆ— ðŸŽ</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a><span class="sd">        * Upper bound of GSI = 0.5âˆ—mean stability index + 0.3âˆ—stddev stability index + 0.2 âˆ— ðŸ’</span>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a><span class="sd">    [1] Benaroya, H., Han, S. M., &amp; Nagurka, M. (2005). Probability models in engineering and science (Vol. 192, pp. 168-169). CRC press.</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a><span class="sd">    spark</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a><span class="sd">        Spark Session</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a><span class="sd">    attribute_stats</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a><span class="sd">        Spark dataframe. The intermediate dataframe saved by running function</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a><span class="sd">        stabilityIndex_computation with schema [idx, attribute, mean, stddev, kurtosis].</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a><span class="sd">        It should contain all the attributes used in argument attribute_transformation.</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a><span class="sd">    attribute_transformation</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a><span class="sd">        Takes input in dictionary format: each key-value combination represents one</span>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a><span class="sd">        new feature. Each key is a string containing all the attributes involved in</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a><span class="sd">        the new feature seperated by &#39;|&#39;. Each value is the transformation of the</span>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a><span class="sd">        attributes in string. For example, {&#39;X|Y|Z&#39;: &#39;X**2+Y/Z&#39;, &#39;A&#39;: &#39;log(A)&#39;}</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a><span class="sd">    metric_weightages</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a><span class="sd">        Takes input in dictionary format with keys being the metric name - &quot;mean&quot;,&quot;stdev&quot;,&quot;kurtosis&quot;</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a><span class="sd">        and value being the weightage of the metric (between 0 and 1). Sum of all weightages must be 1.</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a><span class="sd">        (Default value = {&quot;mean&quot;: 0.5, &quot;stddev&quot;: 0.3, &quot;kurtosis&quot;: 0.2})</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a><span class="sd">    threshold</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a><span class="sd">        A column is flagged if the stability index is below the threshold, which varies between 0 and 4.</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a><span class="sd">        The following criteria can be used to classify stability_index (SI): very unstable: 0â‰¤SI&lt;1,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a><span class="sd">        unstable: 1â‰¤SI&lt;2, marginally stable: 2â‰¤SI&lt;3, stable: 3â‰¤SI&lt;3.5 and very stable: 3.5â‰¤SIâ‰¤4. (Default value = 1)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a><span class="sd">    print_impact</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a><span class="sd">        True, False (Default value = False)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a><span class="sd">        This argument is to print out the stability metrics of all newly generated features and potential unstable features.</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a><span class="sd">    -------</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a><span class="sd">    DataFrame</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a><span class="sd">        [feature_formula, mean_cv, stddev_cv, mean_si, stddev_si, stability_index_lower_bound,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a><span class="sd">        stability_index_upper_bound, flagged_lower, flagged_upper].</span>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a><span class="sd">        *_cv is coefficient of variation for each metric. *_si is stability index for each metric.</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a><span class="sd">        stability_index_lower_bound and stability_index_upper_bound form a range for estimated stability index.</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a><span class="sd">        flagged_lower and flagged_upper indicate whether the feature is potentially unstable based on the lower</span>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a><span class="sd">        and upper bounds for stability index.</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>    <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>        <span class="nb">round</span><span class="p">(</span>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>            <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a>            <span class="o">+</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a>            <span class="o">+</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a>            <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a>        <span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a>        <span class="o">!=</span> <span class="mi">1</span>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a>    <span class="p">):</span>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a>            <span class="s2">&quot;Invalid input for metric weightages. Either metric name is incorrect or sum of metric weightages is not 1.0.&quot;</span>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a>        <span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a>    <span class="k">def</span> <span class="nf">stats_estimation</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddev</span><span class="p">):</span>
<a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a>        <span class="n">attribute_means</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">mean</span><span class="p">))</span>
<a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a>        <span class="n">first_dev</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>        <span class="n">second_dev</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a>        <span class="n">est_mean</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a>        <span class="n">est_var</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a>        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">stddev</span><span class="p">):</span>
<a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a>            <span class="n">first_dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a>            <span class="n">second_dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a>            <span class="n">est_mean</span> <span class="o">+=</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">second_dev</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">attribute_means</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a>            <span class="n">est_var</span> <span class="o">+=</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">first_dev</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">attribute_means</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a>        <span class="n">transformation</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">parse_expr</span><span class="p">(</span><span class="n">transformation</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a>        <span class="n">est_mean</span> <span class="o">+=</span> <span class="n">transformation</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">attribute_means</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437" href="#__codelineno-0-437"></a>        <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">est_mean</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">est_var</span><span class="p">)]</span>
<a id="__codelineno-0-438" name="__codelineno-0-438" href="#__codelineno-0-438"></a>
<a id="__codelineno-0-439" name="__codelineno-0-439" href="#__codelineno-0-439"></a>    <span class="n">f_stats_estimation</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">udf</span><span class="p">(</span><span class="n">stats_estimation</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()))</span>
<a id="__codelineno-0-440" name="__codelineno-0-440" href="#__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441" href="#__codelineno-0-441"></a>    <span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-442" name="__codelineno-0-442" href="#__codelineno-0-442"></a>        <span class="n">attribute_stats</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443" href="#__codelineno-0-443"></a>        <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<a id="__codelineno-0-444" name="__codelineno-0-444" href="#__codelineno-0-444"></a>        <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445" href="#__codelineno-0-445"></a>        <span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446" href="#__codelineno-0-446"></a>        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-447" name="__codelineno-0-447" href="#__codelineno-0-447"></a>    <span class="p">)</span>
<a id="__codelineno-0-448" name="__codelineno-0-448" href="#__codelineno-0-448"></a>    <span class="n">attribute_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribute_transformation</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-449" name="__codelineno-0-449" href="#__codelineno-0-449"></a>    <span class="n">transformations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribute_transformation</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-450" name="__codelineno-0-450" href="#__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451" href="#__codelineno-0-451"></a>    <span class="n">feature_metric</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-452" name="__codelineno-0-452" href="#__codelineno-0-452"></a>    <span class="k">for</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">transformation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">attribute_names</span><span class="p">,</span> <span class="n">transformations</span><span class="p">):</span>
<a id="__codelineno-0-453" name="__codelineno-0-453" href="#__codelineno-0-453"></a>        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-0-454" name="__codelineno-0-454" href="#__codelineno-0-454"></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
<a id="__codelineno-0-455" name="__codelineno-0-455" href="#__codelineno-0-455"></a>            <span class="n">attr_mean_list</span><span class="p">,</span> <span class="n">attr_stddev_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-456" name="__codelineno-0-456" href="#__codelineno-0-456"></a>            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457" href="#__codelineno-0-457"></a>                <span class="n">df_temp</span> <span class="o">=</span> <span class="n">attribute_stats</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-0-458" name="__codelineno-0-458" href="#__codelineno-0-458"></a>                    <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459" href="#__codelineno-0-459"></a>                <span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460" href="#__codelineno-0-460"></a>                <span class="k">if</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461" href="#__codelineno-0-461"></a>                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<a id="__codelineno-0-462" name="__codelineno-0-462" href="#__codelineno-0-462"></a>                        <span class="s2">&quot;Invalid input for attribute_stats: all involved attributes must have available statistics across all time periods (idx)&quot;</span>
<a id="__codelineno-0-463" name="__codelineno-0-463" href="#__codelineno-0-463"></a>                    <span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464" href="#__codelineno-0-464"></a>                <span class="n">attr_mean_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-465" name="__codelineno-0-465" href="#__codelineno-0-465"></a>                    <span class="n">df_temp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-466" name="__codelineno-0-466" href="#__codelineno-0-466"></a>                <span class="p">)</span>
<a id="__codelineno-0-467" name="__codelineno-0-467" href="#__codelineno-0-467"></a>                <span class="n">attr_stddev_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-468" name="__codelineno-0-468" href="#__codelineno-0-468"></a>                    <span class="n">df_temp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-469" name="__codelineno-0-469" href="#__codelineno-0-469"></a>                <span class="p">)</span>
<a id="__codelineno-0-470" name="__codelineno-0-470" href="#__codelineno-0-470"></a>            <span class="n">feature_metric</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-471" name="__codelineno-0-471" href="#__codelineno-0-471"></a>                <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">attr_mean_list</span><span class="p">,</span> <span class="n">attr_stddev_list</span><span class="p">]</span>
<a id="__codelineno-0-472" name="__codelineno-0-472" href="#__codelineno-0-472"></a>            <span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473" href="#__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474" href="#__codelineno-0-474"></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">StructType</span><span class="p">(</span>
<a id="__codelineno-0-475" name="__codelineno-0-475" href="#__codelineno-0-475"></a>        <span class="p">[</span>
<a id="__codelineno-0-476" name="__codelineno-0-476" href="#__codelineno-0-476"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-477" name="__codelineno-0-477" href="#__codelineno-0-477"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;transformation&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-478" name="__codelineno-0-478" href="#__codelineno-0-478"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">StringType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-479" name="__codelineno-0-479" href="#__codelineno-0-479"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;attr_mean_list&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-480" name="__codelineno-0-480" href="#__codelineno-0-480"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;attr_stddev_list&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-481" name="__codelineno-0-481" href="#__codelineno-0-481"></a>        <span class="p">]</span>
<a id="__codelineno-0-482" name="__codelineno-0-482" href="#__codelineno-0-482"></a>    <span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483" href="#__codelineno-0-483"></a>
<a id="__codelineno-0-484" name="__codelineno-0-484" href="#__codelineno-0-484"></a>    <span class="n">df_feature_metric</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-485" name="__codelineno-0-485" href="#__codelineno-0-485"></a>        <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">feature_metric</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486" href="#__codelineno-0-486"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-487" name="__codelineno-0-487" href="#__codelineno-0-487"></a>            <span class="s2">&quot;est_feature_stats&quot;</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488" href="#__codelineno-0-488"></a>            <span class="n">f_stats_estimation</span><span class="p">(</span>
<a id="__codelineno-0-489" name="__codelineno-0-489" href="#__codelineno-0-489"></a>                <span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="s2">&quot;transformation&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_mean_list&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_stddev_list&quot;</span>
<a id="__codelineno-0-490" name="__codelineno-0-490" href="#__codelineno-0-490"></a>            <span class="p">),</span>
<a id="__codelineno-0-491" name="__codelineno-0-491" href="#__codelineno-0-491"></a>        <span class="p">)</span>
<a id="__codelineno-0-492" name="__codelineno-0-492" href="#__codelineno-0-492"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;est_feature_mean&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;est_feature_stats&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-493" name="__codelineno-0-493" href="#__codelineno-0-493"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;est_feature_stddev&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;est_feature_stats&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-0-494" name="__codelineno-0-494" href="#__codelineno-0-494"></a>        <span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-495" name="__codelineno-0-495" href="#__codelineno-0-495"></a>            <span class="s2">&quot;idx&quot;</span><span class="p">,</span>
<a id="__codelineno-0-496" name="__codelineno-0-496" href="#__codelineno-0-496"></a>            <span class="s2">&quot;attributes&quot;</span><span class="p">,</span>
<a id="__codelineno-0-497" name="__codelineno-0-497" href="#__codelineno-0-497"></a>            <span class="s2">&quot;transformation&quot;</span><span class="p">,</span>
<a id="__codelineno-0-498" name="__codelineno-0-498" href="#__codelineno-0-498"></a>            <span class="s2">&quot;est_feature_mean&quot;</span><span class="p">,</span>
<a id="__codelineno-0-499" name="__codelineno-0-499" href="#__codelineno-0-499"></a>            <span class="s2">&quot;est_feature_stddev&quot;</span><span class="p">,</span>
<a id="__codelineno-0-500" name="__codelineno-0-500" href="#__codelineno-0-500"></a>        <span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501" href="#__codelineno-0-501"></a>    <span class="p">)</span>
<a id="__codelineno-0-502" name="__codelineno-0-502" href="#__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503" href="#__codelineno-0-503"></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-504" name="__codelineno-0-504" href="#__codelineno-0-504"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transformations</span><span class="p">):</span>
<a id="__codelineno-0-505" name="__codelineno-0-505" href="#__codelineno-0-505"></a>        <span class="n">i_output</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-506" name="__codelineno-0-506" href="#__codelineno-0-506"></a>        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;est_feature_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;est_feature_stddev&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-507" name="__codelineno-0-507" href="#__codelineno-0-507"></a>            <span class="n">metric_stats</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-508" name="__codelineno-0-508" href="#__codelineno-0-508"></a>                <span class="n">df_feature_metric</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;transformation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509" href="#__codelineno-0-509"></a>                <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
<a id="__codelineno-0-510" name="__codelineno-0-510" href="#__codelineno-0-510"></a>                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
<a id="__codelineno-0-511" name="__codelineno-0-511" href="#__codelineno-0-511"></a>                <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<a id="__codelineno-0-512" name="__codelineno-0-512" href="#__codelineno-0-512"></a>                <span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-513" name="__codelineno-0-513" href="#__codelineno-0-513"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-0-514" name="__codelineno-0-514" href="#__codelineno-0-514"></a>            <span class="p">)</span>
<a id="__codelineno-0-515" name="__codelineno-0-515" href="#__codelineno-0-515"></a>            <span class="n">metric_cv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">variation</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">metric_stats</span><span class="p">])),</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-516" name="__codelineno-0-516" href="#__codelineno-0-516"></a>            <span class="n">i_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_cv</span><span class="p">)</span>
<a id="__codelineno-0-517" name="__codelineno-0-517" href="#__codelineno-0-517"></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_output</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518" href="#__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519" href="#__codelineno-0-519"></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">StructType</span><span class="p">(</span>
<a id="__codelineno-0-520" name="__codelineno-0-520" href="#__codelineno-0-520"></a>        <span class="p">[</span>
<a id="__codelineno-0-521" name="__codelineno-0-521" href="#__codelineno-0-521"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;feature_formula&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-522" name="__codelineno-0-522" href="#__codelineno-0-522"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-523" name="__codelineno-0-523" href="#__codelineno-0-523"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-524" name="__codelineno-0-524" href="#__codelineno-0-524"></a>        <span class="p">]</span>
<a id="__codelineno-0-525" name="__codelineno-0-525" href="#__codelineno-0-525"></a>    <span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526" href="#__codelineno-0-526"></a>
<a id="__codelineno-0-527" name="__codelineno-0-527" href="#__codelineno-0-527"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528" href="#__codelineno-0-528"></a>
<a id="__codelineno-0-529" name="__codelineno-0-529" href="#__codelineno-0-529"></a>    <span class="k">def</span> <span class="nf">score_cv</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">thresholds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]):</span>
<a id="__codelineno-0-530" name="__codelineno-0-530" href="#__codelineno-0-530"></a>        <span class="k">if</span> <span class="n">cv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-531" name="__codelineno-0-531" href="#__codelineno-0-531"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-532" name="__codelineno-0-532" href="#__codelineno-0-532"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-533" name="__codelineno-0-533" href="#__codelineno-0-533"></a>            <span class="n">cv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534" href="#__codelineno-0-534"></a>            <span class="n">stability_index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-535" name="__codelineno-0-535" href="#__codelineno-0-535"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
<a id="__codelineno-0-536" name="__codelineno-0-536" href="#__codelineno-0-536"></a>                <span class="k">if</span> <span class="n">cv</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
<a id="__codelineno-0-537" name="__codelineno-0-537" href="#__codelineno-0-537"></a>                    <span class="k">return</span> <span class="n">stability_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-538" name="__codelineno-0-538" href="#__codelineno-0-538"></a>            <span class="k">return</span> <span class="n">stability_index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-539" name="__codelineno-0-539" href="#__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540" href="#__codelineno-0-540"></a>    <span class="n">f_score_cv</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">udf</span><span class="p">(</span><span class="n">score_cv</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">())</span>
<a id="__codelineno-0-541" name="__codelineno-0-541" href="#__codelineno-0-541"></a>
<a id="__codelineno-0-542" name="__codelineno-0-542" href="#__codelineno-0-542"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-543" name="__codelineno-0-543" href="#__codelineno-0-543"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-544" name="__codelineno-0-544" href="#__codelineno-0-544"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_si&quot;</span><span class="p">,</span> <span class="n">f_score_cv</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-545" name="__codelineno-0-545" href="#__codelineno-0-545"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stddev_si&quot;</span><span class="p">,</span> <span class="n">f_score_cv</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-546" name="__codelineno-0-546" href="#__codelineno-0-546"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-547" name="__codelineno-0-547" href="#__codelineno-0-547"></a>            <span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-548" name="__codelineno-0-548" href="#__codelineno-0-548"></a>            <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
<a id="__codelineno-0-549" name="__codelineno-0-549" href="#__codelineno-0-549"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_si&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-550" name="__codelineno-0-550" href="#__codelineno-0-550"></a>                <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stddev_si&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-551" name="__codelineno-0-551" href="#__codelineno-0-551"></a>                <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-552" name="__codelineno-0-552" href="#__codelineno-0-552"></a>            <span class="p">),</span>
<a id="__codelineno-0-553" name="__codelineno-0-553" href="#__codelineno-0-553"></a>        <span class="p">)</span>
<a id="__codelineno-0-554" name="__codelineno-0-554" href="#__codelineno-0-554"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-555" name="__codelineno-0-555" href="#__codelineno-0-555"></a>            <span class="s2">&quot;stability_index_upper_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-0-556" name="__codelineno-0-556" href="#__codelineno-0-556"></a>            <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
<a id="__codelineno-0-557" name="__codelineno-0-557" href="#__codelineno-0-557"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">)</span>
<a id="__codelineno-0-558" name="__codelineno-0-558" href="#__codelineno-0-558"></a>                <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-559" name="__codelineno-0-559" href="#__codelineno-0-559"></a>                <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-560" name="__codelineno-0-560" href="#__codelineno-0-560"></a>            <span class="p">),</span>
<a id="__codelineno-0-561" name="__codelineno-0-561" href="#__codelineno-0-561"></a>        <span class="p">)</span>
<a id="__codelineno-0-562" name="__codelineno-0-562" href="#__codelineno-0-562"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-563" name="__codelineno-0-563" href="#__codelineno-0-563"></a>            <span class="s2">&quot;flagged_lower&quot;</span><span class="p">,</span>
<a id="__codelineno-0-564" name="__codelineno-0-564" href="#__codelineno-0-564"></a>            <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
<a id="__codelineno-0-565" name="__codelineno-0-565" href="#__codelineno-0-565"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-566" name="__codelineno-0-566" href="#__codelineno-0-566"></a>                <span class="o">|</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()),</span>
<a id="__codelineno-0-567" name="__codelineno-0-567" href="#__codelineno-0-567"></a>                <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-568" name="__codelineno-0-568" href="#__codelineno-0-568"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-569" name="__codelineno-0-569" href="#__codelineno-0-569"></a>        <span class="p">)</span>
<a id="__codelineno-0-570" name="__codelineno-0-570" href="#__codelineno-0-570"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-571" name="__codelineno-0-571" href="#__codelineno-0-571"></a>            <span class="s2">&quot;flagged_upper&quot;</span><span class="p">,</span>
<a id="__codelineno-0-572" name="__codelineno-0-572" href="#__codelineno-0-572"></a>            <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
<a id="__codelineno-0-573" name="__codelineno-0-573" href="#__codelineno-0-573"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_upper_bound&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-0-574" name="__codelineno-0-574" href="#__codelineno-0-574"></a>                <span class="o">|</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_upper_bound&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()),</span>
<a id="__codelineno-0-575" name="__codelineno-0-575" href="#__codelineno-0-575"></a>                <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576" href="#__codelineno-0-576"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-577" name="__codelineno-0-577" href="#__codelineno-0-577"></a>        <span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578" href="#__codelineno-0-578"></a>    <span class="p">)</span>
<a id="__codelineno-0-579" name="__codelineno-0-579" href="#__codelineno-0-579"></a>
<a id="__codelineno-0-580" name="__codelineno-0-580" href="#__codelineno-0-580"></a>    <span class="k">if</span> <span class="n">print_impact</span><span class="p">:</span>
<a id="__codelineno-0-581" name="__codelineno-0-581" href="#__codelineno-0-581"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Features:&quot;</span><span class="p">)</span>
<a id="__codelineno-0-582" name="__codelineno-0-582" href="#__codelineno-0-582"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attribute_names</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-583" name="__codelineno-0-583" href="#__codelineno-0-583"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-584" name="__codelineno-0-584" href="#__codelineno-0-584"></a>            <span class="s2">&quot;Potential Unstable Features Identified by Both Lower and Upper Bounds:&quot;</span>
<a id="__codelineno-0-585" name="__codelineno-0-585" href="#__codelineno-0-585"></a>        <span class="p">)</span>
<a id="__codelineno-0-586" name="__codelineno-0-586" href="#__codelineno-0-586"></a>        <span class="n">unstable</span> <span class="o">=</span> <span class="n">odf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;flagged_upper&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-587" name="__codelineno-0-587" href="#__codelineno-0-587"></a>        <span class="n">unstable</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">unstable</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<a id="__codelineno-0-588" name="__codelineno-0-588" href="#__codelineno-0-588"></a>
<a id="__codelineno-0-589" name="__codelineno-0-589" href="#__codelineno-0-589"></a>    <span class="k">return</span> <span class="n">odf</span>
</code></pre></div>
</pre>
</details>
<h2 id="functions">Functions</h2>
<dl>
<dt id="anovos.drift_stability.stability.feature_stability_estimation"><code class="name flex hljs csharp">
<span class="k">def</span> <span class="nf"><span class="ident">feature_stability_estimation</span></span>(<span class="n">spark, attribute_stats, attribute_transformation, metric_weightages={'mean': 0.5, 'stddev': 0.3, 'kurtosis': 0.2}, threshold=1, print_impact=False)</span>
</code></dt>
<dd>
<div class="desc"><p>This function is able to estimate the stability index of a new feature composed of certain attributes whose
stability metrics are known. For example, the new feature F can be expressed as F = g(X1, X2, â€¦, Xn),
where X1, X2, â€¦, Xn represent different attributes and g represents the transformation function.
The most straightforward way is to generate the new feature for all periods and calculate its stability index.
However, it requires reading all historical data again which can be unrealistic for large datasets.
Thus, the objective of this function is to estimate feature stability index without reading historical data.</p>
<p>One example can be the following scenario: we have attributes A and B, we have their respective stability
statistics from T1 to T7. At T7 we realise we need to generate a new feature: A/B, but we donâ€™t have
statistics metrics of A/B from T1 to T6 and this is where this function can be applied to generate an
estimation without reading datasets from T1 to T6.</p>
<p>The estimation can be broken down into 3 steps.
1. Estimate mean and stddev for the new feature based on attribute metrics (no existing resource found to
estimate Feature kurtosis). Estimated mean and stddev are generated for each time period using the
formula below according to [1]:
<img alt="https://raw.githubusercontent.com/anovos/anovos-docs/main/docs/assets/feature_stability_formulae.png" src="https://raw.githubusercontent.com/anovos/anovos-docs/main/docs/assets/feature_stability_formulae.png">
2. Calculate Coefficient of variation (CV) for estimated feature mean and stddev. Each CV can be then mapped
to an integer between 0 and 4 to generate the metric stability index.
3. Similar to the attribute stability index, each metric is assigned a weightage between 0 and 1, where the
default values are 50 for mean, 30% for standard deviation and 20% for kurtosis. Because we are unable to
generate kurtosis stability index, its minimum and maximum possible values (0 and 4) are used to output a
range for global stability index (GSI):
* Lower bound of GSI = 0.5âˆ—mean stability index + 0.3âˆ—stddev stability index + 0.2 âˆ— ðŸŽ
* Upper bound of GSI = 0.5âˆ—mean stability index + 0.3âˆ—stddev stability index + 0.2 âˆ— ðŸ’</p>
<p>[1] Benaroya, H., Han, S. M., &amp; Nagurka, M. (2005). Probability models in engineering and science (Vol. 192, pp. 168-169). CRC press.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>spark</code></strong></dt>
<dd>Spark Session</dd>
<dt><strong><code>attribute_stats</code></strong></dt>
<dd>Spark dataframe. The intermediate dataframe saved by running function
stabilityIndex_computation with schema [idx, attribute, mean, stddev, kurtosis].
It should contain all the attributes used in argument attribute_transformation.</dd>
<dt><strong><code>attribute_transformation</code></strong></dt>
<dd>Takes input in dictionary format: each key-value combination represents one
new feature. Each key is a string containing all the attributes involved in
the new feature seperated by '|'. Each value is the transformation of the
attributes in string. For example, {'X|Y|Z': 'X**2+Y/Z', 'A': 'log(A)'}</dd>
<dt><strong><code>metric_weightages</code></strong></dt>
<dd>Takes input in dictionary format with keys being the metric name - "mean","stdev","kurtosis"
and value being the weightage of the metric (between 0 and 1). Sum of all weightages must be 1.
(Default value = {"mean": 0.5, "stddev": 0.3, "kurtosis": 0.2})</dd>
<dt><strong><code>threshold</code></strong></dt>
<dd>A column is flagged if the stability index is below the threshold, which varies between 0 and 4.
The following criteria can be used to classify stability_index (SI): very unstable: 0â‰¤SI&lt;1,
unstable: 1â‰¤SI&lt;2, marginally stable: 2â‰¤SI&lt;3, stable: 3â‰¤SI&lt;3.5 and very stable: 3.5â‰¤SIâ‰¤4. (Default value = 1)</dd>
<dt><strong><code>print_impact</code></strong></dt>
<dd>True, False (Default value = False)
This argument is to print out the stability metrics of all newly generated features and potential unstable features.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>DataFrame</code></dt>
<dd>[feature_formula, mean_cv, stddev_cv, mean_si, stddev_si, stability_index_lower_bound,
stability_index_upper_bound, flagged_lower, flagged_upper].
<em>_cv is coefficient of variation for each metric. </em>_si is stability index for each metric.
stability_index_lower_bound and stability_index_upper_bound form a range for estimated stability index.
flagged_lower and flagged_upper indicate whether the feature is potentially unstable based on the lower
and upper bounds for stability index.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">def</span> <span class="nf">feature_stability_estimation</span><span class="p">(</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="n">spark</span><span class="p">,</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="n">attribute_stats</span><span class="p">,</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="n">attribute_transformation</span><span class="p">,</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="n">metric_weightages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;stddev&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;kurtosis&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="n">print_impact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="p">):</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="sd">    This function is able to estimate the stability index of a new feature composed of certain attributes whose</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="sd">    stability metrics are known. For example, the new feature F can be expressed as F = g(X1, X2, â€¦, Xn),</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="sd">    where X1, X2, â€¦, Xn represent different attributes and g represents the transformation function.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="sd">    The most straightforward way is to generate the new feature for all periods and calculate its stability index.</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="sd">    However, it requires reading all historical data again which can be unrealistic for large datasets.</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="sd">    Thus, the objective of this function is to estimate feature stability index without reading historical data.</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="sd">    One example can be the following scenario: we have attributes A and B, we have their respective stability</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="sd">    statistics from T1 to T7. At T7 we realise we need to generate a new feature: A/B, but we donâ€™t have</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="sd">    statistics metrics of A/B from T1 to T6 and this is where this function can be applied to generate an</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="sd">    estimation without reading datasets from T1 to T6.</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="sd">    The estimation can be broken down into 3 steps.</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="sd">    1. Estimate mean and stddev for the new feature based on attribute metrics (no existing resource found to</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="sd">    estimate Feature kurtosis). Estimated mean and stddev are generated for each time period using the</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="sd">    formula below according to [1]:</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="sd">    ![https://raw.githubusercontent.com/anovos/anovos-docs/main/docs/assets/feature_stability_formulae.png](https://raw.githubusercontent.com/anovos/anovos-docs/main/docs/assets/feature_stability_formulae.png)</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="sd">    2. Calculate Coefficient of variation (CV) for estimated feature mean and stddev. Each CV can be then mapped</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="sd">    to an integer between 0 and 4 to generate the metric stability index.</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="sd">    3. Similar to the attribute stability index, each metric is assigned a weightage between 0 and 1, where the</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="sd">    default values are 50 for mean, 30% for standard deviation and 20% for kurtosis. Because we are unable to</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="sd">    generate kurtosis stability index, its minimum and maximum possible values (0 and 4) are used to output a</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="sd">    range for global stability index (GSI):</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="sd">        * Lower bound of GSI = 0.5âˆ—mean stability index + 0.3âˆ—stddev stability index + 0.2 âˆ— ðŸŽ</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="sd">        * Upper bound of GSI = 0.5âˆ—mean stability index + 0.3âˆ—stddev stability index + 0.2 âˆ— ðŸ’</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="sd">    [1] Benaroya, H., Han, S. M., &amp; Nagurka, M. (2005). Probability models in engineering and science (Vol. 192, pp. 168-169). CRC press.</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="sd">    Parameters</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="sd">    ----------</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="sd">    spark</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="sd">        Spark Session</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="sd">    attribute_stats</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="sd">        Spark dataframe. The intermediate dataframe saved by running function</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="sd">        stabilityIndex_computation with schema [idx, attribute, mean, stddev, kurtosis].</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="sd">        It should contain all the attributes used in argument attribute_transformation.</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a><span class="sd">    attribute_transformation</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="sd">        Takes input in dictionary format: each key-value combination represents one</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="sd">        new feature. Each key is a string containing all the attributes involved in</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="sd">        the new feature seperated by &#39;|&#39;. Each value is the transformation of the</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a><span class="sd">        attributes in string. For example, {&#39;X|Y|Z&#39;: &#39;X**2+Y/Z&#39;, &#39;A&#39;: &#39;log(A)&#39;}</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="sd">    metric_weightages</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a><span class="sd">        Takes input in dictionary format with keys being the metric name - &quot;mean&quot;,&quot;stdev&quot;,&quot;kurtosis&quot;</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a><span class="sd">        and value being the weightage of the metric (between 0 and 1). Sum of all weightages must be 1.</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a><span class="sd">        (Default value = {&quot;mean&quot;: 0.5, &quot;stddev&quot;: 0.3, &quot;kurtosis&quot;: 0.2})</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a><span class="sd">    threshold</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="sd">        A column is flagged if the stability index is below the threshold, which varies between 0 and 4.</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a><span class="sd">        The following criteria can be used to classify stability_index (SI): very unstable: 0â‰¤SI&lt;1,</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a><span class="sd">        unstable: 1â‰¤SI&lt;2, marginally stable: 2â‰¤SI&lt;3, stable: 3â‰¤SI&lt;3.5 and very stable: 3.5â‰¤SIâ‰¤4. (Default value = 1)</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="sd">    print_impact</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a><span class="sd">        True, False (Default value = False)</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a><span class="sd">        This argument is to print out the stability metrics of all newly generated features and potential unstable features.</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a><span class="sd">    Returns</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="sd">    -------</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a><span class="sd">    DataFrame</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a><span class="sd">        [feature_formula, mean_cv, stddev_cv, mean_si, stddev_si, stability_index_lower_bound,</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a><span class="sd">        stability_index_upper_bound, flagged_lower, flagged_upper].</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a><span class="sd">        *_cv is coefficient of variation for each metric. *_si is stability index for each metric.</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a><span class="sd">        stability_index_lower_bound and stability_index_upper_bound form a range for estimated stability index.</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a><span class="sd">        flagged_lower and flagged_upper indicate whether the feature is potentially unstable based on the lower</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a><span class="sd">        and upper bounds for stability index.</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>    <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>        <span class="nb">round</span><span class="p">(</span>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>            <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>            <span class="o">+</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>            <span class="o">+</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>            <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>        <span class="p">)</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>        <span class="o">!=</span> <span class="mi">1</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>    <span class="p">):</span>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>            <span class="s2">&quot;Invalid input for metric weightages. Either metric name is incorrect or sum of metric weightages is not 1.0.&quot;</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>        <span class="p">)</span>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>    <span class="k">def</span> <span class="nf">stats_estimation</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddev</span><span class="p">):</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>        <span class="n">attribute_means</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">mean</span><span class="p">))</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>        <span class="n">first_dev</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>        <span class="n">second_dev</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>        <span class="n">est_mean</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>        <span class="n">est_var</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">stddev</span><span class="p">):</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>            <span class="n">first_dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>            <span class="n">second_dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">transformation</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>            <span class="n">est_mean</span> <span class="o">+=</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">second_dev</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">attribute_means</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>            <span class="n">est_var</span> <span class="o">+=</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">first_dev</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">attribute_means</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>        <span class="n">transformation</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">parse_expr</span><span class="p">(</span><span class="n">transformation</span><span class="p">)</span>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>        <span class="n">est_mean</span> <span class="o">+=</span> <span class="n">transformation</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">attribute_means</span><span class="p">)</span>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>        <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">est_mean</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">est_var</span><span class="p">)]</span>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>    <span class="n">f_stats_estimation</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">udf</span><span class="p">(</span><span class="n">stats_estimation</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()))</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>    <span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>        <span class="n">attribute_stats</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a>        <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>        <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>        <span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>        <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>    <span class="p">)</span>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>    <span class="n">attribute_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribute_transformation</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>    <span class="n">transformations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attribute_transformation</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>    <span class="n">feature_metric</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>    <span class="k">for</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">transformation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">attribute_names</span><span class="p">,</span> <span class="n">transformations</span><span class="p">):</span>
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">attributes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
<a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>            <span class="n">attr_mean_list</span><span class="p">,</span> <span class="n">attr_stddev_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
<a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>                <span class="n">df_temp</span> <span class="o">=</span> <span class="n">attribute_stats</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a>                    <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a>                <span class="p">)</span>
<a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>                <span class="k">if</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>                        <span class="s2">&quot;Invalid input for attribute_stats: all involved attributes must have available statistics across all time periods (idx)&quot;</span>
<a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>                    <span class="p">)</span>
<a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>                <span class="n">attr_mean_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a>                    <span class="n">df_temp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a>                <span class="p">)</span>
<a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a>                <span class="n">attr_stddev_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a>                    <span class="n">df_temp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a>                <span class="p">)</span>
<a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a>            <span class="n">feature_metric</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a>                <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">attr_mean_list</span><span class="p">,</span> <span class="n">attr_stddev_list</span><span class="p">]</span>
<a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a>            <span class="p">)</span>
<a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>
<a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">StructType</span><span class="p">(</span>
<a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>        <span class="p">[</span>
<a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;transformation&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">StringType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;attr_mean_list&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;attr_stddev_list&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a>        <span class="p">]</span>
<a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a>    <span class="p">)</span>
<a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a>
<a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a>    <span class="n">df_feature_metric</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a>        <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">feature_metric</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
<a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-1-153" name="__codelineno-1-153" href="#__codelineno-1-153"></a>            <span class="s2">&quot;est_feature_stats&quot;</span><span class="p">,</span>
<a id="__codelineno-1-154" name="__codelineno-1-154" href="#__codelineno-1-154"></a>            <span class="n">f_stats_estimation</span><span class="p">(</span>
<a id="__codelineno-1-155" name="__codelineno-1-155" href="#__codelineno-1-155"></a>                <span class="s2">&quot;attributes&quot;</span><span class="p">,</span> <span class="s2">&quot;transformation&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_mean_list&quot;</span><span class="p">,</span> <span class="s2">&quot;attr_stddev_list&quot;</span>
<a id="__codelineno-1-156" name="__codelineno-1-156" href="#__codelineno-1-156"></a>            <span class="p">),</span>
<a id="__codelineno-1-157" name="__codelineno-1-157" href="#__codelineno-1-157"></a>        <span class="p">)</span>
<a id="__codelineno-1-158" name="__codelineno-1-158" href="#__codelineno-1-158"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;est_feature_mean&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;est_feature_stats&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-1-159" name="__codelineno-1-159" href="#__codelineno-1-159"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;est_feature_stddev&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;est_feature_stats&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-1-160" name="__codelineno-1-160" href="#__codelineno-1-160"></a>        <span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-1-161" name="__codelineno-1-161" href="#__codelineno-1-161"></a>            <span class="s2">&quot;idx&quot;</span><span class="p">,</span>
<a id="__codelineno-1-162" name="__codelineno-1-162" href="#__codelineno-1-162"></a>            <span class="s2">&quot;attributes&quot;</span><span class="p">,</span>
<a id="__codelineno-1-163" name="__codelineno-1-163" href="#__codelineno-1-163"></a>            <span class="s2">&quot;transformation&quot;</span><span class="p">,</span>
<a id="__codelineno-1-164" name="__codelineno-1-164" href="#__codelineno-1-164"></a>            <span class="s2">&quot;est_feature_mean&quot;</span><span class="p">,</span>
<a id="__codelineno-1-165" name="__codelineno-1-165" href="#__codelineno-1-165"></a>            <span class="s2">&quot;est_feature_stddev&quot;</span><span class="p">,</span>
<a id="__codelineno-1-166" name="__codelineno-1-166" href="#__codelineno-1-166"></a>        <span class="p">)</span>
<a id="__codelineno-1-167" name="__codelineno-1-167" href="#__codelineno-1-167"></a>    <span class="p">)</span>
<a id="__codelineno-1-168" name="__codelineno-1-168" href="#__codelineno-1-168"></a>
<a id="__codelineno-1-169" name="__codelineno-1-169" href="#__codelineno-1-169"></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-170" name="__codelineno-1-170" href="#__codelineno-1-170"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transformations</span><span class="p">):</span>
<a id="__codelineno-1-171" name="__codelineno-1-171" href="#__codelineno-1-171"></a>        <span class="n">i_output</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-1-172" name="__codelineno-1-172" href="#__codelineno-1-172"></a>        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;est_feature_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;est_feature_stddev&quot;</span><span class="p">]:</span>
<a id="__codelineno-1-173" name="__codelineno-1-173" href="#__codelineno-1-173"></a>            <span class="n">metric_stats</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-174" name="__codelineno-1-174" href="#__codelineno-1-174"></a>                <span class="n">df_feature_metric</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;transformation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
<a id="__codelineno-1-175" name="__codelineno-1-175" href="#__codelineno-1-175"></a>                <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
<a id="__codelineno-1-176" name="__codelineno-1-176" href="#__codelineno-1-176"></a>                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
<a id="__codelineno-1-177" name="__codelineno-1-177" href="#__codelineno-1-177"></a>                <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<a id="__codelineno-1-178" name="__codelineno-1-178" href="#__codelineno-1-178"></a>                <span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-1-179" name="__codelineno-1-179" href="#__codelineno-1-179"></a>                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<a id="__codelineno-1-180" name="__codelineno-1-180" href="#__codelineno-1-180"></a>            <span class="p">)</span>
<a id="__codelineno-1-181" name="__codelineno-1-181" href="#__codelineno-1-181"></a>            <span class="n">metric_cv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">variation</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">metric_stats</span><span class="p">])),</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-1-182" name="__codelineno-1-182" href="#__codelineno-1-182"></a>            <span class="n">i_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_cv</span><span class="p">)</span>
<a id="__codelineno-1-183" name="__codelineno-1-183" href="#__codelineno-1-183"></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_output</span><span class="p">)</span>
<a id="__codelineno-1-184" name="__codelineno-1-184" href="#__codelineno-1-184"></a>
<a id="__codelineno-1-185" name="__codelineno-1-185" href="#__codelineno-1-185"></a>    <span class="n">schema</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">StructType</span><span class="p">(</span>
<a id="__codelineno-1-186" name="__codelineno-1-186" href="#__codelineno-1-186"></a>        <span class="p">[</span>
<a id="__codelineno-1-187" name="__codelineno-1-187" href="#__codelineno-1-187"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;feature_formula&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-188" name="__codelineno-1-188" href="#__codelineno-1-188"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-189" name="__codelineno-1-189" href="#__codelineno-1-189"></a>            <span class="n">T</span><span class="o">.</span><span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-1-190" name="__codelineno-1-190" href="#__codelineno-1-190"></a>        <span class="p">]</span>
<a id="__codelineno-1-191" name="__codelineno-1-191" href="#__codelineno-1-191"></a>    <span class="p">)</span>
<a id="__codelineno-1-192" name="__codelineno-1-192" href="#__codelineno-1-192"></a>
<a id="__codelineno-1-193" name="__codelineno-1-193" href="#__codelineno-1-193"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
<a id="__codelineno-1-194" name="__codelineno-1-194" href="#__codelineno-1-194"></a>
<a id="__codelineno-1-195" name="__codelineno-1-195" href="#__codelineno-1-195"></a>    <span class="k">def</span> <span class="nf">score_cv</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">thresholds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]):</span>
<a id="__codelineno-1-196" name="__codelineno-1-196" href="#__codelineno-1-196"></a>        <span class="k">if</span> <span class="n">cv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-197" name="__codelineno-1-197" href="#__codelineno-1-197"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-1-198" name="__codelineno-1-198" href="#__codelineno-1-198"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-199" name="__codelineno-1-199" href="#__codelineno-1-199"></a>            <span class="n">cv</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span>
<a id="__codelineno-1-200" name="__codelineno-1-200" href="#__codelineno-1-200"></a>            <span class="n">stability_index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-201" name="__codelineno-1-201" href="#__codelineno-1-201"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
<a id="__codelineno-1-202" name="__codelineno-1-202" href="#__codelineno-1-202"></a>                <span class="k">if</span> <span class="n">cv</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
<a id="__codelineno-1-203" name="__codelineno-1-203" href="#__codelineno-1-203"></a>                    <span class="k">return</span> <span class="n">stability_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-1-204" name="__codelineno-1-204" href="#__codelineno-1-204"></a>            <span class="k">return</span> <span class="n">stability_index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-205" name="__codelineno-1-205" href="#__codelineno-1-205"></a>
<a id="__codelineno-1-206" name="__codelineno-1-206" href="#__codelineno-1-206"></a>    <span class="n">f_score_cv</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">udf</span><span class="p">(</span><span class="n">score_cv</span><span class="p">,</span> <span class="n">T</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">())</span>
<a id="__codelineno-1-207" name="__codelineno-1-207" href="#__codelineno-1-207"></a>
<a id="__codelineno-1-208" name="__codelineno-1-208" href="#__codelineno-1-208"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-1-209" name="__codelineno-1-209" href="#__codelineno-1-209"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-1-210" name="__codelineno-1-210" href="#__codelineno-1-210"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_si&quot;</span><span class="p">,</span> <span class="n">f_score_cv</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">)))</span>
<a id="__codelineno-1-211" name="__codelineno-1-211" href="#__codelineno-1-211"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stddev_si&quot;</span><span class="p">,</span> <span class="n">f_score_cv</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">)))</span>
<a id="__codelineno-1-212" name="__codelineno-1-212" href="#__codelineno-1-212"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-1-213" name="__codelineno-1-213" href="#__codelineno-1-213"></a>            <span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-1-214" name="__codelineno-1-214" href="#__codelineno-1-214"></a>            <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
<a id="__codelineno-1-215" name="__codelineno-1-215" href="#__codelineno-1-215"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_si&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-1-216" name="__codelineno-1-216" href="#__codelineno-1-216"></a>                <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stddev_si&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-1-217" name="__codelineno-1-217" href="#__codelineno-1-217"></a>                <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-1-218" name="__codelineno-1-218" href="#__codelineno-1-218"></a>            <span class="p">),</span>
<a id="__codelineno-1-219" name="__codelineno-1-219" href="#__codelineno-1-219"></a>        <span class="p">)</span>
<a id="__codelineno-1-220" name="__codelineno-1-220" href="#__codelineno-1-220"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-1-221" name="__codelineno-1-221" href="#__codelineno-1-221"></a>            <span class="s2">&quot;stability_index_upper_bound&quot;</span><span class="p">,</span>
<a id="__codelineno-1-222" name="__codelineno-1-222" href="#__codelineno-1-222"></a>            <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
<a id="__codelineno-1-223" name="__codelineno-1-223" href="#__codelineno-1-223"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">)</span>
<a id="__codelineno-1-224" name="__codelineno-1-224" href="#__codelineno-1-224"></a>                <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">metric_weightages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-1-225" name="__codelineno-1-225" href="#__codelineno-1-225"></a>                <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-1-226" name="__codelineno-1-226" href="#__codelineno-1-226"></a>            <span class="p">),</span>
<a id="__codelineno-1-227" name="__codelineno-1-227" href="#__codelineno-1-227"></a>        <span class="p">)</span>
<a id="__codelineno-1-228" name="__codelineno-1-228" href="#__codelineno-1-228"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-1-229" name="__codelineno-1-229" href="#__codelineno-1-229"></a>            <span class="s2">&quot;flagged_lower&quot;</span><span class="p">,</span>
<a id="__codelineno-1-230" name="__codelineno-1-230" href="#__codelineno-1-230"></a>            <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
<a id="__codelineno-1-231" name="__codelineno-1-231" href="#__codelineno-1-231"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-1-232" name="__codelineno-1-232" href="#__codelineno-1-232"></a>                <span class="o">|</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_lower_bound&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()),</span>
<a id="__codelineno-1-233" name="__codelineno-1-233" href="#__codelineno-1-233"></a>                <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-1-234" name="__codelineno-1-234" href="#__codelineno-1-234"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-1-235" name="__codelineno-1-235" href="#__codelineno-1-235"></a>        <span class="p">)</span>
<a id="__codelineno-1-236" name="__codelineno-1-236" href="#__codelineno-1-236"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-1-237" name="__codelineno-1-237" href="#__codelineno-1-237"></a>            <span class="s2">&quot;flagged_upper&quot;</span><span class="p">,</span>
<a id="__codelineno-1-238" name="__codelineno-1-238" href="#__codelineno-1-238"></a>            <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
<a id="__codelineno-1-239" name="__codelineno-1-239" href="#__codelineno-1-239"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_upper_bound&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-1-240" name="__codelineno-1-240" href="#__codelineno-1-240"></a>                <span class="o">|</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index_upper_bound&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()),</span>
<a id="__codelineno-1-241" name="__codelineno-1-241" href="#__codelineno-1-241"></a>                <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-1-242" name="__codelineno-1-242" href="#__codelineno-1-242"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-1-243" name="__codelineno-1-243" href="#__codelineno-1-243"></a>        <span class="p">)</span>
<a id="__codelineno-1-244" name="__codelineno-1-244" href="#__codelineno-1-244"></a>    <span class="p">)</span>
<a id="__codelineno-1-245" name="__codelineno-1-245" href="#__codelineno-1-245"></a>
<a id="__codelineno-1-246" name="__codelineno-1-246" href="#__codelineno-1-246"></a>    <span class="k">if</span> <span class="n">print_impact</span><span class="p">:</span>
<a id="__codelineno-1-247" name="__codelineno-1-247" href="#__codelineno-1-247"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Features:&quot;</span><span class="p">)</span>
<a id="__codelineno-1-248" name="__codelineno-1-248" href="#__codelineno-1-248"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attribute_names</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-249" name="__codelineno-1-249" href="#__codelineno-1-249"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-1-250" name="__codelineno-1-250" href="#__codelineno-1-250"></a>            <span class="s2">&quot;Potential Unstable Features Identified by Both Lower and Upper Bounds:&quot;</span>
<a id="__codelineno-1-251" name="__codelineno-1-251" href="#__codelineno-1-251"></a>        <span class="p">)</span>
<a id="__codelineno-1-252" name="__codelineno-1-252" href="#__codelineno-1-252"></a>        <span class="n">unstable</span> <span class="o">=</span> <span class="n">odf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;flagged_upper&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-253" name="__codelineno-1-253" href="#__codelineno-1-253"></a>        <span class="n">unstable</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">unstable</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<a id="__codelineno-1-254" name="__codelineno-1-254" href="#__codelineno-1-254"></a>
<a id="__codelineno-1-255" name="__codelineno-1-255" href="#__codelineno-1-255"></a>    <span class="k">return</span> <span class="n">odf</span>
</code></pre></div>
</pre>
</details>
</dd>
<dt id="anovos.drift_stability.stability.stability_index_computation"><code class="name flex hljs csharp">
<span class="k">def</span> <span class="nf"><span class="ident">stability_index_computation</span></span>(<span class="n">spark, idfs, list_of_cols='all', drop_cols=[], metric_weightages={'mean': 0.5, 'stddev': 0.3, 'kurtosis': 0.2}, binary_cols=[], existing_metric_path='', appended_metric_path='', persist:Â boolÂ =Â True, persist_option=StorageLevel(True, True, False, False, 1), threshold=1, print_impact=False)</span>
</code></dt>
<dd>
<div class="desc"><p>The data stability is represented by a single metric to summarise the stability of an attribute over multiple
time periods. For example, given 6 datasets collected in 6 consecutive time periods (D1, D2, â€¦, D6),
data stability index of an attribute measures how stable the attribute is from D1 to D6.</p>
<p>The major difference between data drift and data stability is that data drift analysis is only based on 2
datasets: source and target. However data stability analysis can be performed on multiple datasets. In addition,
the source dataset is not required indicating that the stability index can be directly computed among multiple
target datasets by comparing the statistical properties among them.</p>
<p>In summary, given N datasets representing different time periods, we would like to measure the stability of some
numerical attributes from the first to the N-th dataset.</p>
<p>The whole process can be broken down into 2 steps: (1) Choose a few statistical metrics to describe the
distribution of each attribute at each time period. (2) Compute attribute level stability by combining the
stability of each statistical metric over time periods.</p>
<p>In the first step, we choose mean, standard deviation and kurtosis as the statistical metrics in our
implementation. Intuitively, they represent different aspects of a distribution: mean measures central tendency,
standard deviation measures dispersion and kurtosis measures shape of a distribution. Reasons of selecting those
3 metrics will be explained in a later section. With mean, standard deviation and kurtosis computed for each
attribute at each time interval, we can form 3 arrays of size N for each attribute.</p>
<p>In the second step, Coefficient of Variation (CV) is used to measure the stability of each metric. CV represents
the ratio of the standard deviation to the mean, which is a unitless statistic to compare the relative variation
from one array to another. Considering the wide potential range of CV, the absolute value of CV is then mapped to
an integer between 0 and 4 according to the table below, where 0 indicates highly unstable and 4 indicates highly
stable. We call this integer a metric stability index.</p>
<table>
<thead>
<tr>
<th>abs(CV) Interval</th>
<th>Metric Stability Index</th>
</tr>
</thead>
<tbody>
<tr>
<td>[0, 0.03)</td>
<td>4</td>
</tr>
<tr>
<td>[0.03, 0.1)</td>
<td>3</td>
</tr>
<tr>
<td>[0.1, 0.2)</td>
<td>2</td>
</tr>
<tr>
<td>[0.2, 0.5)</td>
<td>1</td>
</tr>
<tr>
<td>[0.5, +inf)</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>Finally, the attribute stability index (SI) is a weighted sum of 3 metric stability indexes, where we assign 50%
for mean, 30% for standard deviation and 20% for kurtosis by default. The final output is a float between 0 and 4 and an
attribute can be classified as one of the following categories: very unstable (0â‰¤SI&lt;1), unstable (1â‰¤SI&lt;2),
marginally stable (2â‰¤SI&lt;3), stable (3â‰¤SI&lt;3.5) and very stable (3.5â‰¤SIâ‰¤4).</p>
<p>For example, there are 6 samples of attribute X from T1 to T6. For each sample, we have computed the statistical
metrics of X from T1 to T6:</p>
<table>
<thead>
<tr>
<th>idx</th>
<th>Mean</th>
<th>Standard deviation</th>
<th>Kurtosis</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>11</td>
<td>2</td>
<td>3.9</td>
</tr>
<tr>
<td>2</td>
<td>12</td>
<td>1</td>
<td>4.2</td>
</tr>
<tr>
<td>3</td>
<td>15</td>
<td>3</td>
<td>4.0</td>
</tr>
<tr>
<td>4</td>
<td>10</td>
<td>2</td>
<td>4.1</td>
</tr>
<tr>
<td>5</td>
<td>11</td>
<td>1</td>
<td>4.2</td>
</tr>
<tr>
<td>6</td>
<td>13</td>
<td>0.5</td>
<td>4.0</td>
</tr>
</tbody>
</table>
<p>Then we calculate the Coefficient of Variation for each array:</p>
<ul>
<li>CV of mean = CV([11, 12, 15, 10, 11, 13]) = 0.136</li>
<li>CV of standard deviation = CV([2, 1, 3, 2, 1, 0.5]) = 0.529</li>
<li>CV of kurtosis = CV([3.9, 4.2, 4.0, 4.1, 4.2, 4.0]) = 0.027</li>
</ul>
<p>Metric stability indexes are then computed by mapping each CV value to an integer accordingly. As a result,
metric stability index is 2 for mean, 0 for standard deviation and 4 for kurtosis.</p>
<p>Why mean is chosen over median?</p>
<ul>
<li>Dummy variables which take only the value 0 or 1 are frequently seen in machine learning features. Mean of a
dummy variable represents the proportion of value 1 and median of a dummy variable is either 0 or 1 whichever is
more frequent. However, CV may not work well when 0 appears in the array or the array contains both positive and
negative values. For example, intuitively [0,0,0,0,0,1,0,0,0] is a stable array but its CV is 2.83 which is
extremely high, but cv of [0.45,0.44,0.48,0.49,0.42,0.52,0.49,0.47,0.48] is 0.06 which is much more reasonable.
Thus we decided to use mean instead of median. Although median is considered as a more robust choice,
outlier treatment can be applied prior to data stability analysis to handle this issue.</li>
</ul>
<p>Why kurtosis is chosen over skewness?</p>
<ul>
<li>Kurtosis is a positive value (note that we use kurtosis instead of excess kurtosis which) but skewness can
range from â€“inf to +inf. Usually, if skewness is between -0.5 and 0.5, the distribution is approximately
symmetric. Thus, if the skewness fluctuates around 0, the CV is highly likely to be high or invalid because the
mean will be close to 0.</li>
</ul>
<p>Stability index is preferred in the following scenario:</p>
<ul>
<li>Pairwise drift analysis can be performed between the source dataset and each of the target dataset to quantify
the drift over time. However this can be time-consuming especially when the number of target dataset is large. In
this case, measuring data stability instead of data drift would be a much faster alternative and the
source/baseline dataset is not required as well</li>
</ul>
<p>Troubleshooting</p>
<ul>
<li>If the attribute stability index appears to be nan, it may due to one of the following reasons: - One metric (
likely to be kurtosis) is nan. For example, the kurtosis of a sample is nan If its standard deviation is 0. - The
mean of a metric from the first to the N-th dataset is zero, causing the denominator of CV to be 0. For example,
when mean of attribute X is always zero for all datasets, its stability index would be nan.</li>
</ul>
<p>Limitation</p>
<ul>
<li>Limitation of CV: CV may not work well when 0 appears in the array or the array contains both positive and
negative values.</li>
</ul>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>spark</code></strong></dt>
<dd>Spark Session</dd>
<dt><strong><code>idfs</code></strong></dt>
<dd>Variable number of input dataframes</dd>
<dt><strong><code>list_of_cols</code></strong></dt>
<dd>List of numerical columns to check stability e.g., ["col1","col2"].
Alternatively, columns can be specified in a string format,
where different column names are separated by pipe delimiter â€œ|â€ e.g., "col1|col2".
"all" can be passed to include all numerical columns for analysis.
Please note that this argument is used in conjunction with drop_cols i.e. a column mentioned in
drop_cols argument is not considered for analysis even if it is mentioned in list_of_cols. (Default value = "all")</dd>
<dt><strong><code>drop_cols</code></strong></dt>
<dd>List of columns to be dropped e.g., ["col1","col2"].
Alternatively, columns can be specified in a string format,
where different column names are separated by pipe delimiter â€œ|â€ e.g., "col1|col2". (Default value = [])</dd>
<dt><strong><code>metric_weightages</code></strong></dt>
<dd>Takes input in dictionary format with keys being the metric name - "mean","stdev","kurtosis"
and value being the weightage of the metric (between 0 and 1). Sum of all weightages must be 1.
(Default value = {"mean": 0.5, "stddev": 0.3, "kurtosis": 0.2})</dd>
<dt><strong><code>binary_cols</code></strong></dt>
<dd>List of numerical columns to be treated as binary columns e.g., ["col1","col2"].
Alternatively, columns can be specified in a string format, where different column names are
separated by pipe delimiter â€œ|â€. For the specified binary columns,
only the mean value will be used as the statistical metric (standard deviation and kurtosis will be skipped).
In addition, standard deviation will be used to measure the stability of mean instead of CV.
(Default value = [])</dd>
<dt><strong><code>existing_metric_path</code></strong></dt>
<dd>This argument is path for referring pre-existing metrics of historical datasets and is
of schema [idx, attribute, mean, stdev, kurtosis].
idx is index number of historical datasets assigned in chronological order. (Default value = "")</dd>
<dt><strong><code>appended_metric_path</code></strong></dt>
<dd>This argument is path for saving input dataframes metrics after appending to the
historical datasets' metrics. (Default value = "")</dd>
<dt><strong><code>persist</code></strong></dt>
<dd>Boolean argument - True or False. This argument is used to determine whether to persist on
binning result of source and target dataset, True will enable the use of persist, otherwise False.
It is recommended to set this as True for large datasets. (Default value = True)</dd>
<dt><strong><code>persist_option</code></strong></dt>
<dd>If persist is True, this argument is used to determine the type of persist.
(Default value = pyspark.StorageLevel.MEMORY_AND_DISK)</dd>
<dt><strong><code>threshold</code></strong></dt>
<dd>A column is flagged if the stability index is below the threshold, which varies between 0 to 4.
The following criteria can be used to classifiy stability_index (SI): very unstable: 0â‰¤SI&lt;1,
unstable: 1â‰¤SI&lt;2, marginally stable: 2â‰¤SI&lt;3, stable: 3â‰¤SI&lt;3.5 and very stable: 3.5â‰¤SIâ‰¤4. (Default value = 1)</dd>
<dt><strong><code>print_impact</code></strong></dt>
<dd>True, False (Default value = False)
This argument is to print out the stability metrics of all attributes and potential unstable attributes.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>DataFrame</code></dt>
<dd>[attribute, mean_stddev, mean_si, stddev_si, kurtosis_si, mean_cv, stddev_cv, kurtosis_cv, stability_index].
<em>_cv is coefficient of variation for each metric. </em>_si is stability index for each metric.
stability_index is net weighted stability index based on the individual metrics' stability index.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span> <span class="nf">stability_index_computation</span><span class="p">(</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="n">spark</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">idfs</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">list_of_cols</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">drop_cols</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">metric_weightages</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;stddev&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;kurtosis&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">binary_cols</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">existing_metric_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">appended_metric_path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="n">persist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">persist_option</span><span class="o">=</span><span class="n">pyspark</span><span class="o">.</span><span class="n">StorageLevel</span><span class="o">.</span><span class="n">MEMORY_AND_DISK</span><span class="p">,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">print_impact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="p">):</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="sd">    The data stability is represented by a single metric to summarise the stability of an attribute over multiple</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="sd">    time periods. For example, given 6 datasets collected in 6 consecutive time periods (D1, D2, â€¦, D6),</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="sd">    data stability index of an attribute measures how stable the attribute is from D1 to D6.</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="sd">    The major difference between data drift and data stability is that data drift analysis is only based on 2</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="sd">    datasets: source and target. However data stability analysis can be performed on multiple datasets. In addition,</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="sd">    the source dataset is not required indicating that the stability index can be directly computed among multiple</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="sd">    target datasets by comparing the statistical properties among them.</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="sd">    In summary, given N datasets representing different time periods, we would like to measure the stability of some</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="sd">    numerical attributes from the first to the N-th dataset.</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="sd">    The whole process can be broken down into 2 steps: (1) Choose a few statistical metrics to describe the</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="sd">    distribution of each attribute at each time period. (2) Compute attribute level stability by combining the</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="sd">    stability of each statistical metric over time periods.</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="sd">    In the first step, we choose mean, standard deviation and kurtosis as the statistical metrics in our</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="sd">    implementation. Intuitively, they represent different aspects of a distribution: mean measures central tendency,</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="sd">    standard deviation measures dispersion and kurtosis measures shape of a distribution. Reasons of selecting those</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="sd">    3 metrics will be explained in a later section. With mean, standard deviation and kurtosis computed for each</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="sd">    attribute at each time interval, we can form 3 arrays of size N for each attribute.</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="sd">    In the second step, Coefficient of Variation (CV) is used to measure the stability of each metric. CV represents</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="sd">    the ratio of the standard deviation to the mean, which is a unitless statistic to compare the relative variation</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="sd">    from one array to another. Considering the wide potential range of CV, the absolute value of CV is then mapped to</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="sd">    an integer between 0 and 4 according to the table below, where 0 indicates highly unstable and 4 indicates highly</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="sd">    stable. We call this integer a metric stability index.</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="sd">    | abs(CV) Interval | Metric Stability Index |</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="sd">    |------------------|------------------------|</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="sd">    | [0, 0.03)        | 4                      |</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="sd">    | [0.03, 0.1)      | 3                      |</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="sd">    | [0.1, 0.2)       | 2                      |</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="sd">    | [0.2, 0.5)       | 1                      |</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a><span class="sd">    | [0.5, +inf)      | 0                      |</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="sd">    Finally, the attribute stability index (SI) is a weighted sum of 3 metric stability indexes, where we assign 50%</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="sd">    for mean, 30% for standard deviation and 20% for kurtosis by default. The final output is a float between 0 and 4 and an</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="sd">    attribute can be classified as one of the following categories: very unstable (0â‰¤SI&lt;1), unstable (1â‰¤SI&lt;2),</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="sd">    marginally stable (2â‰¤SI&lt;3), stable (3â‰¤SI&lt;3.5) and very stable (3.5â‰¤SIâ‰¤4).</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a><span class="sd">    For example, there are 6 samples of attribute X from T1 to T6. For each sample, we have computed the statistical</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="sd">    metrics of X from T1 to T6:</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="sd">    | idx | Mean | Standard deviation | Kurtosis |</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a><span class="sd">    |-----|------|--------------------|----------|</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a><span class="sd">    | 1   | 11   | 2                  | 3.9      |</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a><span class="sd">    | 2   | 12   | 1                  | 4.2      |</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="sd">    | 3   | 15   | 3                  | 4.0      |</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="sd">    | 4   | 10   | 2                  | 4.1      |</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a><span class="sd">    | 5   | 11   | 1                  | 4.2      |</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a><span class="sd">    | 6   | 13   | 0.5                | 4.0      |</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a><span class="sd">    Then we calculate the Coefficient of Variation for each array:</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="sd">    - CV of mean = CV([11, 12, 15, 10, 11, 13]) = 0.136</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a><span class="sd">    - CV of standard deviation = CV([2, 1, 3, 2, 1, 0.5]) = 0.529</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a><span class="sd">    - CV of kurtosis = CV([3.9, 4.2, 4.0, 4.1, 4.2, 4.0]) = 0.027</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a><span class="sd">    Metric stability indexes are then computed by mapping each CV value to an integer accordingly. As a result,</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a><span class="sd">    metric stability index is 2 for mean, 0 for standard deviation and 4 for kurtosis.</span>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a><span class="sd">    Why mean is chosen over median?</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a><span class="sd">    - Dummy variables which take only the value 0 or 1 are frequently seen in machine learning features. Mean of a</span>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a><span class="sd">    dummy variable represents the proportion of value 1 and median of a dummy variable is either 0 or 1 whichever is</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a><span class="sd">    more frequent. However, CV may not work well when 0 appears in the array or the array contains both positive and</span>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a><span class="sd">    negative values. For example, intuitively [0,0,0,0,0,1,0,0,0] is a stable array but its CV is 2.83 which is</span>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a><span class="sd">    extremely high, but cv of [0.45,0.44,0.48,0.49,0.42,0.52,0.49,0.47,0.48] is 0.06 which is much more reasonable.</span>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a><span class="sd">    Thus we decided to use mean instead of median. Although median is considered as a more robust choice,</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a><span class="sd">    outlier treatment can be applied prior to data stability analysis to handle this issue.</span>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a><span class="sd">    Why kurtosis is chosen over skewness?</span>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a><span class="sd">    - Kurtosis is a positive value (note that we use kurtosis instead of excess kurtosis which) but skewness can</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a><span class="sd">    range from â€“inf to +inf. Usually, if skewness is between -0.5 and 0.5, the distribution is approximately</span>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a><span class="sd">    symmetric. Thus, if the skewness fluctuates around 0, the CV is highly likely to be high or invalid because the</span>
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a><span class="sd">    mean will be close to 0.</span>
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a><span class="sd">    Stability index is preferred in the following scenario:</span>
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a><span class="sd">    - Pairwise drift analysis can be performed between the source dataset and each of the target dataset to quantify</span>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a><span class="sd">    the drift over time. However this can be time-consuming especially when the number of target dataset is large. In</span>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a><span class="sd">    this case, measuring data stability instead of data drift would be a much faster alternative and the</span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a><span class="sd">    source/baseline dataset is not required as well</span>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a><span class="sd">    Troubleshooting</span>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a><span class="sd">    - If the attribute stability index appears to be nan, it may due to one of the following reasons: - One metric (</span>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a><span class="sd">    likely to be kurtosis) is nan. For example, the kurtosis of a sample is nan If its standard deviation is 0. - The</span>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a><span class="sd">    mean of a metric from the first to the N-th dataset is zero, causing the denominator of CV to be 0. For example,</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a><span class="sd">    when mean of attribute X is always zero for all datasets, its stability index would be nan.</span>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a><span class="sd">    Limitation</span>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a><span class="sd">    - Limitation of CV: CV may not work well when 0 appears in the array or the array contains both positive and</span>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a><span class="sd">    negative values.</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a><span class="sd">    Parameters</span>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a><span class="sd">    ----------</span>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a><span class="sd">    spark</span>
<a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a><span class="sd">        Spark Session</span>
<a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a><span class="sd">    idfs</span>
<a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a><span class="sd">        Variable number of input dataframes</span>
<a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a><span class="sd">    list_of_cols</span>
<a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a><span class="sd">        List of numerical columns to check stability e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a><span class="sd">        Alternatively, columns can be specified in a string format,</span>
<a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a><span class="sd">        where different column names are separated by pipe delimiter â€œ|â€ e.g., &quot;col1|col2&quot;.</span>
<a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a><span class="sd">        &quot;all&quot; can be passed to include all numerical columns for analysis.</span>
<a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a><span class="sd">        Please note that this argument is used in conjunction with drop_cols i.e. a column mentioned in</span>
<a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a><span class="sd">        drop_cols argument is not considered for analysis even if it is mentioned in list_of_cols. (Default value = &quot;all&quot;)</span>
<a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a><span class="sd">    drop_cols</span>
<a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a><span class="sd">        List of columns to be dropped e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a><span class="sd">        Alternatively, columns can be specified in a string format,</span>
<a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a><span class="sd">        where different column names are separated by pipe delimiter â€œ|â€ e.g., &quot;col1|col2&quot;. (Default value = [])</span>
<a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a><span class="sd">    metric_weightages</span>
<a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a><span class="sd">        Takes input in dictionary format with keys being the metric name - &quot;mean&quot;,&quot;stdev&quot;,&quot;kurtosis&quot;</span>
<a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a><span class="sd">        and value being the weightage of the metric (between 0 and 1). Sum of all weightages must be 1.</span>
<a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a><span class="sd">        (Default value = {&quot;mean&quot;: 0.5, &quot;stddev&quot;: 0.3, &quot;kurtosis&quot;: 0.2})</span>
<a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a><span class="sd">    binary_cols</span>
<a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a><span class="sd">        List of numerical columns to be treated as binary columns e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a><span class="sd">        Alternatively, columns can be specified in a string format, where different column names are</span>
<a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a><span class="sd">        separated by pipe delimiter â€œ|â€. For the specified binary columns,</span>
<a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a><span class="sd">        only the mean value will be used as the statistical metric (standard deviation and kurtosis will be skipped).</span>
<a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a><span class="sd">        In addition, standard deviation will be used to measure the stability of mean instead of CV.</span>
<a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a><span class="sd">        (Default value = [])</span>
<a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a><span class="sd">    existing_metric_path</span>
<a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a><span class="sd">        This argument is path for referring pre-existing metrics of historical datasets and is</span>
<a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a><span class="sd">        of schema [idx, attribute, mean, stdev, kurtosis].</span>
<a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a><span class="sd">        idx is index number of historical datasets assigned in chronological order. (Default value = &quot;&quot;)</span>
<a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a><span class="sd">    appended_metric_path</span>
<a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a><span class="sd">        This argument is path for saving input dataframes metrics after appending to the</span>
<a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a><span class="sd">        historical datasets&#39; metrics. (Default value = &quot;&quot;)</span>
<a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a><span class="sd">    persist</span>
<a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a><span class="sd">        Boolean argument - True or False. This argument is used to determine whether to persist on</span>
<a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a><span class="sd">        binning result of source and target dataset, True will enable the use of persist, otherwise False.</span>
<a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a><span class="sd">        It is recommended to set this as True for large datasets. (Default value = True)</span>
<a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a><span class="sd">    persist_option</span>
<a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a><span class="sd">        If persist is True, this argument is used to determine the type of persist.</span>
<a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a><span class="sd">        (Default value = pyspark.StorageLevel.MEMORY_AND_DISK)</span>
<a id="__codelineno-2-157" name="__codelineno-2-157" href="#__codelineno-2-157"></a><span class="sd">    threshold</span>
<a id="__codelineno-2-158" name="__codelineno-2-158" href="#__codelineno-2-158"></a><span class="sd">        A column is flagged if the stability index is below the threshold, which varies between 0 to 4.</span>
<a id="__codelineno-2-159" name="__codelineno-2-159" href="#__codelineno-2-159"></a><span class="sd">        The following criteria can be used to classifiy stability_index (SI): very unstable: 0â‰¤SI&lt;1,</span>
<a id="__codelineno-2-160" name="__codelineno-2-160" href="#__codelineno-2-160"></a><span class="sd">        unstable: 1â‰¤SI&lt;2, marginally stable: 2â‰¤SI&lt;3, stable: 3â‰¤SI&lt;3.5 and very stable: 3.5â‰¤SIâ‰¤4. (Default value = 1)</span>
<a id="__codelineno-2-161" name="__codelineno-2-161" href="#__codelineno-2-161"></a><span class="sd">    print_impact</span>
<a id="__codelineno-2-162" name="__codelineno-2-162" href="#__codelineno-2-162"></a><span class="sd">        True, False (Default value = False)</span>
<a id="__codelineno-2-163" name="__codelineno-2-163" href="#__codelineno-2-163"></a><span class="sd">        This argument is to print out the stability metrics of all attributes and potential unstable attributes.</span>
<a id="__codelineno-2-164" name="__codelineno-2-164" href="#__codelineno-2-164"></a>
<a id="__codelineno-2-165" name="__codelineno-2-165" href="#__codelineno-2-165"></a><span class="sd">    Returns</span>
<a id="__codelineno-2-166" name="__codelineno-2-166" href="#__codelineno-2-166"></a><span class="sd">    -------</span>
<a id="__codelineno-2-167" name="__codelineno-2-167" href="#__codelineno-2-167"></a><span class="sd">    DataFrame</span>
<a id="__codelineno-2-168" name="__codelineno-2-168" href="#__codelineno-2-168"></a><span class="sd">        [attribute, mean_stddev, mean_si, stddev_si, kurtosis_si, mean_cv, stddev_cv, kurtosis_cv, stability_index].</span>
<a id="__codelineno-2-169" name="__codelineno-2-169" href="#__codelineno-2-169"></a><span class="sd">        *_cv is coefficient of variation for each metric. *_si is stability index for each metric.</span>
<a id="__codelineno-2-170" name="__codelineno-2-170" href="#__codelineno-2-170"></a><span class="sd">        stability_index is net weighted stability index based on the individual metrics&#39; stability index.</span>
<a id="__codelineno-2-171" name="__codelineno-2-171" href="#__codelineno-2-171"></a>
<a id="__codelineno-2-172" name="__codelineno-2-172" href="#__codelineno-2-172"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-173" name="__codelineno-2-173" href="#__codelineno-2-173"></a>
<a id="__codelineno-2-174" name="__codelineno-2-174" href="#__codelineno-2-174"></a>    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">attributeType_segregation</span><span class="p">(</span><span class="n">idfs</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-175" name="__codelineno-2-175" href="#__codelineno-2-175"></a>    <span class="k">if</span> <span class="n">list_of_cols</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
<a id="__codelineno-2-176" name="__codelineno-2-176" href="#__codelineno-2-176"></a>        <span class="n">list_of_cols</span> <span class="o">=</span> <span class="n">num_cols</span>
<a id="__codelineno-2-177" name="__codelineno-2-177" href="#__codelineno-2-177"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-2-178" name="__codelineno-2-178" href="#__codelineno-2-178"></a>        <span class="n">list_of_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-2-179" name="__codelineno-2-179" href="#__codelineno-2-179"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-2-180" name="__codelineno-2-180" href="#__codelineno-2-180"></a>        <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">drop_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-2-181" name="__codelineno-2-181" href="#__codelineno-2-181"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-2-182" name="__codelineno-2-182" href="#__codelineno-2-182"></a>        <span class="n">binary_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">binary_cols</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)]</span>
<a id="__codelineno-2-183" name="__codelineno-2-183" href="#__codelineno-2-183"></a>
<a id="__codelineno-2-184" name="__codelineno-2-184" href="#__codelineno-2-184"></a>    <span class="n">list_of_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">list_of_cols</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_cols</span><span class="p">]))</span>
<a id="__codelineno-2-185" name="__codelineno-2-185" href="#__codelineno-2-185"></a>
<a id="__codelineno-2-186" name="__codelineno-2-186" href="#__codelineno-2-186"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">num_cols</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_of_cols</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-2-187" name="__codelineno-2-187" href="#__codelineno-2-187"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input for Column(s)&quot;</span><span class="p">)</span>
<a id="__codelineno-2-188" name="__codelineno-2-188" href="#__codelineno-2-188"></a>
<a id="__codelineno-2-189" name="__codelineno-2-189" href="#__codelineno-2-189"></a>    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list_of_cols</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">binary_cols</span><span class="p">):</span>
<a id="__codelineno-2-190" name="__codelineno-2-190" href="#__codelineno-2-190"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid input for Binary Column(s)&quot;</span><span class="p">)</span>
<a id="__codelineno-2-191" name="__codelineno-2-191" href="#__codelineno-2-191"></a>
<a id="__codelineno-2-192" name="__codelineno-2-192" href="#__codelineno-2-192"></a>    <span class="n">check_metric_weightages</span><span class="p">(</span><span class="n">metric_weightages</span><span class="p">)</span>
<a id="__codelineno-2-193" name="__codelineno-2-193" href="#__codelineno-2-193"></a>    <span class="n">check_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-2-194" name="__codelineno-2-194" href="#__codelineno-2-194"></a>
<a id="__codelineno-2-195" name="__codelineno-2-195" href="#__codelineno-2-195"></a>    <span class="k">if</span> <span class="n">existing_metric_path</span><span class="p">:</span>
<a id="__codelineno-2-196" name="__codelineno-2-196" href="#__codelineno-2-196"></a>        <span class="n">existing_metric_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span>
<a id="__codelineno-2-197" name="__codelineno-2-197" href="#__codelineno-2-197"></a>            <span class="n">existing_metric_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inferSchema</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-2-198" name="__codelineno-2-198" href="#__codelineno-2-198"></a>        <span class="p">)</span>
<a id="__codelineno-2-199" name="__codelineno-2-199" href="#__codelineno-2-199"></a>        <span class="n">dfs_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">existing_metric_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-2-200" name="__codelineno-2-200" href="#__codelineno-2-200"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-201" name="__codelineno-2-201" href="#__codelineno-2-201"></a>        <span class="n">existing_metric_df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-202" name="__codelineno-2-202" href="#__codelineno-2-202"></a>        <span class="n">dfs_count</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-2-203" name="__codelineno-2-203" href="#__codelineno-2-203"></a>
<a id="__codelineno-2-204" name="__codelineno-2-204" href="#__codelineno-2-204"></a>    <span class="k">def</span> <span class="nf">unionAll</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
<a id="__codelineno-2-205" name="__codelineno-2-205" href="#__codelineno-2-205"></a>        <span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">dfs</span>
<a id="__codelineno-2-206" name="__codelineno-2-206" href="#__codelineno-2-206"></a>        <span class="k">return</span> <span class="n">first</span><span class="o">.</span><span class="n">sql_ctx</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span>
<a id="__codelineno-2-207" name="__codelineno-2-207" href="#__codelineno-2-207"></a>            <span class="n">first</span><span class="o">.</span><span class="n">sql_ctx</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">rdd</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]),</span> <span class="n">first</span><span class="o">.</span><span class="n">schema</span>
<a id="__codelineno-2-208" name="__codelineno-2-208" href="#__codelineno-2-208"></a>        <span class="p">)</span>
<a id="__codelineno-2-209" name="__codelineno-2-209" href="#__codelineno-2-209"></a>
<a id="__codelineno-2-210" name="__codelineno-2-210" href="#__codelineno-2-210"></a>    <span class="k">if</span> <span class="n">persist</span><span class="p">:</span>
<a id="__codelineno-2-211" name="__codelineno-2-211" href="#__codelineno-2-211"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idfs</span><span class="p">)):</span>
<a id="__codelineno-2-212" name="__codelineno-2-212" href="#__codelineno-2-212"></a>            <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">)</span>
<a id="__codelineno-2-213" name="__codelineno-2-213" href="#__codelineno-2-213"></a>            <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">persist_option</span><span class="p">)</span>
<a id="__codelineno-2-214" name="__codelineno-2-214" href="#__codelineno-2-214"></a>
<a id="__codelineno-2-215" name="__codelineno-2-215" href="#__codelineno-2-215"></a>    <span class="n">list_temp_all_col</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-216" name="__codelineno-2-216" href="#__codelineno-2-216"></a>    <span class="k">if</span> <span class="n">appended_metric_path</span><span class="p">:</span>
<a id="__codelineno-2-217" name="__codelineno-2-217" href="#__codelineno-2-217"></a>        <span class="n">list_append_all</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-218" name="__codelineno-2-218" href="#__codelineno-2-218"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">list_of_cols</span><span class="p">:</span>
<a id="__codelineno-2-219" name="__codelineno-2-219" href="#__codelineno-2-219"></a>        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">binary_cols</span><span class="p">:</span>
<a id="__codelineno-2-220" name="__codelineno-2-220" href="#__codelineno-2-220"></a>            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;Binary&quot;</span>
<a id="__codelineno-2-221" name="__codelineno-2-221" href="#__codelineno-2-221"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-222" name="__codelineno-2-222" href="#__codelineno-2-222"></a>            <span class="n">col_type</span> <span class="o">=</span> <span class="s2">&quot;Numerical&quot;</span>
<a id="__codelineno-2-223" name="__codelineno-2-223" href="#__codelineno-2-223"></a>        <span class="n">count_idf</span> <span class="o">=</span> <span class="n">dfs_count</span>
<a id="__codelineno-2-224" name="__codelineno-2-224" href="#__codelineno-2-224"></a>        <span class="n">list_temp_col_in_idf</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-225" name="__codelineno-2-225" href="#__codelineno-2-225"></a>        <span class="k">for</span> <span class="n">idf</span> <span class="ow">in</span> <span class="n">idfs</span><span class="p">:</span>
<a id="__codelineno-2-226" name="__codelineno-2-226" href="#__codelineno-2-226"></a>            <span class="n">df_stat_each</span> <span class="o">=</span> <span class="n">idf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-2-227" name="__codelineno-2-227" href="#__codelineno-2-227"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">),</span>
<a id="__codelineno-2-228" name="__codelineno-2-228" href="#__codelineno-2-228"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-2-229" name="__codelineno-2-229" href="#__codelineno-2-229"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">),</span>
<a id="__codelineno-2-230" name="__codelineno-2-230" href="#__codelineno-2-230"></a>            <span class="p">)</span>
<a id="__codelineno-2-231" name="__codelineno-2-231" href="#__codelineno-2-231"></a>            <span class="n">list_temp_col_in_idf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stat_each</span><span class="p">)</span>
<a id="__codelineno-2-232" name="__codelineno-2-232" href="#__codelineno-2-232"></a>            <span class="k">if</span> <span class="n">appended_metric_path</span><span class="p">:</span>
<a id="__codelineno-2-233" name="__codelineno-2-233" href="#__codelineno-2-233"></a>                <span class="n">df_append_single</span> <span class="o">=</span> <span class="n">df_stat_each</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-2-234" name="__codelineno-2-234" href="#__codelineno-2-234"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count_idf</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">),</span>
<a id="__codelineno-2-235" name="__codelineno-2-235" href="#__codelineno-2-235"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">),</span>
<a id="__codelineno-2-236" name="__codelineno-2-236" href="#__codelineno-2-236"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">col_type</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
<a id="__codelineno-2-237" name="__codelineno-2-237" href="#__codelineno-2-237"></a>                    <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<a id="__codelineno-2-238" name="__codelineno-2-238" href="#__codelineno-2-238"></a>                    <span class="s2">&quot;stddev&quot;</span><span class="p">,</span>
<a id="__codelineno-2-239" name="__codelineno-2-239" href="#__codelineno-2-239"></a>                    <span class="s2">&quot;kurtosis&quot;</span><span class="p">,</span>
<a id="__codelineno-2-240" name="__codelineno-2-240" href="#__codelineno-2-240"></a>                <span class="p">)</span>
<a id="__codelineno-2-241" name="__codelineno-2-241" href="#__codelineno-2-241"></a>                <span class="n">list_append_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_append_single</span><span class="p">)</span>
<a id="__codelineno-2-242" name="__codelineno-2-242" href="#__codelineno-2-242"></a>                <span class="n">count_idf</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-2-243" name="__codelineno-2-243" href="#__codelineno-2-243"></a>        <span class="k">if</span> <span class="n">existing_metric_df</span><span class="p">:</span>
<a id="__codelineno-2-244" name="__codelineno-2-244" href="#__codelineno-2-244"></a>            <span class="n">existing_df_for_single_col</span> <span class="o">=</span> <span class="n">existing_metric_df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-2-245" name="__codelineno-2-245" href="#__codelineno-2-245"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-2-246" name="__codelineno-2-246" href="#__codelineno-2-246"></a>            <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;stddev&quot;</span><span class="p">,</span> <span class="s2">&quot;kurtosis&quot;</span><span class="p">)</span>
<a id="__codelineno-2-247" name="__codelineno-2-247" href="#__codelineno-2-247"></a>            <span class="k">if</span> <span class="n">existing_df_for_single_col</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-248" name="__codelineno-2-248" href="#__codelineno-2-248"></a>                <span class="n">list_temp_col_in_idf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">existing_df_for_single_col</span><span class="p">)</span>
<a id="__codelineno-2-249" name="__codelineno-2-249" href="#__codelineno-2-249"></a>        <span class="n">df_stat_col</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-2-250" name="__codelineno-2-250" href="#__codelineno-2-250"></a>            <span class="n">unionAll</span><span class="p">(</span><span class="n">list_temp_col_in_idf</span><span class="p">)</span>
<a id="__codelineno-2-251" name="__codelineno-2-251" href="#__codelineno-2-251"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-2-252" name="__codelineno-2-252" href="#__codelineno-2-252"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;std_of_mean&quot;</span><span class="p">),</span>
<a id="__codelineno-2-253" name="__codelineno-2-253" href="#__codelineno-2-253"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_of_mean&quot;</span><span class="p">),</span>
<a id="__codelineno-2-254" name="__codelineno-2-254" href="#__codelineno-2-254"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;std_of_stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-2-255" name="__codelineno-2-255" href="#__codelineno-2-255"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_of_stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-2-256" name="__codelineno-2-256" href="#__codelineno-2-256"></a>                <span class="n">F</span><span class="o">.</span><span class="n">stddev</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;std_of_kurtosis&quot;</span><span class="p">),</span>
<a id="__codelineno-2-257" name="__codelineno-2-257" href="#__codelineno-2-257"></a>                <span class="n">F</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;kurtosis&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_of_kurtosis&quot;</span><span class="p">),</span>
<a id="__codelineno-2-258" name="__codelineno-2-258" href="#__codelineno-2-258"></a>            <span class="p">)</span>
<a id="__codelineno-2-259" name="__codelineno-2-259" href="#__codelineno-2-259"></a>            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-2-260" name="__codelineno-2-260" href="#__codelineno-2-260"></a>                <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;attribute&quot;</span><span class="p">),</span>
<a id="__codelineno-2-261" name="__codelineno-2-261" href="#__codelineno-2-261"></a>                <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">col_type</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
<a id="__codelineno-2-262" name="__codelineno-2-262" href="#__codelineno-2-262"></a>                <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_mean&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_stddev&quot;</span><span class="p">),</span>
<a id="__codelineno-2-263" name="__codelineno-2-263" href="#__codelineno-2-263"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_mean&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_of_mean&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">),</span>
<a id="__codelineno-2-264" name="__codelineno-2-264" href="#__codelineno-2-264"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_stddev&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_of_stddev&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">),</span>
<a id="__codelineno-2-265" name="__codelineno-2-265" href="#__codelineno-2-265"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;std_of_kurtosis&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_of_kurtosis&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
<a id="__codelineno-2-266" name="__codelineno-2-266" href="#__codelineno-2-266"></a>                    <span class="s2">&quot;kurtosis_cv&quot;</span>
<a id="__codelineno-2-267" name="__codelineno-2-267" href="#__codelineno-2-267"></a>                <span class="p">),</span>
<a id="__codelineno-2-268" name="__codelineno-2-268" href="#__codelineno-2-268"></a>            <span class="p">)</span>
<a id="__codelineno-2-269" name="__codelineno-2-269" href="#__codelineno-2-269"></a>        <span class="p">)</span>
<a id="__codelineno-2-270" name="__codelineno-2-270" href="#__codelineno-2-270"></a>        <span class="n">list_temp_all_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_stat_col</span><span class="p">)</span>
<a id="__codelineno-2-271" name="__codelineno-2-271" href="#__codelineno-2-271"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="n">unionAll</span><span class="p">(</span><span class="n">list_temp_all_col</span><span class="p">)</span>
<a id="__codelineno-2-272" name="__codelineno-2-272" href="#__codelineno-2-272"></a>    <span class="k">if</span> <span class="n">appended_metric_path</span><span class="p">:</span>
<a id="__codelineno-2-273" name="__codelineno-2-273" href="#__codelineno-2-273"></a>        <span class="k">if</span> <span class="n">existing_metric_df</span><span class="p">:</span>
<a id="__codelineno-2-274" name="__codelineno-2-274" href="#__codelineno-2-274"></a>            <span class="n">list_append_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">existing_metric_df</span><span class="p">)</span>
<a id="__codelineno-2-275" name="__codelineno-2-275" href="#__codelineno-2-275"></a>        <span class="n">df_append</span> <span class="o">=</span> <span class="n">unionAll</span><span class="p">(</span><span class="n">list_append_all</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">))</span>
<a id="__codelineno-2-276" name="__codelineno-2-276" href="#__codelineno-2-276"></a>        <span class="n">df_append</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span>
<a id="__codelineno-2-277" name="__codelineno-2-277" href="#__codelineno-2-277"></a>            <span class="n">appended_metric_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span>
<a id="__codelineno-2-278" name="__codelineno-2-278" href="#__codelineno-2-278"></a>        <span class="p">)</span>
<a id="__codelineno-2-279" name="__codelineno-2-279" href="#__codelineno-2-279"></a>
<a id="__codelineno-2-280" name="__codelineno-2-280" href="#__codelineno-2-280"></a>    <span class="n">f_compute_si</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">udf</span><span class="p">(</span><span class="n">compute_si</span><span class="p">(</span><span class="n">metric_weightages</span><span class="p">),</span> <span class="n">T</span><span class="o">.</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">FloatType</span><span class="p">()))</span>
<a id="__codelineno-2-281" name="__codelineno-2-281" href="#__codelineno-2-281"></a>
<a id="__codelineno-2-282" name="__codelineno-2-282" href="#__codelineno-2-282"></a>    <span class="n">odf</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-2-283" name="__codelineno-2-283" href="#__codelineno-2-283"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-2-284" name="__codelineno-2-284" href="#__codelineno-2-284"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-2-285" name="__codelineno-2-285" href="#__codelineno-2-285"></a>            <span class="s2">&quot;si_array&quot;</span><span class="p">,</span>
<a id="__codelineno-2-286" name="__codelineno-2-286" href="#__codelineno-2-286"></a>            <span class="n">f_compute_si</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_stddev&quot;</span><span class="p">,</span> <span class="s2">&quot;mean_cv&quot;</span><span class="p">,</span> <span class="s2">&quot;stddev_cv&quot;</span><span class="p">,</span> <span class="s2">&quot;kurtosis_cv&quot;</span><span class="p">),</span>
<a id="__codelineno-2-287" name="__codelineno-2-287" href="#__codelineno-2-287"></a>        <span class="p">)</span>
<a id="__codelineno-2-288" name="__codelineno-2-288" href="#__codelineno-2-288"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_si&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-2-289" name="__codelineno-2-289" href="#__codelineno-2-289"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stddev_si&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-290" name="__codelineno-2-290" href="#__codelineno-2-290"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;kurtosis_si&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-2-291" name="__codelineno-2-291" href="#__codelineno-2-291"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stability_index&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-2-292" name="__codelineno-2-292" href="#__codelineno-2-292"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-2-293" name="__codelineno-2-293" href="#__codelineno-2-293"></a>            <span class="s2">&quot;flagged&quot;</span><span class="p">,</span>
<a id="__codelineno-2-294" name="__codelineno-2-294" href="#__codelineno-2-294"></a>            <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
<a id="__codelineno-2-295" name="__codelineno-2-295" href="#__codelineno-2-295"></a>                <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
<a id="__codelineno-2-296" name="__codelineno-2-296" href="#__codelineno-2-296"></a>                <span class="o">|</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stability_index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()),</span>
<a id="__codelineno-2-297" name="__codelineno-2-297" href="#__codelineno-2-297"></a>                <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-298" name="__codelineno-2-298" href="#__codelineno-2-298"></a>            <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-2-299" name="__codelineno-2-299" href="#__codelineno-2-299"></a>        <span class="p">)</span>
<a id="__codelineno-2-300" name="__codelineno-2-300" href="#__codelineno-2-300"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_stddev&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_stddev&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-2-301" name="__codelineno-2-301" href="#__codelineno-2-301"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;mean_cv&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-2-302" name="__codelineno-2-302" href="#__codelineno-2-302"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;stddev_cv&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-2-303" name="__codelineno-2-303" href="#__codelineno-2-303"></a>        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;kurtosis_cv&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kurtosis_cv&quot;</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<a id="__codelineno-2-304" name="__codelineno-2-304" href="#__codelineno-2-304"></a>        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;si_array&quot;</span><span class="p">)</span>
<a id="__codelineno-2-305" name="__codelineno-2-305" href="#__codelineno-2-305"></a>    <span class="p">)</span>
<a id="__codelineno-2-306" name="__codelineno-2-306" href="#__codelineno-2-306"></a>
<a id="__codelineno-2-307" name="__codelineno-2-307" href="#__codelineno-2-307"></a>    <span class="k">if</span> <span class="n">print_impact</span><span class="p">:</span>
<a id="__codelineno-2-308" name="__codelineno-2-308" href="#__codelineno-2-308"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Attributes:&quot;</span><span class="p">)</span>
<a id="__codelineno-2-309" name="__codelineno-2-309" href="#__codelineno-2-309"></a>        <span class="n">odf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_of_cols</span><span class="p">))</span>
<a id="__codelineno-2-310" name="__codelineno-2-310" href="#__codelineno-2-310"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Potential Unstable Attributes:&quot;</span><span class="p">)</span>
<a id="__codelineno-2-311" name="__codelineno-2-311" href="#__codelineno-2-311"></a>        <span class="n">unstable</span> <span class="o">=</span> <span class="n">odf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;flagged&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-312" name="__codelineno-2-312" href="#__codelineno-2-312"></a>        <span class="n">unstable</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">unstable</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<a id="__codelineno-2-313" name="__codelineno-2-313" href="#__codelineno-2-313"></a>
<a id="__codelineno-2-314" name="__codelineno-2-314" href="#__codelineno-2-314"></a>    <span class="k">if</span> <span class="n">persist</span><span class="p">:</span>
<a id="__codelineno-2-315" name="__codelineno-2-315" href="#__codelineno-2-315"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idfs</span><span class="p">)):</span>
<a id="__codelineno-2-316" name="__codelineno-2-316" href="#__codelineno-2-316"></a>            <span class="n">idfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
<a id="__codelineno-2-317" name="__codelineno-2-317" href="#__codelineno-2-317"></a>
<a id="__codelineno-2-318" name="__codelineno-2-318" href="#__codelineno-2-318"></a>    <span class="k">return</span> <span class="n">odf</span>
</code></pre></div>
</pre>
</details>
</dd>
</dl>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="drift_detector.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: &lt;code&gt;drift_detector&lt;/code&gt;" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              <code>drift_detector</code>
            </div>
          </div>
        </a>
      
      
        
        <a href="validations.html" class="md-footer__link md-footer__link--next" aria-label="Next: &lt;code&gt;validations&lt;/code&gt;" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              <code>validations</code>
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/anovos" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://join.slack.com/t/featureengineers/shared_invite/zt-17pkc3f5d-33SUtV8Wx48CpiIRNuQ7JA" target="_blank" rel="noopener" title="join.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/anovos" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
  </body>
</html>