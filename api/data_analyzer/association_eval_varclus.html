
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Stable Features yield Resilient Models. Documentation for the Feature Engineering Library Anovos.">
      
      
        <meta name="author" content="Anovos Developers, Mobilewalla">
      
      
        <link rel="canonical" href="https://docs.anovos.ai/api/data_analyzer/association_eval_varclus.html">
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>association_eval_varclus - Anovos Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-52258647-20","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");ga("send","event","feedback","click",t,e),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){ga("send","pageview",e.pathname)})});var e=document.createElement("script");e.async=!0,e.src="https://www.google-analytics.com/analytics.js",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
<!-- Extra styles for API docs, cf. https://github.com/pdoc3/pdoc/blob/master/pdoc/templates/html.mako -->
<link rel="preload stylesheet" as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css"
      integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css"
      integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/${hljs_style}.min.css" crossorigin>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"
        integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>

<!-- Extra style sheets (can't be set in mkdocs.yml due to content hash) -->
<link
        rel="stylesheet"
        href="../../assets/stylesheets/main.css"
/>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#association_eval_varclus" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
<a href="https://join.slack.com/t/featureengineers/shared_invite/zt-17pkc3f5d-33SUtV8Wx48CpiIRNuQ7JA" style="color: white;">
      <span class="twemoji fa-slack">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </span>
    Join us in the <strong>#anovos</strong> channel on the <em>Feature Engineers Community Slack!</em>
</a>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="Anovos Documentation" class="md-header__button md-logo" aria-label="Anovos Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Anovos Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              <code>association_eval_varclus</code>
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a
  href="https://github.com/anovos/anovos"
  title="Go to repository"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    anovos/anovos
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="Anovos Documentation" class="md-nav__button md-logo" aria-label="Anovos Documentation" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Anovos Documentation
  </label>
  
    <div class="md-nav__source">
      <a
  href="https://github.com/anovos/anovos"
  title="Go to repository"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    anovos/anovos
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about.html" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started.html" class="md-nav__link">
        Getting Started 🚀
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Using Anovos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Using Anovos" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Using Anovos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Setting up
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Setting up" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Setting up
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/locally.html" class="md-nav__link">
        Locally
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_aws.html" class="md-nav__link">
        On AWS EMR
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_azure_databricks.html" class="md-nav__link">
        On Azure Databricks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_aks.html" class="md-nav__link">
        On Azure Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/on_google_colab.html" class="md-nav__link">
        On Google Colab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/setting-up/spark_cluster.html" class="md-nav__link">
        On a Spark cluster
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/workflow.html" class="md-nav__link">
        Workflow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/config_file.html" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Data Reports
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Data Reports" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Data Reports
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/overview.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/intermediate_report.html" class="md-nav__link">
        Intermediate Report
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/final_report.html" class="md-nav__link">
        Final Report
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/data-reports/html_report.html" class="md-nav__link">
        HTML Report
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/feature_mapper.html" class="md-nav__link">
        Feature Mapper
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/mlflow.html" class="md-nav__link">
        MLflow Integration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/feature_store.html" class="md-nav__link">
        Feature Store Integration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/scaling.html" class="md-nav__link">
        Scaling Up
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/limitations.html" class="md-nav__link">
        Limitations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../using-anovos/roadmap.html" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Community
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Community" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Community
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../community/contributing.html" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../community/communication.html" class="md-nav__link">
        Communication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../community/code-of-conduct.html" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          API Docs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Docs" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          API Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../workflow.html" class="md-nav__link">
        <code>workflow</code>
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6_3">
          data_analyzer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_analyzer" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          data_analyzer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          <code>association_eval_varclus</code>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="association_eval_varclus.html" class="md-nav__link md-nav__link--active">
        <code>association_eval_varclus</code>
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="association_evaluator.html" class="md-nav__link">
        <code>association_evaluator</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="geospatial_analyzer.html" class="md-nav__link">
        <code>geospatial_analyzer</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="quality_checker.html" class="md-nav__link">
        <code>quality_checker</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="stats_generator.html" class="md-nav__link">
        <code>stats_generator</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ts_analyzer.html" class="md-nav__link">
        <code>ts_analyzer</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_4">
          data_ingest
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_ingest" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          data_ingest
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/data_ingest.html" class="md-nav__link">
        <code>data_ingest</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/data_sampling.html" class="md-nav__link">
        <code>data_sampling</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/geo_auto_detection.html" class="md-nav__link">
        <code>geo_auto_detection</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_ingest/ts_auto_detection.html" class="md-nav__link">
        <code>ts_auto_detection</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_5" type="checkbox" id="__nav_6_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_5">
          data_report
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_report" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_5">
          <span class="md-nav__icon md-icon"></span>
          data_report
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/basic_report_generation.html" class="md-nav__link">
        <code>basic_report_generation</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/report_generation.html" class="md-nav__link">
        <code>report_generation</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_report/report_preprocessing.html" class="md-nav__link">
        <code>report_preprocessing</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_6" type="checkbox" id="__nav_6_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_6">
          data_transformer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="data_transformer" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_6">
          <span class="md-nav__icon md-icon"></span>
          data_transformer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/datetime.html" class="md-nav__link">
        <code>datetime</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/geo_utils.html" class="md-nav__link">
        <code>geo_utils</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/geospatial.html" class="md-nav__link">
        <code>geospatial</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_transformer/transformers.html" class="md-nav__link">
        <code>transformers</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_7" type="checkbox" id="__nav_6_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_7">
          drift_stability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="drift_stability" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_7">
          <span class="md-nav__icon md-icon"></span>
          drift_stability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../drift_stability/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../drift_stability/drift_detector.html" class="md-nav__link">
        <code>drift_detector</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../drift_stability/stability.html" class="md-nav__link">
        <code>stability</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../drift_stability/validations.html" class="md-nav__link">
        <code>validations</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_8" type="checkbox" id="__nav_6_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_8">
          feature_recommender
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="feature_recommender" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_8">
          <span class="md-nav__icon md-icon"></span>
          feature_recommender
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/featrec_init.html" class="md-nav__link">
        <code>featrec_init</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/feature_explorer.html" class="md-nav__link">
        <code>feature_explorer</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_recommender/feature_mapper.html" class="md-nav__link">
        <code>feature_mapper</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_9" type="checkbox" id="__nav_6_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_9">
          feature_store
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="feature_store" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_9">
          <span class="md-nav__icon md-icon"></span>
          feature_store
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_store/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_store/feast_exporter.html" class="md-nav__link">
        <code>feast_exporter</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_store/feature_retrieval.html" class="md-nav__link">
        <code>feature_retrieval</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_10" type="checkbox" id="__nav_6_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_10">
          shared
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="shared" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_10">
          <span class="md-nav__icon md-icon"></span>
          shared
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shared/_index.html" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shared/spark.html" class="md-nav__link">
        <code>spark</code>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../shared/utils.html" class="md-nav__link">
        <code>utils</code>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../license.html" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/anovos/anovos-docs/edit/main/docs/api/data_analyzer/association_eval_varclus.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="association_eval_varclus"><code>association_eval_varclus</code></h1>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">VectorAssembler</span><span class="p">,</span> <span class="n">StandardScaler</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span> <span class="nn">pyspark.mllib.linalg.distributed</span> <span class="kn">import</span> <span class="n">RowMatrix</span><span class="p">,</span> <span class="n">DenseMatrix</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">math</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span> <span class="nn">collections</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">from</span> <span class="nn">factor_analyzer</span> <span class="kn">import</span> <span class="n">Rotator</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">import</span> <span class="nn">random</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="k">class</span> <span class="nc">VarClusHiSpark</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="sd">    This class is a scalable version of [VarClusHi] [2] library to perform variable clustering on PySpark dataframes</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="sd">    with necessary optimizations, and sampling is not required.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="sd">    [2]: https://github.com/jingtt/varclushi   &quot;VarCluShi&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">    Variable Clustering groups attributes that are as correlated as possible among themselves within a cluster and as</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">    uncorrelated as possible with attribute in other clusters. By default, it begins with all variables in a single cluster.</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="sd">    It then repeats the following steps:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">    1. A cluster is chosen for splitting. This cluster has the largest eigenvalue associated with the 2nd PC</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">    2. Find the first 2 PCs of the chosen cluster and split into 2 clusters, then perform an orthoblique rotation</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">    (raw quartimax rotation on the eigenvectors)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="sd">    3. Variables are iteratively re-assigned to clusters to maximize the variance:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="sd">        (a) Nearest Component Sorting (NCS) Phase: In each iteration, the cluster components are computed.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="sd">        Each variable is assigned to the rotated component with which it has the highest squared correlation</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">        (b) Search Phase: Assign each variable into different cluster to see if this increase the variance explained. If</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">         variable is re-assigned here, the components of the clusters involved are recomputed before next variable is tested</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">    The procedure stops when the 2nd eigenvalue of each cluster is smaller than maxeigval2 parameter.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxeigval2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxclus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_rs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="sd">        df</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="sd">            PySpark Dataframe</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="sd">        feat_list</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="sd">            List of features to perform variable clustering e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="sd">            If feat_list is None, all columns of the input dataframe will be used.</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="sd">            If feat_list is specified, only columns inside feat_list will be used.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="sd">            To run the algorithm successfully, df[feat_list] should only contain numerical values. (Default value = None)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">        maxeigval2</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="sd">            Maximum value of second-largest eigenvalue e.g., 1 (Default value = 1)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="sd">        maxclus</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="sd">            Maximum number of clusters e.g., 20</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="sd">            If maxclus is None, there will be no restrictions on total number of clusters.</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="sd">            If maxclus is specified, the algorithm will stop splitting data when number of clusters reaches maxclus. (Default value = None)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="sd">        n_rs</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="sd">            Number of random shuffles e.g., 0</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">            This parameter controls the number of random shuffle iterations after re-assignment.</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">            If n_rs is 0, re-assignment of each feature will be conducted with no extra random-shuffling.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">            If n_rs is not 0, extra random shuffling of the features and re-assignment will be conducted. (Default value = 0)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>        <span class="k">if</span> <span class="n">feat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span> <span class="o">=</span> <span class="n">feat_list</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxeigval2</span> <span class="o">=</span> <span class="n">maxeigval2</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxclus</span> <span class="o">=</span> <span class="n">maxclus</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_rs</span> <span class="o">=</span> <span class="n">n_rs</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="n">all_corr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">)]</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>            <span class="n">vecAssembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>                <span class="n">inputCols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>            <span class="n">stream_df</span> <span class="o">=</span> <span class="n">vecAssembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>                <span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>                <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;scaledFeatures&quot;</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a>                <span class="n">withStd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a>                <span class="n">withMean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>            <span class="n">scalerModel</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">stream_df</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>            <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">scalerModel</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">stream_df</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>            <span class="n">rm</span> <span class="o">=</span> <span class="n">RowMatrix</span><span class="p">(</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;scaledFeatures&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>            <span class="n">all_corr</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">computeCovariance</span><span class="p">()</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>            <span class="n">all_corr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>    <span class="k">def</span> <span class="nf">correig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a><span class="sd">        This function find the correlation matrix between feat_list, calculates the top n_pcs eigenvalues, eigenvectors,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a><span class="sd">        and gets the variance-proportion.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a><span class="sd">        df</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a><span class="sd">        feat_list</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a><span class="sd">            list of features columns e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a><span class="sd">            If feat_list is None, all columns of the input dataframe will be used.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a><span class="sd">            If feat_list is specified, only columns inside feat_list will be used.</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a><span class="sd">            To run the algorithm successfully, df[feat_list] should only contain numerical values. (Default value = None)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a><span class="sd">        n_pcs</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a><span class="sd">            number of PCs e.g. 2</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a><span class="sd">            This parameter controls the size of Principal Components. e.g. If n_pcs=2, only the first 2 eigenvalues,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a><span class="sd">            eigenvectors of the correlation matrix will be extracted. (Default value = 2)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a><span class="sd">        -------</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a><span class="sd">        (top n_pcs) eigenvalues, associated eigenvectors, correlation matrix in Pandas dataframe and variance proportions</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a><span class="sd">        eigvals</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a><span class="sd">            Top n_pcs eigenvalues in a Numpy array e.g. [eigval1, eigval2]</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a><span class="sd">        eigvecs</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a><span class="sd">            The associated eigenvectors of the top n_pcs eigenvalues in a Numpy array e.g. [eigvec1, eigvec2]</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a><span class="sd">            Each eigenvector is an array of size D, where D represents the number of columns of df[feat_list]</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a><span class="sd">        corr_df</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a><span class="sd">            Correlation matrix of stored in Pandas dataframe</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a><span class="sd">            The size of this output is DxD where D represents the number of columns of df[feat_list].</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a><span class="sd">            The value at index i and column j indicates the pearson&#39;s correlation score between feat_list[i] and feat_list[j]</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a><span class="sd">        varprops</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a><span class="sd">            The variance proportion of the top n_pcs eigenvalues in a Numpy array e.g. [varprop1, varprop2]</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a><span class="sd">            The order of this array is the same with eigvals, eigvecs, with the first value varprop1 indicating the</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a><span class="sd">            variance proportion of the largest eigenvalue.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>        <span class="k">if</span> <span class="n">feat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>            <span class="n">feat_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>            <span class="n">corr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>            <span class="n">eigvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pcs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>            <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]])</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>            <span class="n">varprops</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>            <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">feat_list</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>            <span class="n">raw_eigvals</span><span class="p">,</span> <span class="n">raw_eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">raw_eigvals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>            <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">raw_eigvals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">raw_eigvecs</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>            <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[:</span><span class="n">n_pcs</span><span class="p">],</span> <span class="n">eigvecs</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_pcs</span><span class="p">]</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>            <span class="n">varprops</span> <span class="o">=</span> <span class="n">eigvals</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">raw_eigvals</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>        <span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>        <span class="k">return</span> <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span><span class="p">,</span> <span class="n">corr_df</span><span class="p">,</span> <span class="n">varprops</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>    <span class="k">def</span> <span class="nf">_calc_tot_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">clusters</span><span class="p">):</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a><span class="sd">        This function calculates the total variance explained of given clusters</span>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a><span class="sd">        df</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a><span class="sd">        clusters</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a><span class="sd">            list of clusters e.g. [clus1, clus2]</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a><span class="sd">            Each cluster is a list of feature columns which are classified into this cluster. e.g. clus1 = [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a><span class="sd">        -------</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a><span class="sd">        tot_var, tot_prop</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a><span class="sd">            tot_var: sum of the first eigenvalues among all clusters passed in. e.g. 0.5</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a><span class="sd">            tot_prop: weighted average of the &quot;variance for 1st PC&quot; for each cluster passed in. e.g. 0.4</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>        <span class="n">tot_len</span><span class="p">,</span> <span class="n">tot_var</span><span class="p">,</span> <span class="n">tot_prop</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">3</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>        <span class="k">for</span> <span class="n">clus</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>            <span class="k">if</span> <span class="n">clus</span> <span class="o">==</span> <span class="p">[]:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>                <span class="k">continue</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>            <span class="n">c_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clus</span><span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>            <span class="n">c_eigvals</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">clus</span><span class="p">))</span>
<a id="__codelineno-0-169" name="__codelineno-0-169" href="#__codelineno-0-169"></a>            <span class="n">tot_var</span> <span class="o">+=</span> <span class="n">c_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170" href="#__codelineno-0-170"></a>            <span class="n">tot_prop</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot_prop</span> <span class="o">*</span> <span class="n">tot_len</span> <span class="o">+</span> <span class="n">c_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_len</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tot_len</span> <span class="o">+</span> <span class="n">c_len</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171" href="#__codelineno-0-171"></a>            <span class="n">tot_len</span> <span class="o">+=</span> <span class="n">c_len</span>
<a id="__codelineno-0-172" name="__codelineno-0-172" href="#__codelineno-0-172"></a>        <span class="k">return</span> <span class="n">tot_var</span><span class="p">,</span> <span class="n">tot_prop</span>
<a id="__codelineno-0-173" name="__codelineno-0-173" href="#__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174" href="#__codelineno-0-174"></a>    <span class="k">def</span> <span class="nf">_reassign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="n">feat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175" href="#__codelineno-0-175"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-176" name="__codelineno-0-176" href="#__codelineno-0-176"></a><span class="sd">        This function performs the re-assignment of each variable into different cluster.</span>
<a id="__codelineno-0-177" name="__codelineno-0-177" href="#__codelineno-0-177"></a><span class="sd">        If the re-assignment could increase the variance explained, the components of the clusters involved are</span>
<a id="__codelineno-0-178" name="__codelineno-0-178" href="#__codelineno-0-178"></a><span class="sd">        recomputed before next variable is tested.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179" href="#__codelineno-0-179"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-180" name="__codelineno-0-180" href="#__codelineno-0-180"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-181" name="__codelineno-0-181" href="#__codelineno-0-181"></a><span class="sd">        df</span>
<a id="__codelineno-0-182" name="__codelineno-0-182" href="#__codelineno-0-182"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-0-183" name="__codelineno-0-183" href="#__codelineno-0-183"></a><span class="sd">        clus1</span>
<a id="__codelineno-0-184" name="__codelineno-0-184" href="#__codelineno-0-184"></a><span class="sd">            List of feature columns in first cluster e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185" href="#__codelineno-0-185"></a><span class="sd">        clus2</span>
<a id="__codelineno-0-186" name="__codelineno-0-186" href="#__codelineno-0-186"></a><span class="sd">            List of feature columns in second cluster e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-0-187" name="__codelineno-0-187" href="#__codelineno-0-187"></a><span class="sd">        feat_list</span>
<a id="__codelineno-0-188" name="__codelineno-0-188" href="#__codelineno-0-188"></a><span class="sd">            List of features to re-assign e.g. [&quot;feat1&quot;, &quot;feat2&quot;]</span>
<a id="__codelineno-0-189" name="__codelineno-0-189" href="#__codelineno-0-189"></a><span class="sd">            If feat_list is None, all features inside clus1 and clus2 will be re-assigned</span>
<a id="__codelineno-0-190" name="__codelineno-0-190" href="#__codelineno-0-190"></a><span class="sd">            If feat_list is specified, it should only contain columns in clus1 and/or clus2, and only the specified columns</span>
<a id="__codelineno-0-191" name="__codelineno-0-191" href="#__codelineno-0-191"></a><span class="sd">            will be re-assigned. (Default value = None)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192" href="#__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193" href="#__codelineno-0-193"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-194" name="__codelineno-0-194" href="#__codelineno-0-194"></a><span class="sd">        -------</span>
<a id="__codelineno-0-195" name="__codelineno-0-195" href="#__codelineno-0-195"></a><span class="sd">        fin_clus1, fin_clus2, max_var</span>
<a id="__codelineno-0-196" name="__codelineno-0-196" href="#__codelineno-0-196"></a><span class="sd">            fin_clus1: final cluster 1&#39;s list of feature columns e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-0-197" name="__codelineno-0-197" href="#__codelineno-0-197"></a><span class="sd">            fin_clus2: final cluster 2&#39;s list of feature columns e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-0-198" name="__codelineno-0-198" href="#__codelineno-0-198"></a><span class="sd">            max_var: the maximum variance achieved e.g. 0.9</span>
<a id="__codelineno-0-199" name="__codelineno-0-199" href="#__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200" href="#__codelineno-0-200"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-201" name="__codelineno-0-201" href="#__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202" href="#__codelineno-0-202"></a>        <span class="k">if</span> <span class="n">feat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203" href="#__codelineno-0-203"></a>            <span class="n">feat_list</span> <span class="o">=</span> <span class="n">clus1</span> <span class="o">+</span> <span class="n">clus2</span>
<a id="__codelineno-0-204" name="__codelineno-0-204" href="#__codelineno-0-204"></a>
<a id="__codelineno-0-205" name="__codelineno-0-205" href="#__codelineno-0-205"></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_tot_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-206" name="__codelineno-0-206" href="#__codelineno-0-206"></a>        <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span> <span class="o">=</span> <span class="n">clus1</span><span class="p">[:],</span> <span class="n">clus2</span><span class="p">[:]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207" href="#__codelineno-0-207"></a>        <span class="n">check_var</span><span class="p">,</span> <span class="n">max_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">init_var</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span>
<a id="__codelineno-0-208" name="__codelineno-0-208" href="#__codelineno-0-208"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209" href="#__codelineno-0-209"></a>
<a id="__codelineno-0-210" name="__codelineno-0-210" href="#__codelineno-0-210"></a>            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feat_list</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211" href="#__codelineno-0-211"></a>                <span class="n">new_clus1</span><span class="p">,</span> <span class="n">new_clus2</span> <span class="o">=</span> <span class="n">fin_clus1</span><span class="p">[:],</span> <span class="n">fin_clus2</span><span class="p">[:]</span>
<a id="__codelineno-0-212" name="__codelineno-0-212" href="#__codelineno-0-212"></a>                <span class="k">if</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">new_clus1</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213" href="#__codelineno-0-213"></a>                    <span class="n">new_clus1</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214" href="#__codelineno-0-214"></a>                    <span class="n">new_clus2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215" href="#__codelineno-0-215"></a>                <span class="k">elif</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">new_clus2</span><span class="p">:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216" href="#__codelineno-0-216"></a>                    <span class="n">new_clus1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217" href="#__codelineno-0-217"></a>                    <span class="n">new_clus2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218" href="#__codelineno-0-218"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219" href="#__codelineno-0-219"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-220" name="__codelineno-0-220" href="#__codelineno-0-220"></a>                <span class="n">new_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_tot_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">new_clus1</span><span class="p">,</span> <span class="n">new_clus2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-221" name="__codelineno-0-221" href="#__codelineno-0-221"></a>                <span class="k">if</span> <span class="n">new_var</span> <span class="o">&gt;</span> <span class="n">check_var</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222" href="#__codelineno-0-222"></a>                    <span class="n">check_var</span> <span class="o">=</span> <span class="n">new_var</span>
<a id="__codelineno-0-223" name="__codelineno-0-223" href="#__codelineno-0-223"></a>                    <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span> <span class="o">=</span> <span class="n">new_clus1</span><span class="p">[:],</span> <span class="n">new_clus2</span><span class="p">[:]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224" href="#__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225" href="#__codelineno-0-225"></a>            <span class="k">if</span> <span class="n">max_var</span> <span class="o">==</span> <span class="n">check_var</span><span class="p">:</span>
<a id="__codelineno-0-226" name="__codelineno-0-226" href="#__codelineno-0-226"></a>                <span class="k">break</span>
<a id="__codelineno-0-227" name="__codelineno-0-227" href="#__codelineno-0-227"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228" href="#__codelineno-0-228"></a>                <span class="n">max_var</span> <span class="o">=</span> <span class="n">check_var</span>
<a id="__codelineno-0-229" name="__codelineno-0-229" href="#__codelineno-0-229"></a>        <span class="k">return</span> <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span><span class="p">,</span> <span class="n">max_var</span>
<a id="__codelineno-0-230" name="__codelineno-0-230" href="#__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231" href="#__codelineno-0-231"></a>    <span class="k">def</span> <span class="nf">_reassign_rs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="n">n_rs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-232" name="__codelineno-0-232" href="#__codelineno-0-232"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-233" name="__codelineno-0-233" href="#__codelineno-0-233"></a><span class="sd">        This function should be called after _reassign, and it performs random shuffling of n_rs times to run the re-assignment</span>
<a id="__codelineno-0-234" name="__codelineno-0-234" href="#__codelineno-0-234"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-235" name="__codelineno-0-235" href="#__codelineno-0-235"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-236" name="__codelineno-0-236" href="#__codelineno-0-236"></a><span class="sd">        df</span>
<a id="__codelineno-0-237" name="__codelineno-0-237" href="#__codelineno-0-237"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-0-238" name="__codelineno-0-238" href="#__codelineno-0-238"></a><span class="sd">        clus1</span>
<a id="__codelineno-0-239" name="__codelineno-0-239" href="#__codelineno-0-239"></a><span class="sd">            List of feature columns in first cluster e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-0-240" name="__codelineno-0-240" href="#__codelineno-0-240"></a><span class="sd">        clus2</span>
<a id="__codelineno-0-241" name="__codelineno-0-241" href="#__codelineno-0-241"></a><span class="sd">            List of feature columns in second cluster e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-0-242" name="__codelineno-0-242" href="#__codelineno-0-242"></a><span class="sd">        n_rs</span>
<a id="__codelineno-0-243" name="__codelineno-0-243" href="#__codelineno-0-243"></a><span class="sd">            Number of random shuffles e.g. 2</span>
<a id="__codelineno-0-244" name="__codelineno-0-244" href="#__codelineno-0-244"></a><span class="sd">            If n_rs is 0, random shuffling of the features after re-assignment will not be conducted.</span>
<a id="__codelineno-0-245" name="__codelineno-0-245" href="#__codelineno-0-245"></a><span class="sd">            If n_rs is &gt;0, random shuffling of n_rs times will be conducted to perform re-assignment. (Default value = 0)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246" href="#__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247" href="#__codelineno-0-247"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-248" name="__codelineno-0-248" href="#__codelineno-0-248"></a><span class="sd">        -------</span>
<a id="__codelineno-0-249" name="__codelineno-0-249" href="#__codelineno-0-249"></a><span class="sd">        fin_rs_clus1, fin_rs_clus2, max_rs_var</span>
<a id="__codelineno-0-250" name="__codelineno-0-250" href="#__codelineno-0-250"></a><span class="sd">            fin_rs_clus1: final cluster 1&#39;s list of feature columns after random shuffling e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-0-251" name="__codelineno-0-251" href="#__codelineno-0-251"></a><span class="sd">            fin_rs_clus2: final cluster 2&#39;s list of feature columns after random shuffling e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-0-252" name="__codelineno-0-252" href="#__codelineno-0-252"></a><span class="sd">            max_rs_var: the maximum variance achieved after random shuffling e.g. 0.9</span>
<a id="__codelineno-0-253" name="__codelineno-0-253" href="#__codelineno-0-253"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254" href="#__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255" href="#__codelineno-0-255"></a>        <span class="n">feat_list</span> <span class="o">=</span> <span class="n">clus1</span> <span class="o">+</span> <span class="n">clus2</span>
<a id="__codelineno-0-256" name="__codelineno-0-256" href="#__codelineno-0-256"></a>        <span class="n">fin_rs_clus1</span><span class="p">,</span> <span class="n">fin_rs_clus2</span><span class="p">,</span> <span class="n">max_rs_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reassign</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257" href="#__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258" href="#__codelineno-0-258"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rs</span><span class="p">):</span>
<a id="__codelineno-0-259" name="__codelineno-0-259" href="#__codelineno-0-259"></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260" href="#__codelineno-0-260"></a>            <span class="n">rs_clus1</span><span class="p">,</span> <span class="n">rs_clus2</span><span class="p">,</span> <span class="n">rs_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reassign</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261" href="#__codelineno-0-261"></a>            <span class="k">if</span> <span class="n">rs_var</span> <span class="o">&gt;</span> <span class="n">max_rs_var</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262" href="#__codelineno-0-262"></a>                <span class="n">max_rs_var</span> <span class="o">=</span> <span class="n">rs_var</span>
<a id="__codelineno-0-263" name="__codelineno-0-263" href="#__codelineno-0-263"></a>                <span class="n">fin_rs_clus1</span><span class="p">,</span> <span class="n">fin_rs_clus2</span> <span class="o">=</span> <span class="n">rs_clus1</span><span class="p">,</span> <span class="n">rs_clus2</span>
<a id="__codelineno-0-264" name="__codelineno-0-264" href="#__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265" href="#__codelineno-0-265"></a>        <span class="k">return</span> <span class="n">fin_rs_clus1</span><span class="p">,</span> <span class="n">fin_rs_clus2</span><span class="p">,</span> <span class="n">max_rs_var</span>
<a id="__codelineno-0-266" name="__codelineno-0-266" href="#__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267" href="#__codelineno-0-267"></a>    <span class="k">def</span> <span class="nf">_varclusspark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark</span><span class="p">):</span>
<a id="__codelineno-0-268" name="__codelineno-0-268" href="#__codelineno-0-268"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-269" name="__codelineno-0-269" href="#__codelineno-0-269"></a><span class="sd">        This function is the main function which performs variable clustering.</span>
<a id="__codelineno-0-270" name="__codelineno-0-270" href="#__codelineno-0-270"></a><span class="sd">        By default, it begins with all variables in a single cluster. It then repeats the following steps:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271" href="#__codelineno-0-271"></a><span class="sd">            1. A cluster is chosen for splitting. This cluster has the largest eigenvalue associated with the 2nd PC</span>
<a id="__codelineno-0-272" name="__codelineno-0-272" href="#__codelineno-0-272"></a><span class="sd">            2. Find the first 2 PCs of the chosen cluster and split into 2 clusters, then perform an orthoblique rotation (raw quartimax rotation on the eigenvectors)</span>
<a id="__codelineno-0-273" name="__codelineno-0-273" href="#__codelineno-0-273"></a><span class="sd">            3. Variables are iteratively re-assigned to clusters to maximize the variance</span>
<a id="__codelineno-0-274" name="__codelineno-0-274" href="#__codelineno-0-274"></a><span class="sd">                (a) Nearest Component Sorting (NCS) Phase: In each iteration, the cluster components are computed. Each</span>
<a id="__codelineno-0-275" name="__codelineno-0-275" href="#__codelineno-0-275"></a><span class="sd">                variable is assigned to the rotated component with which it has the highest squared correlation</span>
<a id="__codelineno-0-276" name="__codelineno-0-276" href="#__codelineno-0-276"></a><span class="sd">                (b) Search Phase: Assign each variable into different cluster to see if this increase the variance explained.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277" href="#__codelineno-0-277"></a><span class="sd">                If variable is re-assigned here, the components of the clusters involved are recomputed before next variable is tested</span>
<a id="__codelineno-0-278" name="__codelineno-0-278" href="#__codelineno-0-278"></a><span class="sd">        The procedure stops when the 2nd eigenvalue of each cluster is smaller than maxeigval2 parameter.</span>
<a id="__codelineno-0-279" name="__codelineno-0-279" href="#__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280" href="#__codelineno-0-280"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-281" name="__codelineno-0-281" href="#__codelineno-0-281"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-282" name="__codelineno-0-282" href="#__codelineno-0-282"></a><span class="sd">        spark</span>
<a id="__codelineno-0-283" name="__codelineno-0-283" href="#__codelineno-0-283"></a><span class="sd">            Spark Session</span>
<a id="__codelineno-0-284" name="__codelineno-0-284" href="#__codelineno-0-284"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-285" name="__codelineno-0-285" href="#__codelineno-0-285"></a><span class="sd">        -------</span>
<a id="__codelineno-0-286" name="__codelineno-0-286" href="#__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287" href="#__codelineno-0-287"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-288" name="__codelineno-0-288" href="#__codelineno-0-288"></a>        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
<a id="__codelineno-0-289" name="__codelineno-0-289" href="#__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290" href="#__codelineno-0-290"></a>        <span class="n">ClusInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
<a id="__codelineno-0-291" name="__codelineno-0-291" href="#__codelineno-0-291"></a>            <span class="s2">&quot;ClusInfo&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;clus&quot;</span><span class="p">,</span> <span class="s2">&quot;eigval1&quot;</span><span class="p">,</span> <span class="s2">&quot;eigval2&quot;</span><span class="p">,</span> <span class="s2">&quot;eigvecs&quot;</span><span class="p">,</span> <span class="s2">&quot;varprop&quot;</span><span class="p">]</span>
<a id="__codelineno-0-292" name="__codelineno-0-292" href="#__codelineno-0-292"></a>        <span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293" href="#__codelineno-0-293"></a>        <span class="n">c_eigvals</span><span class="p">,</span> <span class="n">c_eigvecs</span><span class="p">,</span> <span class="n">c_corrs</span><span class="p">,</span> <span class="n">c_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294" href="#__codelineno-0-294"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295" href="#__codelineno-0-295"></a>        <span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296" href="#__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297" href="#__codelineno-0-297"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corrs</span> <span class="o">=</span> <span class="n">c_corrs</span>
<a id="__codelineno-0-298" name="__codelineno-0-298" href="#__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299" href="#__codelineno-0-299"></a>        <span class="n">clus0</span> <span class="o">=</span> <span class="n">ClusInfo</span><span class="p">(</span>
<a id="__codelineno-0-300" name="__codelineno-0-300" href="#__codelineno-0-300"></a>            <span class="n">clus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301" href="#__codelineno-0-301"></a>            <span class="n">eigval1</span><span class="o">=</span><span class="n">c_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-302" name="__codelineno-0-302" href="#__codelineno-0-302"></a>            <span class="n">eigval2</span><span class="o">=</span><span class="n">c_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-303" name="__codelineno-0-303" href="#__codelineno-0-303"></a>            <span class="n">eigvecs</span><span class="o">=</span><span class="n">c_eigvecs</span><span class="p">,</span>
<a id="__codelineno-0-304" name="__codelineno-0-304" href="#__codelineno-0-304"></a>            <span class="n">varprop</span><span class="o">=</span><span class="n">c_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-305" name="__codelineno-0-305" href="#__codelineno-0-305"></a>        <span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306" href="#__codelineno-0-306"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clus0</span><span class="p">)])</span>
<a id="__codelineno-0-307" name="__codelineno-0-307" href="#__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308" href="#__codelineno-0-308"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309" href="#__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310" href="#__codelineno-0-310"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxclus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxclus</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311" href="#__codelineno-0-311"></a>                <span class="k">break</span>
<a id="__codelineno-0-312" name="__codelineno-0-312" href="#__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313" href="#__codelineno-0-313"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">eigval2</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314" href="#__codelineno-0-314"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">eigval2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxeigval2</span><span class="p">:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315" href="#__codelineno-0-315"></a>                <span class="n">split_clus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">clus</span>
<a id="__codelineno-0-316" name="__codelineno-0-316" href="#__codelineno-0-316"></a>                <span class="n">c_eigvals</span><span class="p">,</span> <span class="n">c_eigvecs</span><span class="p">,</span> <span class="n">split_corrs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-0-317" name="__codelineno-0-317" href="#__codelineno-0-317"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">split_clus</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318" href="#__codelineno-0-318"></a>                <span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319" href="#__codelineno-0-319"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320" href="#__codelineno-0-320"></a>                <span class="k">break</span>
<a id="__codelineno-0-321" name="__codelineno-0-321" href="#__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322" href="#__codelineno-0-322"></a>            <span class="k">if</span> <span class="n">c_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxeigval2</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323" href="#__codelineno-0-323"></a>                <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-324" name="__codelineno-0-324" href="#__codelineno-0-324"></a>                <span class="n">rotator</span> <span class="o">=</span> <span class="n">Rotator</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;quartimax&quot;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325" href="#__codelineno-0-325"></a>                <span class="n">r_eigvecs</span> <span class="o">=</span> <span class="n">rotator</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">c_eigvecs</span><span class="p">))</span>
<a id="__codelineno-0-326" name="__codelineno-0-326" href="#__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327" href="#__codelineno-0-327"></a>                <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="n">r_eigvecs</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-328" name="__codelineno-0-328" href="#__codelineno-0-328"></a>                <span class="n">r_eigvecs_dm</span> <span class="o">=</span> <span class="n">DenseMatrix</span><span class="p">(</span>
<a id="__codelineno-0-329" name="__codelineno-0-329" href="#__codelineno-0-329"></a>                    <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">r_eigvecs</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330" href="#__codelineno-0-330"></a>                <span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331" href="#__codelineno-0-331"></a>                <span class="n">r_eigvecs_rm</span> <span class="o">=</span> <span class="n">RowMatrix</span><span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">r_eigvecs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<a id="__codelineno-0-332" name="__codelineno-0-332" href="#__codelineno-0-332"></a>                <span class="n">dm</span> <span class="o">=</span> <span class="n">DenseMatrix</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">split_corrs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<a id="__codelineno-0-333" name="__codelineno-0-333" href="#__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334" href="#__codelineno-0-334"></a>                <span class="n">comb_sigmas</span> <span class="o">=</span> <span class="n">r_eigvecs_rm</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">r_eigvecs_dm</span><span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335" href="#__codelineno-0-335"></a>                <span class="n">comb_sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-0-336" name="__codelineno-0-336" href="#__codelineno-0-336"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">comb_sigmas</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
<a id="__codelineno-0-337" name="__codelineno-0-337" href="#__codelineno-0-337"></a>                <span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338" href="#__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339" href="#__codelineno-0-339"></a>                <span class="n">comb_sigma1</span> <span class="o">=</span> <span class="n">comb_sigmas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-340" name="__codelineno-0-340" href="#__codelineno-0-340"></a>                <span class="n">comb_sigma2</span> <span class="o">=</span> <span class="n">comb_sigmas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-341" name="__codelineno-0-341" href="#__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342" href="#__codelineno-0-342"></a>                <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">split_clus</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343" href="#__codelineno-0-343"></a>                    <span class="n">comb_cov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">split_corrs</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344" href="#__codelineno-0-344"></a>                    <span class="n">comb_cov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_eigvecs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">split_corrs</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345" href="#__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346" href="#__codelineno-0-346"></a>                    <span class="n">corr_pc1</span> <span class="o">=</span> <span class="n">comb_cov1</span> <span class="o">/</span> <span class="n">comb_sigma1</span>
<a id="__codelineno-0-347" name="__codelineno-0-347" href="#__codelineno-0-347"></a>                    <span class="n">corr_pc2</span> <span class="o">=</span> <span class="n">comb_cov2</span> <span class="o">/</span> <span class="n">comb_sigma2</span>
<a id="__codelineno-0-348" name="__codelineno-0-348" href="#__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349" href="#__codelineno-0-349"></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_pc1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_pc2</span><span class="p">):</span>
<a id="__codelineno-0-350" name="__codelineno-0-350" href="#__codelineno-0-350"></a>                        <span class="n">clus1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351" href="#__codelineno-0-351"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352" href="#__codelineno-0-352"></a>                        <span class="n">clus2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353" href="#__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354" href="#__codelineno-0-354"></a>                <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reassign_rs</span><span class="p">(</span>
<a id="__codelineno-0-355" name="__codelineno-0-355" href="#__codelineno-0-355"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rs</span>
<a id="__codelineno-0-356" name="__codelineno-0-356" href="#__codelineno-0-356"></a>                <span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357" href="#__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358" href="#__codelineno-0-358"></a>                <span class="n">c1_eigvals</span><span class="p">,</span> <span class="n">c1_eigvecs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c1_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-0-359" name="__codelineno-0-359" href="#__codelineno-0-359"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fin_clus1</span><span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360" href="#__codelineno-0-360"></a>                <span class="p">)</span>
<a id="__codelineno-0-361" name="__codelineno-0-361" href="#__codelineno-0-361"></a>                <span class="n">c2_eigvals</span><span class="p">,</span> <span class="n">c2_eigvecs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c2_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-0-362" name="__codelineno-0-362" href="#__codelineno-0-362"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fin_clus2</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363" href="#__codelineno-0-363"></a>                <span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364" href="#__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365" href="#__codelineno-0-365"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClusInfo</span><span class="p">(</span>
<a id="__codelineno-0-366" name="__codelineno-0-366" href="#__codelineno-0-366"></a>                    <span class="n">clus</span><span class="o">=</span><span class="n">fin_clus1</span><span class="p">,</span>
<a id="__codelineno-0-367" name="__codelineno-0-367" href="#__codelineno-0-367"></a>                    <span class="n">eigval1</span><span class="o">=</span><span class="n">c1_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-368" name="__codelineno-0-368" href="#__codelineno-0-368"></a>                    <span class="n">eigval2</span><span class="o">=</span><span class="n">c1_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-369" name="__codelineno-0-369" href="#__codelineno-0-369"></a>                    <span class="n">eigvecs</span><span class="o">=</span><span class="n">c1_eigvecs</span><span class="p">,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370" href="#__codelineno-0-370"></a>                    <span class="n">varprop</span><span class="o">=</span><span class="n">c1_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-371" name="__codelineno-0-371" href="#__codelineno-0-371"></a>                <span class="p">)</span>
<a id="__codelineno-0-372" name="__codelineno-0-372" href="#__codelineno-0-372"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ClusInfo</span><span class="p">(</span>
<a id="__codelineno-0-373" name="__codelineno-0-373" href="#__codelineno-0-373"></a>                    <span class="n">clus</span><span class="o">=</span><span class="n">fin_clus2</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374" href="#__codelineno-0-374"></a>                    <span class="n">eigval1</span><span class="o">=</span><span class="n">c2_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-375" name="__codelineno-0-375" href="#__codelineno-0-375"></a>                    <span class="n">eigval2</span><span class="o">=</span><span class="n">c2_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-376" name="__codelineno-0-376" href="#__codelineno-0-376"></a>                    <span class="n">eigvecs</span><span class="o">=</span><span class="n">c2_eigvecs</span><span class="p">,</span>
<a id="__codelineno-0-377" name="__codelineno-0-377" href="#__codelineno-0-377"></a>                    <span class="n">varprop</span><span class="o">=</span><span class="n">c2_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-378" name="__codelineno-0-378" href="#__codelineno-0-378"></a>                <span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379" href="#__codelineno-0-379"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-380" name="__codelineno-0-380" href="#__codelineno-0-380"></a>                <span class="k">break</span>
<a id="__codelineno-0-381" name="__codelineno-0-381" href="#__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382" href="#__codelineno-0-382"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-383" name="__codelineno-0-383" href="#__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384" href="#__codelineno-0-384"></a>    <span class="k">def</span> <span class="nf">_rsquarespark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-385" name="__codelineno-0-385" href="#__codelineno-0-385"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-386" name="__codelineno-0-386" href="#__codelineno-0-386"></a><span class="sd">        After variable clustering is done, this function calculates the square correlation of each feature with</span>
<a id="__codelineno-0-387" name="__codelineno-0-387" href="#__codelineno-0-387"></a><span class="sd">        (1) its own cluster (2) the &quot;nearest cluster&quot; (3) RS-ratio using own cluster and &quot;nearest clutser&quot;</span>
<a id="__codelineno-0-388" name="__codelineno-0-388" href="#__codelineno-0-388"></a><span class="sd">        RS_Own: Squared correlation between variable and its own cluster</span>
<a id="__codelineno-0-389" name="__codelineno-0-389" href="#__codelineno-0-389"></a><span class="sd">        RS_NC: The largest squared correlation among correlations between variable and all other clusters</span>
<a id="__codelineno-0-390" name="__codelineno-0-390" href="#__codelineno-0-390"></a><span class="sd">        RS_Ratio: (1-RS_Own)/(1-RS_NC)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391" href="#__codelineno-0-391"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-392" name="__codelineno-0-392" href="#__codelineno-0-392"></a><span class="sd">        -------</span>
<a id="__codelineno-0-393" name="__codelineno-0-393" href="#__codelineno-0-393"></a><span class="sd">        rs_table</span>
<a id="__codelineno-0-394" name="__codelineno-0-394" href="#__codelineno-0-394"></a><span class="sd">            Pandas dataframe [Cluster, Variable, RS_Own, RS_NC, RS_Ratio]</span>
<a id="__codelineno-0-395" name="__codelineno-0-395" href="#__codelineno-0-395"></a><span class="sd">            Cluster: integer-type column starting from 0 to maximum number of clusters</span>
<a id="__codelineno-0-396" name="__codelineno-0-396" href="#__codelineno-0-396"></a><span class="sd">            Variable: string-type column. Each row represents a feature name</span>
<a id="__codelineno-0-397" name="__codelineno-0-397" href="#__codelineno-0-397"></a><span class="sd">            RS_Own: float-type column indicating the squared correlation between Variable and its Cluster</span>
<a id="__codelineno-0-398" name="__codelineno-0-398" href="#__codelineno-0-398"></a><span class="sd">            RS_NC: float-type column indicating the squared correlation between Variable and its &quot;nearest cluster&quot;</span>
<a id="__codelineno-0-399" name="__codelineno-0-399" href="#__codelineno-0-399"></a><span class="sd">            RS_Ratio: float-type column (1-RS_Own)/(1-RS_NC)</span>
<a id="__codelineno-0-400" name="__codelineno-0-400" href="#__codelineno-0-400"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-401" name="__codelineno-0-401" href="#__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402" href="#__codelineno-0-402"></a>        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="s2">&quot;RS_Own&quot;</span><span class="p">,</span> <span class="s2">&quot;RS_NC&quot;</span><span class="p">,</span> <span class="s2">&quot;RS_Ratio&quot;</span><span class="p">]</span>
<a id="__codelineno-0-403" name="__codelineno-0-403" href="#__codelineno-0-403"></a>        <span class="n">rs_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
<a id="__codelineno-0-404" name="__codelineno-0-404" href="#__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405" href="#__codelineno-0-405"></a>        <span class="n">sigmas</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-406" name="__codelineno-0-406" href="#__codelineno-0-406"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusinfo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-407" name="__codelineno-0-407" href="#__codelineno-0-407"></a>            <span class="n">c_eigvec</span> <span class="o">=</span> <span class="n">clusinfo</span><span class="o">.</span><span class="n">eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-408" name="__codelineno-0-408" href="#__codelineno-0-408"></a>            <span class="n">c_sigma</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-0-409" name="__codelineno-0-409" href="#__codelineno-0-409"></a>                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-0-410" name="__codelineno-0-410" href="#__codelineno-0-410"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-0-411" name="__codelineno-0-411" href="#__codelineno-0-411"></a>                        <span class="n">c_eigvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clusinfo</span><span class="o">.</span><span class="n">clus</span><span class="p">,</span> <span class="n">clusinfo</span><span class="o">.</span><span class="n">clus</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-0-412" name="__codelineno-0-412" href="#__codelineno-0-412"></a>                    <span class="p">),</span>
<a id="__codelineno-0-413" name="__codelineno-0-413" href="#__codelineno-0-413"></a>                    <span class="n">c_eigvec</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414" href="#__codelineno-0-414"></a>                <span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415" href="#__codelineno-0-415"></a>            <span class="p">)</span>
<a id="__codelineno-0-416" name="__codelineno-0-416" href="#__codelineno-0-416"></a>            <span class="n">sigmas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_sigma</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417" href="#__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418" href="#__codelineno-0-418"></a>        <span class="n">n_row</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-419" name="__codelineno-0-419" href="#__codelineno-0-419"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">clus_own</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-420" name="__codelineno-0-420" href="#__codelineno-0-420"></a>            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">:</span>
<a id="__codelineno-0-421" name="__codelineno-0-421" href="#__codelineno-0-421"></a>                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">feat</span><span class="p">]</span>
<a id="__codelineno-0-422" name="__codelineno-0-422" href="#__codelineno-0-422"></a>                <span class="n">cov_own</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-0-423" name="__codelineno-0-423" href="#__codelineno-0-423"></a>                    <span class="n">clus_own</span><span class="o">.</span><span class="n">eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-424" name="__codelineno-0-424" href="#__codelineno-0-424"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feat</span><span class="p">,</span> <span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425" href="#__codelineno-0-425"></a>                <span class="p">)</span>
<a id="__codelineno-0-426" name="__codelineno-0-426" href="#__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427" href="#__codelineno-0-427"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">feat</span> <span class="o">==</span> <span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-428" name="__codelineno-0-428" href="#__codelineno-0-428"></a>                    <span class="n">rs_own</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-429" name="__codelineno-0-429" href="#__codelineno-0-429"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430" href="#__codelineno-0-430"></a>                    <span class="n">rs_own</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_own</span> <span class="o">/</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-0-431" name="__codelineno-0-431" href="#__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432" href="#__codelineno-0-432"></a>                <span class="n">rs_others</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-433" name="__codelineno-0-433" href="#__codelineno-0-433"></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">clus_other</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-434" name="__codelineno-0-434" href="#__codelineno-0-434"></a>                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435" href="#__codelineno-0-435"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-436" name="__codelineno-0-436" href="#__codelineno-0-436"></a>
<a id="__codelineno-0-437" name="__codelineno-0-437" href="#__codelineno-0-437"></a>                    <span class="n">cov_other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-0-438" name="__codelineno-0-438" href="#__codelineno-0-438"></a>                        <span class="n">clus_other</span><span class="o">.</span><span class="n">eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-439" name="__codelineno-0-439" href="#__codelineno-0-439"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feat</span><span class="p">,</span> <span class="n">clus_other</span><span class="o">.</span><span class="n">clus</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
<a id="__codelineno-0-440" name="__codelineno-0-440" href="#__codelineno-0-440"></a>                    <span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441" href="#__codelineno-0-441"></a>                    <span class="n">rs</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_other</span> <span class="o">/</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-0-442" name="__codelineno-0-442" href="#__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443" href="#__codelineno-0-443"></a>                    <span class="n">rs_others</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444" href="#__codelineno-0-444"></a>
<a id="__codelineno-0-445" name="__codelineno-0-445" href="#__codelineno-0-445"></a>                <span class="n">rs_nc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rs_others</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs_others</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-446" name="__codelineno-0-446" href="#__codelineno-0-446"></a>                <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rs_own</span><span class="p">,</span> <span class="n">rs_nc</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rs_own</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rs_nc</span><span class="p">)]</span>
<a id="__codelineno-0-447" name="__codelineno-0-447" href="#__codelineno-0-447"></a>                <span class="n">rs_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
<a id="__codelineno-0-448" name="__codelineno-0-448" href="#__codelineno-0-448"></a>                <span class="n">n_row</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-449" name="__codelineno-0-449" href="#__codelineno-0-449"></a>
<a id="__codelineno-0-450" name="__codelineno-0-450" href="#__codelineno-0-450"></a>        <span class="k">return</span> <span class="n">rs_table</span>
</code></pre></div>
</pre>
</details>
<h2 id="_1"></h2>
<p>Classes</p>
<dl>
<dt id="anovos.data_analyzer.association_eval_varclus.VarClusHiSpark"><code class="flex name class">
<span>class <span class="ident">VarClusHiSpark</span></span>
<span>(</span><span>df, feat_list=None, maxeigval2=1, maxclus=None, n_rs=0)</span>
</code></dt>
<dd>
<div class="desc"><p>This class is a scalable version of <a href="https://github.com/jingtt/varclushi" title="VarCluShi">VarClusHi</a> library to perform variable clustering on PySpark dataframes
with necessary optimizations, and sampling is not required.</p>
<p>Variable Clustering groups attributes that are as correlated as possible among themselves within a cluster and as
uncorrelated as possible with attribute in other clusters. By default, it begins with all variables in a single cluster.
It then repeats the following steps:
1. A cluster is chosen for splitting. This cluster has the largest eigenvalue associated with the 2nd PC
2. Find the first 2 PCs of the chosen cluster and split into 2 clusters, then perform an orthoblique rotation
(raw quartimax rotation on the eigenvectors)
3. Variables are iteratively re-assigned to clusters to maximize the variance:
(a) Nearest Component Sorting (NCS) Phase: In each iteration, the cluster components are computed.
Each variable is assigned to the rotated component with which it has the highest squared correlation
(b) Search Phase: Assign each variable into different cluster to see if this increase the variance explained. If
variable is re-assigned here, the components of the clusters involved are recomputed before next variable is tested
The procedure stops when the 2nd eigenvalue of each cluster is smaller than maxeigval2 parameter.</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>df</code></strong></dt>
<dd>PySpark Dataframe</dd>
<dt><strong><code>feat_list</code></strong></dt>
<dd>List of features to perform variable clustering e.g., ["col1","col2"].
If feat_list is None, all columns of the input dataframe will be used.
If feat_list is specified, only columns inside feat_list will be used.
To run the algorithm successfully, df[feat_list] should only contain numerical values. (Default value = None)</dd>
<dt><strong><code>maxeigval2</code></strong></dt>
<dd>Maximum value of second-largest eigenvalue e.g., 1 (Default value = 1)</dd>
<dt><strong><code>maxclus</code></strong></dt>
<dd>Maximum number of clusters e.g., 20
If maxclus is None, there will be no restrictions on total number of clusters.
If maxclus is specified, the algorithm will stop splitting data when number of clusters reaches maxclus. (Default value = None)</dd>
<dt><strong><code>n_rs</code></strong></dt>
<dd>Number of random shuffles e.g., 0
This parameter controls the number of random shuffle iterations after re-assignment.
If n_rs is 0, re-assignment of each feature will be conducted with no extra random-shuffling.
If n_rs is not 0, extra random shuffling of the features and re-assignment will be conducted. (Default value = 0)</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span> <span class="nc">VarClusHiSpark</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="sd">    This class is a scalable version of [VarClusHi] [2] library to perform variable clustering on PySpark dataframes</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="sd">    with necessary optimizations, and sampling is not required.</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="sd">    [2]: https://github.com/jingtt/varclushi   &quot;VarCluShi&quot;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="sd">    Variable Clustering groups attributes that are as correlated as possible among themselves within a cluster and as</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="sd">    uncorrelated as possible with attribute in other clusters. By default, it begins with all variables in a single cluster.</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="sd">    It then repeats the following steps:</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="sd">    1. A cluster is chosen for splitting. This cluster has the largest eigenvalue associated with the 2nd PC</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="sd">    2. Find the first 2 PCs of the chosen cluster and split into 2 clusters, then perform an orthoblique rotation</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="sd">    (raw quartimax rotation on the eigenvectors)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="sd">    3. Variables are iteratively re-assigned to clusters to maximize the variance:</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="sd">        (a) Nearest Component Sorting (NCS) Phase: In each iteration, the cluster components are computed.</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="sd">        Each variable is assigned to the rotated component with which it has the highest squared correlation</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="sd">        (b) Search Phase: Assign each variable into different cluster to see if this increase the variance explained. If</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="sd">         variable is re-assigned here, the components of the clusters involved are recomputed before next variable is tested</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="sd">    The procedure stops when the 2nd eigenvalue of each cluster is smaller than maxeigval2 parameter.</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxeigval2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxclus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_rs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="sd">        Parameters</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="sd">        ----------</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="sd">        df</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="sd">            PySpark Dataframe</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="sd">        feat_list</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="sd">            List of features to perform variable clustering e.g., [&quot;col1&quot;,&quot;col2&quot;].</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="sd">            If feat_list is None, all columns of the input dataframe will be used.</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="sd">            If feat_list is specified, only columns inside feat_list will be used.</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="sd">            To run the algorithm successfully, df[feat_list] should only contain numerical values. (Default value = None)</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="sd">        maxeigval2</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="sd">            Maximum value of second-largest eigenvalue e.g., 1 (Default value = 1)</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="sd">        maxclus</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="sd">            Maximum number of clusters e.g., 20</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="sd">            If maxclus is None, there will be no restrictions on total number of clusters.</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="sd">            If maxclus is specified, the algorithm will stop splitting data when number of clusters reaches maxclus. (Default value = None)</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="sd">        n_rs</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="sd">            Number of random shuffles e.g., 0</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="sd">            This parameter controls the number of random shuffle iterations after re-assignment.</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="sd">            If n_rs is 0, re-assignment of each feature will be conducted with no extra random-shuffling.</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="sd">            If n_rs is not 0, extra random shuffling of the features and re-assignment will be conducted. (Default value = 0)</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>        <span class="k">if</span> <span class="n">feat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span> <span class="o">=</span> <span class="n">feat_list</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxeigval2</span> <span class="o">=</span> <span class="n">maxeigval2</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">maxclus</span> <span class="o">=</span> <span class="n">maxclus</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_rs</span> <span class="o">=</span> <span class="n">n_rs</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>            <span class="n">all_corr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">)]</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>            <span class="n">vecAssembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>                <span class="n">inputCols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>            <span class="p">)</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>            <span class="n">stream_df</span> <span class="o">=</span> <span class="n">vecAssembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>                <span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">,</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>                <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;scaledFeatures&quot;</span><span class="p">,</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>                <span class="n">withStd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>                <span class="n">withMean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>            <span class="p">)</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>            <span class="n">scalerModel</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">stream_df</span><span class="p">)</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>            <span class="n">scaled_df</span> <span class="o">=</span> <span class="n">scalerModel</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">stream_df</span><span class="p">)</span>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>            <span class="n">rm</span> <span class="o">=</span> <span class="n">RowMatrix</span><span class="p">(</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;scaledFeatures&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>            <span class="n">all_corr</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">computeCovariance</span><span class="p">()</span><span class="o">.</span><span class="n">toArray</span><span class="p">()</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>            <span class="n">all_corr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>        <span class="p">)</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>    <span class="k">def</span> <span class="nf">correig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a><span class="sd">        This function find the correlation matrix between feat_list, calculates the top n_pcs eigenvalues, eigenvectors,</span>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a><span class="sd">        and gets the variance-proportion.</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a><span class="sd">        Parameters</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a><span class="sd">        ----------</span>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a><span class="sd">        df</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a><span class="sd">        feat_list</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a><span class="sd">            list of features columns e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a><span class="sd">            If feat_list is None, all columns of the input dataframe will be used.</span>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a><span class="sd">            If feat_list is specified, only columns inside feat_list will be used.</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a><span class="sd">            To run the algorithm successfully, df[feat_list] should only contain numerical values. (Default value = None)</span>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a><span class="sd">        n_pcs</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a><span class="sd">            number of PCs e.g. 2</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a><span class="sd">            This parameter controls the size of Principal Components. e.g. If n_pcs=2, only the first 2 eigenvalues,</span>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a><span class="sd">            eigenvectors of the correlation matrix will be extracted. (Default value = 2)</span>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a><span class="sd">        Returns</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a><span class="sd">        -------</span>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a><span class="sd">        (top n_pcs) eigenvalues, associated eigenvectors, correlation matrix in Pandas dataframe and variance proportions</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a><span class="sd">        eigvals</span>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a><span class="sd">            Top n_pcs eigenvalues in a Numpy array e.g. [eigval1, eigval2]</span>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a><span class="sd">        eigvecs</span>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a><span class="sd">            The associated eigenvectors of the top n_pcs eigenvalues in a Numpy array e.g. [eigvec1, eigvec2]</span>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a><span class="sd">            Each eigenvector is an array of size D, where D represents the number of columns of df[feat_list]</span>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a><span class="sd">        corr_df</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a><span class="sd">            Correlation matrix of stored in Pandas dataframe</span>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a><span class="sd">            The size of this output is DxD where D represents the number of columns of df[feat_list].</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a><span class="sd">            The value at index i and column j indicates the pearson&#39;s correlation score between feat_list[i] and feat_list[j]</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a><span class="sd">        varprops</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a><span class="sd">            The variance proportion of the top n_pcs eigenvalues in a Numpy array e.g. [varprop1, varprop2]</span>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a><span class="sd">            The order of this array is the same with eigvals, eigvecs, with the first value varprop1 indicating the</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a><span class="sd">            variance proportion of the largest eigenvalue.</span>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>        <span class="k">if</span> <span class="n">feat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>            <span class="n">feat_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>            <span class="n">corr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]</span>
<a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>            <span class="n">eigvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pcs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>            <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]])</span>
<a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>            <span class="n">varprops</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)]</span>
<a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a>            <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">feat_list</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a>            <span class="n">raw_eigvals</span><span class="p">,</span> <span class="n">raw_eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
<a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">raw_eigvals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>            <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">raw_eigvals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">raw_eigvecs</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>            <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[:</span><span class="n">n_pcs</span><span class="p">],</span> <span class="n">eigvecs</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_pcs</span><span class="p">]</span>
<a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>            <span class="n">varprops</span> <span class="o">=</span> <span class="n">eigvals</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">raw_eigvals</span><span class="p">)</span>
<a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>
<a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a>        <span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a>
<a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a>        <span class="k">return</span> <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span><span class="p">,</span> <span class="n">corr_df</span><span class="p">,</span> <span class="n">varprops</span>
<a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a>
<a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a>    <span class="k">def</span> <span class="nf">_calc_tot_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">clusters</span><span class="p">):</span>
<a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a><span class="sd">        This function calculates the total variance explained of given clusters</span>
<a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a><span class="sd">        Parameters</span>
<a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a><span class="sd">        ----------</span>
<a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a><span class="sd">        df</span>
<a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a><span class="sd">        clusters</span>
<a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a><span class="sd">            list of clusters e.g. [clus1, clus2]</span>
<a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a><span class="sd">            Each cluster is a list of feature columns which are classified into this cluster. e.g. clus1 = [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a><span class="sd">        Returns</span>
<a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a><span class="sd">        -------</span>
<a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a><span class="sd">        tot_var, tot_prop</span>
<a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a><span class="sd">            tot_var: sum of the first eigenvalues among all clusters passed in. e.g. 0.5</span>
<a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a><span class="sd">            tot_prop: weighted average of the &quot;variance for 1st PC&quot; for each cluster passed in. e.g. 0.4</span>
<a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a>
<a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a>        <span class="n">tot_len</span><span class="p">,</span> <span class="n">tot_var</span><span class="p">,</span> <span class="n">tot_prop</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">3</span>
<a id="__codelineno-1-153" name="__codelineno-1-153" href="#__codelineno-1-153"></a>        <span class="k">for</span> <span class="n">clus</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
<a id="__codelineno-1-154" name="__codelineno-1-154" href="#__codelineno-1-154"></a>            <span class="k">if</span> <span class="n">clus</span> <span class="o">==</span> <span class="p">[]:</span>
<a id="__codelineno-1-155" name="__codelineno-1-155" href="#__codelineno-1-155"></a>                <span class="k">continue</span>
<a id="__codelineno-1-156" name="__codelineno-1-156" href="#__codelineno-1-156"></a>
<a id="__codelineno-1-157" name="__codelineno-1-157" href="#__codelineno-1-157"></a>            <span class="n">c_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clus</span><span class="p">)</span>
<a id="__codelineno-1-158" name="__codelineno-1-158" href="#__codelineno-1-158"></a>            <span class="n">c_eigvals</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">clus</span><span class="p">))</span>
<a id="__codelineno-1-159" name="__codelineno-1-159" href="#__codelineno-1-159"></a>            <span class="n">tot_var</span> <span class="o">+=</span> <span class="n">c_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-160" name="__codelineno-1-160" href="#__codelineno-1-160"></a>            <span class="n">tot_prop</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot_prop</span> <span class="o">*</span> <span class="n">tot_len</span> <span class="o">+</span> <span class="n">c_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">c_len</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tot_len</span> <span class="o">+</span> <span class="n">c_len</span><span class="p">)</span>
<a id="__codelineno-1-161" name="__codelineno-1-161" href="#__codelineno-1-161"></a>            <span class="n">tot_len</span> <span class="o">+=</span> <span class="n">c_len</span>
<a id="__codelineno-1-162" name="__codelineno-1-162" href="#__codelineno-1-162"></a>        <span class="k">return</span> <span class="n">tot_var</span><span class="p">,</span> <span class="n">tot_prop</span>
<a id="__codelineno-1-163" name="__codelineno-1-163" href="#__codelineno-1-163"></a>
<a id="__codelineno-1-164" name="__codelineno-1-164" href="#__codelineno-1-164"></a>    <span class="k">def</span> <span class="nf">_reassign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="n">feat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-1-165" name="__codelineno-1-165" href="#__codelineno-1-165"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-166" name="__codelineno-1-166" href="#__codelineno-1-166"></a><span class="sd">        This function performs the re-assignment of each variable into different cluster.</span>
<a id="__codelineno-1-167" name="__codelineno-1-167" href="#__codelineno-1-167"></a><span class="sd">        If the re-assignment could increase the variance explained, the components of the clusters involved are</span>
<a id="__codelineno-1-168" name="__codelineno-1-168" href="#__codelineno-1-168"></a><span class="sd">        recomputed before next variable is tested.</span>
<a id="__codelineno-1-169" name="__codelineno-1-169" href="#__codelineno-1-169"></a><span class="sd">        Parameters</span>
<a id="__codelineno-1-170" name="__codelineno-1-170" href="#__codelineno-1-170"></a><span class="sd">        ----------</span>
<a id="__codelineno-1-171" name="__codelineno-1-171" href="#__codelineno-1-171"></a><span class="sd">        df</span>
<a id="__codelineno-1-172" name="__codelineno-1-172" href="#__codelineno-1-172"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-1-173" name="__codelineno-1-173" href="#__codelineno-1-173"></a><span class="sd">        clus1</span>
<a id="__codelineno-1-174" name="__codelineno-1-174" href="#__codelineno-1-174"></a><span class="sd">            List of feature columns in first cluster e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-1-175" name="__codelineno-1-175" href="#__codelineno-1-175"></a><span class="sd">        clus2</span>
<a id="__codelineno-1-176" name="__codelineno-1-176" href="#__codelineno-1-176"></a><span class="sd">            List of feature columns in second cluster e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-1-177" name="__codelineno-1-177" href="#__codelineno-1-177"></a><span class="sd">        feat_list</span>
<a id="__codelineno-1-178" name="__codelineno-1-178" href="#__codelineno-1-178"></a><span class="sd">            List of features to re-assign e.g. [&quot;feat1&quot;, &quot;feat2&quot;]</span>
<a id="__codelineno-1-179" name="__codelineno-1-179" href="#__codelineno-1-179"></a><span class="sd">            If feat_list is None, all features inside clus1 and clus2 will be re-assigned</span>
<a id="__codelineno-1-180" name="__codelineno-1-180" href="#__codelineno-1-180"></a><span class="sd">            If feat_list is specified, it should only contain columns in clus1 and/or clus2, and only the specified columns</span>
<a id="__codelineno-1-181" name="__codelineno-1-181" href="#__codelineno-1-181"></a><span class="sd">            will be re-assigned. (Default value = None)</span>
<a id="__codelineno-1-182" name="__codelineno-1-182" href="#__codelineno-1-182"></a>
<a id="__codelineno-1-183" name="__codelineno-1-183" href="#__codelineno-1-183"></a><span class="sd">        Returns</span>
<a id="__codelineno-1-184" name="__codelineno-1-184" href="#__codelineno-1-184"></a><span class="sd">        -------</span>
<a id="__codelineno-1-185" name="__codelineno-1-185" href="#__codelineno-1-185"></a><span class="sd">        fin_clus1, fin_clus2, max_var</span>
<a id="__codelineno-1-186" name="__codelineno-1-186" href="#__codelineno-1-186"></a><span class="sd">            fin_clus1: final cluster 1&#39;s list of feature columns e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-1-187" name="__codelineno-1-187" href="#__codelineno-1-187"></a><span class="sd">            fin_clus2: final cluster 2&#39;s list of feature columns e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-1-188" name="__codelineno-1-188" href="#__codelineno-1-188"></a><span class="sd">            max_var: the maximum variance achieved e.g. 0.9</span>
<a id="__codelineno-1-189" name="__codelineno-1-189" href="#__codelineno-1-189"></a>
<a id="__codelineno-1-190" name="__codelineno-1-190" href="#__codelineno-1-190"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-191" name="__codelineno-1-191" href="#__codelineno-1-191"></a>
<a id="__codelineno-1-192" name="__codelineno-1-192" href="#__codelineno-1-192"></a>        <span class="k">if</span> <span class="n">feat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-193" name="__codelineno-1-193" href="#__codelineno-1-193"></a>            <span class="n">feat_list</span> <span class="o">=</span> <span class="n">clus1</span> <span class="o">+</span> <span class="n">clus2</span>
<a id="__codelineno-1-194" name="__codelineno-1-194" href="#__codelineno-1-194"></a>
<a id="__codelineno-1-195" name="__codelineno-1-195" href="#__codelineno-1-195"></a>        <span class="n">init_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_tot_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-196" name="__codelineno-1-196" href="#__codelineno-1-196"></a>        <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span> <span class="o">=</span> <span class="n">clus1</span><span class="p">[:],</span> <span class="n">clus2</span><span class="p">[:]</span>
<a id="__codelineno-1-197" name="__codelineno-1-197" href="#__codelineno-1-197"></a>        <span class="n">check_var</span><span class="p">,</span> <span class="n">max_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">init_var</span><span class="p">,)</span> <span class="o">*</span> <span class="mi">2</span>
<a id="__codelineno-1-198" name="__codelineno-1-198" href="#__codelineno-1-198"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-1-199" name="__codelineno-1-199" href="#__codelineno-1-199"></a>
<a id="__codelineno-1-200" name="__codelineno-1-200" href="#__codelineno-1-200"></a>            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feat_list</span><span class="p">:</span>
<a id="__codelineno-1-201" name="__codelineno-1-201" href="#__codelineno-1-201"></a>                <span class="n">new_clus1</span><span class="p">,</span> <span class="n">new_clus2</span> <span class="o">=</span> <span class="n">fin_clus1</span><span class="p">[:],</span> <span class="n">fin_clus2</span><span class="p">[:]</span>
<a id="__codelineno-1-202" name="__codelineno-1-202" href="#__codelineno-1-202"></a>                <span class="k">if</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">new_clus1</span><span class="p">:</span>
<a id="__codelineno-1-203" name="__codelineno-1-203" href="#__codelineno-1-203"></a>                    <span class="n">new_clus1</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-1-204" name="__codelineno-1-204" href="#__codelineno-1-204"></a>                    <span class="n">new_clus2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-1-205" name="__codelineno-1-205" href="#__codelineno-1-205"></a>                <span class="k">elif</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">new_clus2</span><span class="p">:</span>
<a id="__codelineno-1-206" name="__codelineno-1-206" href="#__codelineno-1-206"></a>                    <span class="n">new_clus1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-1-207" name="__codelineno-1-207" href="#__codelineno-1-207"></a>                    <span class="n">new_clus2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-1-208" name="__codelineno-1-208" href="#__codelineno-1-208"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-209" name="__codelineno-1-209" href="#__codelineno-1-209"></a>                    <span class="k">continue</span>
<a id="__codelineno-1-210" name="__codelineno-1-210" href="#__codelineno-1-210"></a>                <span class="n">new_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_tot_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">new_clus1</span><span class="p">,</span> <span class="n">new_clus2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-211" name="__codelineno-1-211" href="#__codelineno-1-211"></a>                <span class="k">if</span> <span class="n">new_var</span> <span class="o">&gt;</span> <span class="n">check_var</span><span class="p">:</span>
<a id="__codelineno-1-212" name="__codelineno-1-212" href="#__codelineno-1-212"></a>                    <span class="n">check_var</span> <span class="o">=</span> <span class="n">new_var</span>
<a id="__codelineno-1-213" name="__codelineno-1-213" href="#__codelineno-1-213"></a>                    <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span> <span class="o">=</span> <span class="n">new_clus1</span><span class="p">[:],</span> <span class="n">new_clus2</span><span class="p">[:]</span>
<a id="__codelineno-1-214" name="__codelineno-1-214" href="#__codelineno-1-214"></a>
<a id="__codelineno-1-215" name="__codelineno-1-215" href="#__codelineno-1-215"></a>            <span class="k">if</span> <span class="n">max_var</span> <span class="o">==</span> <span class="n">check_var</span><span class="p">:</span>
<a id="__codelineno-1-216" name="__codelineno-1-216" href="#__codelineno-1-216"></a>                <span class="k">break</span>
<a id="__codelineno-1-217" name="__codelineno-1-217" href="#__codelineno-1-217"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-218" name="__codelineno-1-218" href="#__codelineno-1-218"></a>                <span class="n">max_var</span> <span class="o">=</span> <span class="n">check_var</span>
<a id="__codelineno-1-219" name="__codelineno-1-219" href="#__codelineno-1-219"></a>        <span class="k">return</span> <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span><span class="p">,</span> <span class="n">max_var</span>
<a id="__codelineno-1-220" name="__codelineno-1-220" href="#__codelineno-1-220"></a>
<a id="__codelineno-1-221" name="__codelineno-1-221" href="#__codelineno-1-221"></a>    <span class="k">def</span> <span class="nf">_reassign_rs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="n">n_rs</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-1-222" name="__codelineno-1-222" href="#__codelineno-1-222"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-223" name="__codelineno-1-223" href="#__codelineno-1-223"></a><span class="sd">        This function should be called after _reassign, and it performs random shuffling of n_rs times to run the re-assignment</span>
<a id="__codelineno-1-224" name="__codelineno-1-224" href="#__codelineno-1-224"></a><span class="sd">        Parameters</span>
<a id="__codelineno-1-225" name="__codelineno-1-225" href="#__codelineno-1-225"></a><span class="sd">        ----------</span>
<a id="__codelineno-1-226" name="__codelineno-1-226" href="#__codelineno-1-226"></a><span class="sd">        df</span>
<a id="__codelineno-1-227" name="__codelineno-1-227" href="#__codelineno-1-227"></a><span class="sd">            Spark dataframe</span>
<a id="__codelineno-1-228" name="__codelineno-1-228" href="#__codelineno-1-228"></a><span class="sd">        clus1</span>
<a id="__codelineno-1-229" name="__codelineno-1-229" href="#__codelineno-1-229"></a><span class="sd">            List of feature columns in first cluster e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-1-230" name="__codelineno-1-230" href="#__codelineno-1-230"></a><span class="sd">        clus2</span>
<a id="__codelineno-1-231" name="__codelineno-1-231" href="#__codelineno-1-231"></a><span class="sd">            List of feature columns in second cluster e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-1-232" name="__codelineno-1-232" href="#__codelineno-1-232"></a><span class="sd">        n_rs</span>
<a id="__codelineno-1-233" name="__codelineno-1-233" href="#__codelineno-1-233"></a><span class="sd">            Number of random shuffles e.g. 2</span>
<a id="__codelineno-1-234" name="__codelineno-1-234" href="#__codelineno-1-234"></a><span class="sd">            If n_rs is 0, random shuffling of the features after re-assignment will not be conducted.</span>
<a id="__codelineno-1-235" name="__codelineno-1-235" href="#__codelineno-1-235"></a><span class="sd">            If n_rs is &gt;0, random shuffling of n_rs times will be conducted to perform re-assignment. (Default value = 0)</span>
<a id="__codelineno-1-236" name="__codelineno-1-236" href="#__codelineno-1-236"></a>
<a id="__codelineno-1-237" name="__codelineno-1-237" href="#__codelineno-1-237"></a><span class="sd">        Returns</span>
<a id="__codelineno-1-238" name="__codelineno-1-238" href="#__codelineno-1-238"></a><span class="sd">        -------</span>
<a id="__codelineno-1-239" name="__codelineno-1-239" href="#__codelineno-1-239"></a><span class="sd">        fin_rs_clus1, fin_rs_clus2, max_rs_var</span>
<a id="__codelineno-1-240" name="__codelineno-1-240" href="#__codelineno-1-240"></a><span class="sd">            fin_rs_clus1: final cluster 1&#39;s list of feature columns after random shuffling e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-1-241" name="__codelineno-1-241" href="#__codelineno-1-241"></a><span class="sd">            fin_rs_clus2: final cluster 2&#39;s list of feature columns after random shuffling e.g. [&quot;col3&quot;, &quot;col4&quot;]</span>
<a id="__codelineno-1-242" name="__codelineno-1-242" href="#__codelineno-1-242"></a><span class="sd">            max_rs_var: the maximum variance achieved after random shuffling e.g. 0.9</span>
<a id="__codelineno-1-243" name="__codelineno-1-243" href="#__codelineno-1-243"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-244" name="__codelineno-1-244" href="#__codelineno-1-244"></a>
<a id="__codelineno-1-245" name="__codelineno-1-245" href="#__codelineno-1-245"></a>        <span class="n">feat_list</span> <span class="o">=</span> <span class="n">clus1</span> <span class="o">+</span> <span class="n">clus2</span>
<a id="__codelineno-1-246" name="__codelineno-1-246" href="#__codelineno-1-246"></a>        <span class="n">fin_rs_clus1</span><span class="p">,</span> <span class="n">fin_rs_clus2</span><span class="p">,</span> <span class="n">max_rs_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reassign</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">)</span>
<a id="__codelineno-1-247" name="__codelineno-1-247" href="#__codelineno-1-247"></a>
<a id="__codelineno-1-248" name="__codelineno-1-248" href="#__codelineno-1-248"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rs</span><span class="p">):</span>
<a id="__codelineno-1-249" name="__codelineno-1-249" href="#__codelineno-1-249"></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-1-250" name="__codelineno-1-250" href="#__codelineno-1-250"></a>            <span class="n">rs_clus1</span><span class="p">,</span> <span class="n">rs_clus2</span><span class="p">,</span> <span class="n">rs_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reassign</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-1-251" name="__codelineno-1-251" href="#__codelineno-1-251"></a>            <span class="k">if</span> <span class="n">rs_var</span> <span class="o">&gt;</span> <span class="n">max_rs_var</span><span class="p">:</span>
<a id="__codelineno-1-252" name="__codelineno-1-252" href="#__codelineno-1-252"></a>                <span class="n">max_rs_var</span> <span class="o">=</span> <span class="n">rs_var</span>
<a id="__codelineno-1-253" name="__codelineno-1-253" href="#__codelineno-1-253"></a>                <span class="n">fin_rs_clus1</span><span class="p">,</span> <span class="n">fin_rs_clus2</span> <span class="o">=</span> <span class="n">rs_clus1</span><span class="p">,</span> <span class="n">rs_clus2</span>
<a id="__codelineno-1-254" name="__codelineno-1-254" href="#__codelineno-1-254"></a>
<a id="__codelineno-1-255" name="__codelineno-1-255" href="#__codelineno-1-255"></a>        <span class="k">return</span> <span class="n">fin_rs_clus1</span><span class="p">,</span> <span class="n">fin_rs_clus2</span><span class="p">,</span> <span class="n">max_rs_var</span>
<a id="__codelineno-1-256" name="__codelineno-1-256" href="#__codelineno-1-256"></a>
<a id="__codelineno-1-257" name="__codelineno-1-257" href="#__codelineno-1-257"></a>    <span class="k">def</span> <span class="nf">_varclusspark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark</span><span class="p">):</span>
<a id="__codelineno-1-258" name="__codelineno-1-258" href="#__codelineno-1-258"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-259" name="__codelineno-1-259" href="#__codelineno-1-259"></a><span class="sd">        This function is the main function which performs variable clustering.</span>
<a id="__codelineno-1-260" name="__codelineno-1-260" href="#__codelineno-1-260"></a><span class="sd">        By default, it begins with all variables in a single cluster. It then repeats the following steps:</span>
<a id="__codelineno-1-261" name="__codelineno-1-261" href="#__codelineno-1-261"></a><span class="sd">            1. A cluster is chosen for splitting. This cluster has the largest eigenvalue associated with the 2nd PC</span>
<a id="__codelineno-1-262" name="__codelineno-1-262" href="#__codelineno-1-262"></a><span class="sd">            2. Find the first 2 PCs of the chosen cluster and split into 2 clusters, then perform an orthoblique rotation (raw quartimax rotation on the eigenvectors)</span>
<a id="__codelineno-1-263" name="__codelineno-1-263" href="#__codelineno-1-263"></a><span class="sd">            3. Variables are iteratively re-assigned to clusters to maximize the variance</span>
<a id="__codelineno-1-264" name="__codelineno-1-264" href="#__codelineno-1-264"></a><span class="sd">                (a) Nearest Component Sorting (NCS) Phase: In each iteration, the cluster components are computed. Each</span>
<a id="__codelineno-1-265" name="__codelineno-1-265" href="#__codelineno-1-265"></a><span class="sd">                variable is assigned to the rotated component with which it has the highest squared correlation</span>
<a id="__codelineno-1-266" name="__codelineno-1-266" href="#__codelineno-1-266"></a><span class="sd">                (b) Search Phase: Assign each variable into different cluster to see if this increase the variance explained.</span>
<a id="__codelineno-1-267" name="__codelineno-1-267" href="#__codelineno-1-267"></a><span class="sd">                If variable is re-assigned here, the components of the clusters involved are recomputed before next variable is tested</span>
<a id="__codelineno-1-268" name="__codelineno-1-268" href="#__codelineno-1-268"></a><span class="sd">        The procedure stops when the 2nd eigenvalue of each cluster is smaller than maxeigval2 parameter.</span>
<a id="__codelineno-1-269" name="__codelineno-1-269" href="#__codelineno-1-269"></a>
<a id="__codelineno-1-270" name="__codelineno-1-270" href="#__codelineno-1-270"></a><span class="sd">        Parameters</span>
<a id="__codelineno-1-271" name="__codelineno-1-271" href="#__codelineno-1-271"></a><span class="sd">        ----------</span>
<a id="__codelineno-1-272" name="__codelineno-1-272" href="#__codelineno-1-272"></a><span class="sd">        spark</span>
<a id="__codelineno-1-273" name="__codelineno-1-273" href="#__codelineno-1-273"></a><span class="sd">            Spark Session</span>
<a id="__codelineno-1-274" name="__codelineno-1-274" href="#__codelineno-1-274"></a><span class="sd">        Returns</span>
<a id="__codelineno-1-275" name="__codelineno-1-275" href="#__codelineno-1-275"></a><span class="sd">        -------</span>
<a id="__codelineno-1-276" name="__codelineno-1-276" href="#__codelineno-1-276"></a>
<a id="__codelineno-1-277" name="__codelineno-1-277" href="#__codelineno-1-277"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-278" name="__codelineno-1-278" href="#__codelineno-1-278"></a>        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
<a id="__codelineno-1-279" name="__codelineno-1-279" href="#__codelineno-1-279"></a>
<a id="__codelineno-1-280" name="__codelineno-1-280" href="#__codelineno-1-280"></a>        <span class="n">ClusInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
<a id="__codelineno-1-281" name="__codelineno-1-281" href="#__codelineno-1-281"></a>            <span class="s2">&quot;ClusInfo&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;clus&quot;</span><span class="p">,</span> <span class="s2">&quot;eigval1&quot;</span><span class="p">,</span> <span class="s2">&quot;eigval2&quot;</span><span class="p">,</span> <span class="s2">&quot;eigvecs&quot;</span><span class="p">,</span> <span class="s2">&quot;varprop&quot;</span><span class="p">]</span>
<a id="__codelineno-1-282" name="__codelineno-1-282" href="#__codelineno-1-282"></a>        <span class="p">)</span>
<a id="__codelineno-1-283" name="__codelineno-1-283" href="#__codelineno-1-283"></a>        <span class="n">c_eigvals</span><span class="p">,</span> <span class="n">c_eigvecs</span><span class="p">,</span> <span class="n">c_corrs</span><span class="p">,</span> <span class="n">c_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-1-284" name="__codelineno-1-284" href="#__codelineno-1-284"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-1-285" name="__codelineno-1-285" href="#__codelineno-1-285"></a>        <span class="p">)</span>
<a id="__codelineno-1-286" name="__codelineno-1-286" href="#__codelineno-1-286"></a>
<a id="__codelineno-1-287" name="__codelineno-1-287" href="#__codelineno-1-287"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">corrs</span> <span class="o">=</span> <span class="n">c_corrs</span>
<a id="__codelineno-1-288" name="__codelineno-1-288" href="#__codelineno-1-288"></a>
<a id="__codelineno-1-289" name="__codelineno-1-289" href="#__codelineno-1-289"></a>        <span class="n">clus0</span> <span class="o">=</span> <span class="n">ClusInfo</span><span class="p">(</span>
<a id="__codelineno-1-290" name="__codelineno-1-290" href="#__codelineno-1-290"></a>            <span class="n">clus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_list</span><span class="p">,</span>
<a id="__codelineno-1-291" name="__codelineno-1-291" href="#__codelineno-1-291"></a>            <span class="n">eigval1</span><span class="o">=</span><span class="n">c_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-292" name="__codelineno-1-292" href="#__codelineno-1-292"></a>            <span class="n">eigval2</span><span class="o">=</span><span class="n">c_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-1-293" name="__codelineno-1-293" href="#__codelineno-1-293"></a>            <span class="n">eigvecs</span><span class="o">=</span><span class="n">c_eigvecs</span><span class="p">,</span>
<a id="__codelineno-1-294" name="__codelineno-1-294" href="#__codelineno-1-294"></a>            <span class="n">varprop</span><span class="o">=</span><span class="n">c_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-295" name="__codelineno-1-295" href="#__codelineno-1-295"></a>        <span class="p">)</span>
<a id="__codelineno-1-296" name="__codelineno-1-296" href="#__codelineno-1-296"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clus0</span><span class="p">)])</span>
<a id="__codelineno-1-297" name="__codelineno-1-297" href="#__codelineno-1-297"></a>
<a id="__codelineno-1-298" name="__codelineno-1-298" href="#__codelineno-1-298"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-1-299" name="__codelineno-1-299" href="#__codelineno-1-299"></a>
<a id="__codelineno-1-300" name="__codelineno-1-300" href="#__codelineno-1-300"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxclus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxclus</span><span class="p">:</span>
<a id="__codelineno-1-301" name="__codelineno-1-301" href="#__codelineno-1-301"></a>                <span class="k">break</span>
<a id="__codelineno-1-302" name="__codelineno-1-302" href="#__codelineno-1-302"></a>
<a id="__codelineno-1-303" name="__codelineno-1-303" href="#__codelineno-1-303"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">eigval2</span><span class="p">)</span>
<a id="__codelineno-1-304" name="__codelineno-1-304" href="#__codelineno-1-304"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">eigval2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxeigval2</span><span class="p">:</span>
<a id="__codelineno-1-305" name="__codelineno-1-305" href="#__codelineno-1-305"></a>                <span class="n">split_clus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">clus</span>
<a id="__codelineno-1-306" name="__codelineno-1-306" href="#__codelineno-1-306"></a>                <span class="n">c_eigvals</span><span class="p">,</span> <span class="n">c_eigvecs</span><span class="p">,</span> <span class="n">split_corrs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-1-307" name="__codelineno-1-307" href="#__codelineno-1-307"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">split_clus</span><span class="p">)</span>
<a id="__codelineno-1-308" name="__codelineno-1-308" href="#__codelineno-1-308"></a>                <span class="p">)</span>
<a id="__codelineno-1-309" name="__codelineno-1-309" href="#__codelineno-1-309"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-310" name="__codelineno-1-310" href="#__codelineno-1-310"></a>                <span class="k">break</span>
<a id="__codelineno-1-311" name="__codelineno-1-311" href="#__codelineno-1-311"></a>
<a id="__codelineno-1-312" name="__codelineno-1-312" href="#__codelineno-1-312"></a>            <span class="k">if</span> <span class="n">c_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxeigval2</span><span class="p">:</span>
<a id="__codelineno-1-313" name="__codelineno-1-313" href="#__codelineno-1-313"></a>                <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-1-314" name="__codelineno-1-314" href="#__codelineno-1-314"></a>                <span class="n">rotator</span> <span class="o">=</span> <span class="n">Rotator</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;quartimax&quot;</span><span class="p">)</span>
<a id="__codelineno-1-315" name="__codelineno-1-315" href="#__codelineno-1-315"></a>                <span class="n">r_eigvecs</span> <span class="o">=</span> <span class="n">rotator</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">c_eigvecs</span><span class="p">))</span>
<a id="__codelineno-1-316" name="__codelineno-1-316" href="#__codelineno-1-316"></a>
<a id="__codelineno-1-317" name="__codelineno-1-317" href="#__codelineno-1-317"></a>                <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span> <span class="o">=</span> <span class="n">r_eigvecs</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-1-318" name="__codelineno-1-318" href="#__codelineno-1-318"></a>                <span class="n">r_eigvecs_dm</span> <span class="o">=</span> <span class="n">DenseMatrix</span><span class="p">(</span>
<a id="__codelineno-1-319" name="__codelineno-1-319" href="#__codelineno-1-319"></a>                    <span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">r_eigvecs</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span>
<a id="__codelineno-1-320" name="__codelineno-1-320" href="#__codelineno-1-320"></a>                <span class="p">)</span>
<a id="__codelineno-1-321" name="__codelineno-1-321" href="#__codelineno-1-321"></a>                <span class="n">r_eigvecs_rm</span> <span class="o">=</span> <span class="n">RowMatrix</span><span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">r_eigvecs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<a id="__codelineno-1-322" name="__codelineno-1-322" href="#__codelineno-1-322"></a>                <span class="n">dm</span> <span class="o">=</span> <span class="n">DenseMatrix</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_rows</span><span class="p">,</span> <span class="n">split_corrs</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<a id="__codelineno-1-323" name="__codelineno-1-323" href="#__codelineno-1-323"></a>
<a id="__codelineno-1-324" name="__codelineno-1-324" href="#__codelineno-1-324"></a>                <span class="n">comb_sigmas</span> <span class="o">=</span> <span class="n">r_eigvecs_rm</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dm</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">r_eigvecs_dm</span><span class="p">)</span>
<a id="__codelineno-1-325" name="__codelineno-1-325" href="#__codelineno-1-325"></a>                <span class="n">comb_sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-1-326" name="__codelineno-1-326" href="#__codelineno-1-326"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">comb_sigmas</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
<a id="__codelineno-1-327" name="__codelineno-1-327" href="#__codelineno-1-327"></a>                <span class="p">)</span>
<a id="__codelineno-1-328" name="__codelineno-1-328" href="#__codelineno-1-328"></a>
<a id="__codelineno-1-329" name="__codelineno-1-329" href="#__codelineno-1-329"></a>                <span class="n">comb_sigma1</span> <span class="o">=</span> <span class="n">comb_sigmas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-330" name="__codelineno-1-330" href="#__codelineno-1-330"></a>                <span class="n">comb_sigma2</span> <span class="o">=</span> <span class="n">comb_sigmas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-331" name="__codelineno-1-331" href="#__codelineno-1-331"></a>
<a id="__codelineno-1-332" name="__codelineno-1-332" href="#__codelineno-1-332"></a>                <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">split_clus</span><span class="p">:</span>
<a id="__codelineno-1-333" name="__codelineno-1-333" href="#__codelineno-1-333"></a>                    <span class="n">comb_cov1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">split_corrs</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<a id="__codelineno-1-334" name="__codelineno-1-334" href="#__codelineno-1-334"></a>                    <span class="n">comb_cov2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r_eigvecs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">split_corrs</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<a id="__codelineno-1-335" name="__codelineno-1-335" href="#__codelineno-1-335"></a>
<a id="__codelineno-1-336" name="__codelineno-1-336" href="#__codelineno-1-336"></a>                    <span class="n">corr_pc1</span> <span class="o">=</span> <span class="n">comb_cov1</span> <span class="o">/</span> <span class="n">comb_sigma1</span>
<a id="__codelineno-1-337" name="__codelineno-1-337" href="#__codelineno-1-337"></a>                    <span class="n">corr_pc2</span> <span class="o">=</span> <span class="n">comb_cov2</span> <span class="o">/</span> <span class="n">comb_sigma2</span>
<a id="__codelineno-1-338" name="__codelineno-1-338" href="#__codelineno-1-338"></a>
<a id="__codelineno-1-339" name="__codelineno-1-339" href="#__codelineno-1-339"></a>                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_pc1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr_pc2</span><span class="p">):</span>
<a id="__codelineno-1-340" name="__codelineno-1-340" href="#__codelineno-1-340"></a>                        <span class="n">clus1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-1-341" name="__codelineno-1-341" href="#__codelineno-1-341"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-342" name="__codelineno-1-342" href="#__codelineno-1-342"></a>                        <span class="n">clus2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<a id="__codelineno-1-343" name="__codelineno-1-343" href="#__codelineno-1-343"></a>
<a id="__codelineno-1-344" name="__codelineno-1-344" href="#__codelineno-1-344"></a>                <span class="n">fin_clus1</span><span class="p">,</span> <span class="n">fin_clus2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reassign_rs</span><span class="p">(</span>
<a id="__codelineno-1-345" name="__codelineno-1-345" href="#__codelineno-1-345"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">clus1</span><span class="p">,</span> <span class="n">clus2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_rs</span>
<a id="__codelineno-1-346" name="__codelineno-1-346" href="#__codelineno-1-346"></a>                <span class="p">)</span>
<a id="__codelineno-1-347" name="__codelineno-1-347" href="#__codelineno-1-347"></a>
<a id="__codelineno-1-348" name="__codelineno-1-348" href="#__codelineno-1-348"></a>                <span class="n">c1_eigvals</span><span class="p">,</span> <span class="n">c1_eigvecs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c1_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-1-349" name="__codelineno-1-349" href="#__codelineno-1-349"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fin_clus1</span><span class="p">)</span>
<a id="__codelineno-1-350" name="__codelineno-1-350" href="#__codelineno-1-350"></a>                <span class="p">)</span>
<a id="__codelineno-1-351" name="__codelineno-1-351" href="#__codelineno-1-351"></a>                <span class="n">c2_eigvals</span><span class="p">,</span> <span class="n">c2_eigvecs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c2_varprops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correig</span><span class="p">(</span>
<a id="__codelineno-1-352" name="__codelineno-1-352" href="#__codelineno-1-352"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fin_clus2</span><span class="p">)</span>
<a id="__codelineno-1-353" name="__codelineno-1-353" href="#__codelineno-1-353"></a>                <span class="p">)</span>
<a id="__codelineno-1-354" name="__codelineno-1-354" href="#__codelineno-1-354"></a>
<a id="__codelineno-1-355" name="__codelineno-1-355" href="#__codelineno-1-355"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClusInfo</span><span class="p">(</span>
<a id="__codelineno-1-356" name="__codelineno-1-356" href="#__codelineno-1-356"></a>                    <span class="n">clus</span><span class="o">=</span><span class="n">fin_clus1</span><span class="p">,</span>
<a id="__codelineno-1-357" name="__codelineno-1-357" href="#__codelineno-1-357"></a>                    <span class="n">eigval1</span><span class="o">=</span><span class="n">c1_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-358" name="__codelineno-1-358" href="#__codelineno-1-358"></a>                    <span class="n">eigval2</span><span class="o">=</span><span class="n">c1_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-1-359" name="__codelineno-1-359" href="#__codelineno-1-359"></a>                    <span class="n">eigvecs</span><span class="o">=</span><span class="n">c1_eigvecs</span><span class="p">,</span>
<a id="__codelineno-1-360" name="__codelineno-1-360" href="#__codelineno-1-360"></a>                    <span class="n">varprop</span><span class="o">=</span><span class="n">c1_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-361" name="__codelineno-1-361" href="#__codelineno-1-361"></a>                <span class="p">)</span>
<a id="__codelineno-1-362" name="__codelineno-1-362" href="#__codelineno-1-362"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ClusInfo</span><span class="p">(</span>
<a id="__codelineno-1-363" name="__codelineno-1-363" href="#__codelineno-1-363"></a>                    <span class="n">clus</span><span class="o">=</span><span class="n">fin_clus2</span><span class="p">,</span>
<a id="__codelineno-1-364" name="__codelineno-1-364" href="#__codelineno-1-364"></a>                    <span class="n">eigval1</span><span class="o">=</span><span class="n">c2_eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-365" name="__codelineno-1-365" href="#__codelineno-1-365"></a>                    <span class="n">eigval2</span><span class="o">=</span><span class="n">c2_eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-1-366" name="__codelineno-1-366" href="#__codelineno-1-366"></a>                    <span class="n">eigvecs</span><span class="o">=</span><span class="n">c2_eigvecs</span><span class="p">,</span>
<a id="__codelineno-1-367" name="__codelineno-1-367" href="#__codelineno-1-367"></a>                    <span class="n">varprop</span><span class="o">=</span><span class="n">c2_varprops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-368" name="__codelineno-1-368" href="#__codelineno-1-368"></a>                <span class="p">)</span>
<a id="__codelineno-1-369" name="__codelineno-1-369" href="#__codelineno-1-369"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-370" name="__codelineno-1-370" href="#__codelineno-1-370"></a>                <span class="k">break</span>
<a id="__codelineno-1-371" name="__codelineno-1-371" href="#__codelineno-1-371"></a>
<a id="__codelineno-1-372" name="__codelineno-1-372" href="#__codelineno-1-372"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-1-373" name="__codelineno-1-373" href="#__codelineno-1-373"></a>
<a id="__codelineno-1-374" name="__codelineno-1-374" href="#__codelineno-1-374"></a>    <span class="k">def</span> <span class="nf">_rsquarespark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-1-375" name="__codelineno-1-375" href="#__codelineno-1-375"></a>        <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-376" name="__codelineno-1-376" href="#__codelineno-1-376"></a><span class="sd">        After variable clustering is done, this function calculates the square correlation of each feature with</span>
<a id="__codelineno-1-377" name="__codelineno-1-377" href="#__codelineno-1-377"></a><span class="sd">        (1) its own cluster (2) the &quot;nearest cluster&quot; (3) RS-ratio using own cluster and &quot;nearest clutser&quot;</span>
<a id="__codelineno-1-378" name="__codelineno-1-378" href="#__codelineno-1-378"></a><span class="sd">        RS_Own: Squared correlation between variable and its own cluster</span>
<a id="__codelineno-1-379" name="__codelineno-1-379" href="#__codelineno-1-379"></a><span class="sd">        RS_NC: The largest squared correlation among correlations between variable and all other clusters</span>
<a id="__codelineno-1-380" name="__codelineno-1-380" href="#__codelineno-1-380"></a><span class="sd">        RS_Ratio: (1-RS_Own)/(1-RS_NC)</span>
<a id="__codelineno-1-381" name="__codelineno-1-381" href="#__codelineno-1-381"></a><span class="sd">        Returns</span>
<a id="__codelineno-1-382" name="__codelineno-1-382" href="#__codelineno-1-382"></a><span class="sd">        -------</span>
<a id="__codelineno-1-383" name="__codelineno-1-383" href="#__codelineno-1-383"></a><span class="sd">        rs_table</span>
<a id="__codelineno-1-384" name="__codelineno-1-384" href="#__codelineno-1-384"></a><span class="sd">            Pandas dataframe [Cluster, Variable, RS_Own, RS_NC, RS_Ratio]</span>
<a id="__codelineno-1-385" name="__codelineno-1-385" href="#__codelineno-1-385"></a><span class="sd">            Cluster: integer-type column starting from 0 to maximum number of clusters</span>
<a id="__codelineno-1-386" name="__codelineno-1-386" href="#__codelineno-1-386"></a><span class="sd">            Variable: string-type column. Each row represents a feature name</span>
<a id="__codelineno-1-387" name="__codelineno-1-387" href="#__codelineno-1-387"></a><span class="sd">            RS_Own: float-type column indicating the squared correlation between Variable and its Cluster</span>
<a id="__codelineno-1-388" name="__codelineno-1-388" href="#__codelineno-1-388"></a><span class="sd">            RS_NC: float-type column indicating the squared correlation between Variable and its &quot;nearest cluster&quot;</span>
<a id="__codelineno-1-389" name="__codelineno-1-389" href="#__codelineno-1-389"></a><span class="sd">            RS_Ratio: float-type column (1-RS_Own)/(1-RS_NC)</span>
<a id="__codelineno-1-390" name="__codelineno-1-390" href="#__codelineno-1-390"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-391" name="__codelineno-1-391" href="#__codelineno-1-391"></a>
<a id="__codelineno-1-392" name="__codelineno-1-392" href="#__codelineno-1-392"></a>        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="s2">&quot;RS_Own&quot;</span><span class="p">,</span> <span class="s2">&quot;RS_NC&quot;</span><span class="p">,</span> <span class="s2">&quot;RS_Ratio&quot;</span><span class="p">]</span>
<a id="__codelineno-1-393" name="__codelineno-1-393" href="#__codelineno-1-393"></a>        <span class="n">rs_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
<a id="__codelineno-1-394" name="__codelineno-1-394" href="#__codelineno-1-394"></a>
<a id="__codelineno-1-395" name="__codelineno-1-395" href="#__codelineno-1-395"></a>        <span class="n">sigmas</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-396" name="__codelineno-1-396" href="#__codelineno-1-396"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusinfo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-1-397" name="__codelineno-1-397" href="#__codelineno-1-397"></a>            <span class="n">c_eigvec</span> <span class="o">=</span> <span class="n">clusinfo</span><span class="o">.</span><span class="n">eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-398" name="__codelineno-1-398" href="#__codelineno-1-398"></a>            <span class="n">c_sigma</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-1-399" name="__codelineno-1-399" href="#__codelineno-1-399"></a>                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-1-400" name="__codelineno-1-400" href="#__codelineno-1-400"></a>                    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-1-401" name="__codelineno-1-401" href="#__codelineno-1-401"></a>                        <span class="n">c_eigvec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clusinfo</span><span class="o">.</span><span class="n">clus</span><span class="p">,</span> <span class="n">clusinfo</span><span class="o">.</span><span class="n">clus</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-1-402" name="__codelineno-1-402" href="#__codelineno-1-402"></a>                    <span class="p">),</span>
<a id="__codelineno-1-403" name="__codelineno-1-403" href="#__codelineno-1-403"></a>                    <span class="n">c_eigvec</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
<a id="__codelineno-1-404" name="__codelineno-1-404" href="#__codelineno-1-404"></a>                <span class="p">)</span>
<a id="__codelineno-1-405" name="__codelineno-1-405" href="#__codelineno-1-405"></a>            <span class="p">)</span>
<a id="__codelineno-1-406" name="__codelineno-1-406" href="#__codelineno-1-406"></a>            <span class="n">sigmas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_sigma</span><span class="p">)</span>
<a id="__codelineno-1-407" name="__codelineno-1-407" href="#__codelineno-1-407"></a>
<a id="__codelineno-1-408" name="__codelineno-1-408" href="#__codelineno-1-408"></a>        <span class="n">n_row</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-1-409" name="__codelineno-1-409" href="#__codelineno-1-409"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">clus_own</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-1-410" name="__codelineno-1-410" href="#__codelineno-1-410"></a>            <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">:</span>
<a id="__codelineno-1-411" name="__codelineno-1-411" href="#__codelineno-1-411"></a>                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">feat</span><span class="p">]</span>
<a id="__codelineno-1-412" name="__codelineno-1-412" href="#__codelineno-1-412"></a>                <span class="n">cov_own</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-1-413" name="__codelineno-1-413" href="#__codelineno-1-413"></a>                    <span class="n">clus_own</span><span class="o">.</span><span class="n">eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-414" name="__codelineno-1-414" href="#__codelineno-1-414"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feat</span><span class="p">,</span> <span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
<a id="__codelineno-1-415" name="__codelineno-1-415" href="#__codelineno-1-415"></a>                <span class="p">)</span>
<a id="__codelineno-1-416" name="__codelineno-1-416" href="#__codelineno-1-416"></a>
<a id="__codelineno-1-417" name="__codelineno-1-417" href="#__codelineno-1-417"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">feat</span> <span class="o">==</span> <span class="n">clus_own</span><span class="o">.</span><span class="n">clus</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-1-418" name="__codelineno-1-418" href="#__codelineno-1-418"></a>                    <span class="n">rs_own</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-1-419" name="__codelineno-1-419" href="#__codelineno-1-419"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-420" name="__codelineno-1-420" href="#__codelineno-1-420"></a>                    <span class="n">rs_own</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_own</span> <span class="o">/</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-1-421" name="__codelineno-1-421" href="#__codelineno-1-421"></a>
<a id="__codelineno-1-422" name="__codelineno-1-422" href="#__codelineno-1-422"></a>                <span class="n">rs_others</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-423" name="__codelineno-1-423" href="#__codelineno-1-423"></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">clus_other</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-1-424" name="__codelineno-1-424" href="#__codelineno-1-424"></a>                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
<a id="__codelineno-1-425" name="__codelineno-1-425" href="#__codelineno-1-425"></a>                        <span class="k">continue</span>
<a id="__codelineno-1-426" name="__codelineno-1-426" href="#__codelineno-1-426"></a>
<a id="__codelineno-1-427" name="__codelineno-1-427" href="#__codelineno-1-427"></a>                    <span class="n">cov_other</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
<a id="__codelineno-1-428" name="__codelineno-1-428" href="#__codelineno-1-428"></a>                        <span class="n">clus_other</span><span class="o">.</span><span class="n">eigvecs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-1-429" name="__codelineno-1-429" href="#__codelineno-1-429"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feat</span><span class="p">,</span> <span class="n">clus_other</span><span class="o">.</span><span class="n">clus</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
<a id="__codelineno-1-430" name="__codelineno-1-430" href="#__codelineno-1-430"></a>                    <span class="p">)</span>
<a id="__codelineno-1-431" name="__codelineno-1-431" href="#__codelineno-1-431"></a>                    <span class="n">rs</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_other</span> <span class="o">/</span> <span class="n">sigmas</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
<a id="__codelineno-1-432" name="__codelineno-1-432" href="#__codelineno-1-432"></a>
<a id="__codelineno-1-433" name="__codelineno-1-433" href="#__codelineno-1-433"></a>                    <span class="n">rs_others</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
<a id="__codelineno-1-434" name="__codelineno-1-434" href="#__codelineno-1-434"></a>
<a id="__codelineno-1-435" name="__codelineno-1-435" href="#__codelineno-1-435"></a>                <span class="n">rs_nc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rs_others</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs_others</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-1-436" name="__codelineno-1-436" href="#__codelineno-1-436"></a>                <span class="n">row</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rs_own</span><span class="p">,</span> <span class="n">rs_nc</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rs_own</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rs_nc</span><span class="p">)]</span>
<a id="__codelineno-1-437" name="__codelineno-1-437" href="#__codelineno-1-437"></a>                <span class="n">rs_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
<a id="__codelineno-1-438" name="__codelineno-1-438" href="#__codelineno-1-438"></a>                <span class="n">n_row</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-1-439" name="__codelineno-1-439" href="#__codelineno-1-439"></a>
<a id="__codelineno-1-440" name="__codelineno-1-440" href="#__codelineno-1-440"></a>        <span class="k">return</span> <span class="n">rs_table</span>
</code></pre></div>
</pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="anovos.data_analyzer.association_eval_varclus.VarClusHiSpark.correig"><code class="name flex hljs csharp">
<span class="k">def</span> <span class="nf"><span class="ident">correig</span></span>(<span class="n">self, df, feat_list=None, n_pcs=2)</span>
</code></dt>
<dd>
<div class="desc"><p>This function find the correlation matrix between feat_list, calculates the top n_pcs eigenvalues, eigenvectors,
and gets the variance-proportion.
Parameters</p>
<hr>
<dl>
<dt><strong><code>df</code></strong></dt>
<dd>Spark dataframe</dd>
<dt><strong><code>feat_list</code></strong></dt>
<dd>list of features columns e.g. ["col1", "col2"]
If feat_list is None, all columns of the input dataframe will be used.
If feat_list is specified, only columns inside feat_list will be used.
To run the algorithm successfully, df[feat_list] should only contain numerical values. (Default value = None)</dd>
<dt><strong><code>n_pcs</code></strong></dt>
<dd>number of PCs e.g. 2
This parameter controls the size of Principal Components. e.g. If n_pcs=2, only the first 2 eigenvalues,
eigenvectors of the correlation matrix will be extracted. (Default value = 2)</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt>(top n_pcs) eigenvalues, associated eigenvectors, correlation matrix in Pandas dataframe and variance proportions</dt>
<dt><code>eigvals</code></dt>
<dd>Top n_pcs eigenvalues in a Numpy array e.g. [eigval1, eigval2]</dd>
<dt><code>eigvecs</code></dt>
<dd>The associated eigenvectors of the top n_pcs eigenvalues in a Numpy array e.g. [eigvec1, eigvec2]
Each eigenvector is an array of size D, where D represents the number of columns of df[feat_list]</dd>
<dt><code>corr_df</code></dt>
<dd>Correlation matrix of stored in Pandas dataframe
The size of this output is DxD where D represents the number of columns of df[feat_list].
The value at index i and column j indicates the pearson's correlation score between feat_list[i] and feat_list[j]</dd>
<dt><code>varprops</code></dt>
<dd>The variance proportion of the top n_pcs eigenvalues in a Numpy array e.g. [varprop1, varprop2]
The order of this array is the same with eigvals, eigvecs, with the first value varprop1 indicating the
variance proportion of the largest eigenvalue.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span> <span class="nf">correig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">feat_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="sd">    This function find the correlation matrix between feat_list, calculates the top n_pcs eigenvalues, eigenvectors,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="sd">    and gets the variance-proportion.</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="sd">    Parameters</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="sd">    ----------</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="sd">    df</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="sd">        Spark dataframe</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="sd">    feat_list</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="sd">        list of features columns e.g. [&quot;col1&quot;, &quot;col2&quot;]</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="sd">        If feat_list is None, all columns of the input dataframe will be used.</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="sd">        If feat_list is specified, only columns inside feat_list will be used.</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="sd">        To run the algorithm successfully, df[feat_list] should only contain numerical values. (Default value = None)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="sd">    n_pcs</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="sd">        number of PCs e.g. 2</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="sd">        This parameter controls the size of Principal Components. e.g. If n_pcs=2, only the first 2 eigenvalues,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="sd">        eigenvectors of the correlation matrix will be extracted. (Default value = 2)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="sd">    Returns</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="sd">    -------</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="sd">    (top n_pcs) eigenvalues, associated eigenvectors, correlation matrix in Pandas dataframe and variance proportions</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="sd">    eigvals</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="sd">        Top n_pcs eigenvalues in a Numpy array e.g. [eigval1, eigval2]</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="sd">    eigvecs</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="sd">        The associated eigenvectors of the top n_pcs eigenvalues in a Numpy array e.g. [eigvec1, eigvec2]</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="sd">        Each eigenvector is an array of size D, where D represents the number of columns of df[feat_list]</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="sd">    corr_df</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="sd">        Correlation matrix of stored in Pandas dataframe</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="sd">        The size of this output is DxD where D represents the number of columns of df[feat_list].</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="sd">        The value at index i and column j indicates the pearson&#39;s correlation score between feat_list[i] and feat_list[j]</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="sd">    varprops</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="sd">        The variance proportion of the top n_pcs eigenvalues in a Numpy array e.g. [varprop1, varprop2]</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="sd">        The order of this array is the same with eigvals, eigvecs, with the first value varprop1 indicating the</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="sd">        variance proportion of the largest eigenvalue.</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>    <span class="k">if</span> <span class="n">feat_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="n">feat_list</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>        <span class="n">corr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>        <span class="n">eigvals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_pcs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>        <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">len</span><span class="p">(</span><span class="n">feat_list</span><span class="p">)]])</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>        <span class="n">varprops</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)]</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">feat_list</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>        <span class="n">raw_eigvals</span><span class="p">,</span> <span class="n">raw_eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">raw_eigvals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>        <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">raw_eigvals</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">raw_eigvecs</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[:</span><span class="n">n_pcs</span><span class="p">],</span> <span class="n">eigvecs</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_pcs</span><span class="p">]</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>        <span class="n">varprops</span> <span class="o">=</span> <span class="n">eigvals</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">raw_eigvals</span><span class="p">)</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>    <span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feat_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feat_list</span><span class="p">)</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>    <span class="k">return</span> <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span><span class="p">,</span> <span class="n">corr_df</span><span class="p">,</span> <span class="n">varprops</span>
</code></pre></div>
</pre>
</details>
</dd>
</dl>
</dd>
</dl>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="_index.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Overview
            </div>
          </div>
        </a>
      
      
        
        <a href="association_evaluator.html" class="md-footer__link md-footer__link--next" aria-label="Next: &lt;code&gt;association_evaluator&lt;/code&gt;" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              <code>association_evaluator</code>
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/anovos" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://join.slack.com/t/featureengineers/shared_invite/zt-17pkc3f5d-33SUtV8Wx48CpiIRNuQ7JA" target="_blank" rel="noopener" title="join.slack.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/anovos" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
  </body>
</html>